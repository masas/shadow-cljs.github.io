<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Thomas Heller and Tony Kay">
<title>Shadow CLJS User&#8217;s Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Shadow CLJS User&#8217;s Guide</h1>
<div class="details">
<span id="author" class="author">Thomas Heller and Tony Kay</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">Jan 10, 2018</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_high_level_overview">1.1. High-Level Overview</a></li>
<li><a href="#_basic_workflow">1.2. Basic Workflow</a>
<ul class="sectlevel3">
<li><a href="#_development_mode">1.2.1. Development Mode</a></li>
<li><a href="#_release_mode">1.2.2. Release Mode</a></li>
</ul>
</li>
<li><a href="#_important_concepts">1.3. Important Concepts</a>
<ul class="sectlevel3">
<li><a href="#_the_classpath">1.3.1. The Classpath</a></li>
<li><a href="#_server_mode">1.3.2. Server Mode</a></li>
<li><a href="#_repl">1.3.3. REPL</a></li>
</ul>
</li>
<li><a href="#_about_this_book">1.4. About this Book</a>
<ul class="sectlevel3">
<li><a href="#_work_in_progress">1.4.1. Work in Progress</a></li>
<li><a href="#_contributing">1.4.2. Contributing</a></li>
<li><a href="#_conventions_used">1.4.3. Conventions Used</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_installation">2. Installation</a>
<ul class="sectlevel2">
<li><a href="#_standalone_via_code_npm_code">2.1. <code>npm</code> 経由のスタンドアローン</a></li>
<li><a href="#_library">2.2. Library</a></li>
</ul>
</li>
<li><a href="#_usage">3. Usage</a>
<ul class="sectlevel2">
<li><a href="#_command_line">3.1. Command Line</a>
<ul class="sectlevel3">
<li><a href="#server-mode">3.1.1. Server Mode</a></li>
</ul>
</li>
<li><a href="#_build_tool_integration">3.2. Build Tool Integration</a>
<ul class="sectlevel3">
<li><a href="#Leiningen">3.2.1. Leiningen</a></li>
<li><a href="#deps-edn">3.2.2. tools.deps / deps.edn</a></li>
<li><a href="#_boot">3.2.3. Boot</a></li>
</ul>
</li>
<li><a href="#clj-run">3.3. Running Clojure Code</a>
<ul class="sectlevel3">
<li><a href="#_calling_watch_via_clj_run">3.3.1. Calling watch via clj-run</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_repl_2">4. REPL</a>
<ul class="sectlevel2">
<li><a href="#_clojurescript_repl">4.1. ClojureScript REPL</a>
<ul class="sectlevel3">
<li><a href="#node-repl">4.1.1. Node REPL</a></li>
<li><a href="#browser-repl">4.1.2. Browser REPL</a></li>
<li><a href="#build-repl">4.1.3. Build-specific REPL</a></li>
</ul>
</li>
<li><a href="#_clojure_repl">4.2. Clojure REPL</a>
<ul class="sectlevel3">
<li><a href="#embedded">4.2.1. Embedded</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#config">5. Configuration</a>
<ul class="sectlevel2">
<li><a href="#source-paths">5.1. Source Paths</a></li>
<li><a href="#_dependencies">5.2. 依存関係</a>
<ul class="sectlevel3">
<li><a href="#_clojure_script">5.2.1. Clojure(Script)</a></li>
<li><a href="#npm-install">5.2.2. JavaScript</a></li>
</ul>
</li>
<li><a href="#user-config">5.3. User Configuration</a></li>
<li><a href="#_server_options">5.4. Server Options</a>
<ul class="sectlevel3">
<li><a href="#nREPL">5.4.1. nREPL</a></li>
<li><a href="#socket-repl">5.4.2. Socket REPL</a></li>
<li><a href="#_ssl">5.4.3. SSL</a></li>
<li><a href="#http">5.4.4. Primary HTTP(S)</a></li>
<li><a href="#dev-http">5.4.5. Development HTTP(S)</a></li>
</ul>
</li>
<li><a href="#jvm-opts">5.5. JVM Configuration</a></li>
</ul>
</li>
<li><a href="#_build_configuration">6. Build Configuration</a>
<ul class="sectlevel2">
<li><a href="#_build_target">6.1. Build Target</a></li>
<li><a href="#devtools">6.2. Development Options</a>
<ul class="sectlevel3">
<li><a href="#_repl_3">6.2.1. REPL</a></li>
<li><a href="#_preloads">6.2.2. Preloads</a></li>
<li><a href="#_hot_code_reload">6.2.3. Hot Code Reload</a></li>
<li><a href="#_lifecycle_hooks">6.2.4. Lifecycle Hooks</a></li>
</ul>
</li>
<li><a href="#build-hooks">6.3. Build Hooks</a>
<ul class="sectlevel3">
<li><a href="#compile-stages">6.3.1. Compilation Stages</a></li>
</ul>
</li>
<li><a href="#_compiler_cache">6.4. Compiler Cache</a></li>
<li><a href="#closure-defines">6.5. Closure Defines</a></li>
<li><a href="#compiler-options">6.6. Compiler Options</a>
<ul class="sectlevel3">
<li><a href="#warnigs-as-errors">6.6.1. Warnings as Errors</a></li>
</ul>
</li>
<li><a href="#_output_language_options">6.7. Output Language Options</a></li>
<li><a href="#_conditional_reading">6.8. Conditional Reading</a></li>
<li><a href="#config-merge">6.9. Overriding from the CLI</a></li>
<li><a href="#shadow-env">6.10. Using Environment Variables</a></li>
<li><a href="#build-target-defaults">6.11. Build and Target defaults</a></li>
</ul>
</li>
<li><a href="#target-browser">7. Targeting the Browser</a>
<ul class="sectlevel2">
<li><a href="#_output_settings">7.1. Output Settings</a></li>
<li><a href="#_modules">7.2. Modules</a></li>
<li><a href="#CodeSplitting">7.3. Code Splitting</a>
<ul class="sectlevel3">
<li><a href="#_loading_code_dynamically">7.3.1. Loading code dynamically</a></li>
</ul>
</li>
<li><a href="#output-wrapper">7.4. Output Wrapper</a></li>
<li><a href="#_web_workers">7.5. Web Workers</a></li>
<li><a href="#_cacheable_output">7.6. Cacheable Output</a>
<ul class="sectlevel3">
<li><a href="#release-version">7.6.1. Release Versions</a></li>
<li><a href="#NameHashing">7.6.2. Filenames with Fingerprint-Hash</a></li>
</ul>
</li>
<li><a href="#BrowserManifest">7.7. Output Manifest</a></li>
<li><a href="#_development_support">7.8. Development Support</a>
<ul class="sectlevel3">
<li><a href="#hud">7.8.1. Heads-Up Display (HUD)</a></li>
<li><a href="#_css_reloading">7.8.2. CSS Reloading</a></li>
<li><a href="#proxy-support">7.8.3. Proxy Support</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#target-react-native">8. Targeting React Native</a>
<ul class="sectlevel2">
<li><a href="#_react_native">8.1. React Native</a></li>
<li><a href="#_expo">8.2. Expo</a></li>
</ul>
</li>
<li><a href="#target-node">9. Targeting node.js</a>
<ul class="sectlevel2">
<li><a href="#target-node-script">9.1. node.js Scripts</a>
<ul class="sectlevel3">
<li><a href="#_build_options">9.1.1. Build Options</a></li>
<li><a href="#NodeHotCodeReload">9.1.2. Hot Code Reload</a></li>
</ul>
</li>
<li><a href="#target-node-library">9.2. node.js Libraries</a>
<ul class="sectlevel3">
<li><a href="#_single_static_default_export">9.2.1. Single static "default" export</a></li>
<li><a href="#_multiple_static_named_exports">9.2.2. 複数の静的名前付きエクスポート</a></li>
<li><a href="#_dynamic_exports">9.2.3. "Dynamic" exports</a></li>
<li><a href="#_full_example">9.2.4. Full Example</a></li>
</ul>
</li>
<li><a href="#_creating_code_npm_code_packages">9.3. Creating <code>npm</code> packages</a></li>
</ul>
</li>
<li><a href="#target-npm-module">10. Embedding in the JS Ecosystem&#8201;&#8212;&#8201;The <code>:npm-module</code> Target</a>
<ul class="sectlevel2">
<li><a href="#_working_with_optimizations">10.1. Working with Optimizations</a></li>
</ul>
</li>
<li><a href="#_testing">11. Testing</a>
<ul class="sectlevel2">
<li><a href="#target-node-test">11.1. Testing in node.js</a></li>
<li><a href="#target-browser-test">11.2. Testing in the Browser</a>
<ul class="sectlevel3">
<li><a href="#_generated_output_in_code_test_dir_code">11.2.1. Generated output in <code>:test-dir</code></a></li>
</ul>
</li>
<li><a href="#target-karma">11.3. 継続的インテグレーションのためにテストをKarmaターゲットに絞る</a>
<ul class="sectlevel3">
<li><a href="#_installing_karma">11.3.1. Installing Karma</a></li>
<li><a href="#_the_build">11.3.2. The Build</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#js-deps">12. JavaScript Integration</a>
<ul class="sectlevel2">
<li><a href="#npm">12.1. NPM</a>
<ul class="sectlevel3">
<li><a href="#_using_npm_packages">12.1.1. Using npm packages</a></li>
<li><a href="#js-provider">12.1.2. Package Provider</a></li>
<li><a href="#js-resolve">12.1.3. Resolving Packages</a></li>
<li><a href="#alt-node-modules">12.1.4. Alternate Modules Directories</a></li>
</ul>
</li>
<li><a href="#classpath-js">12.2. Dealing with .js Files</a>
<ul class="sectlevel3">
<li><a href="#_requiring_js">12.2.1. Requiring JS</a></li>
<li><a href="#_language_support">12.2.2. Language Support</a></li>
<li><a href="#_javascript_dialects">12.2.3. JavaScript Dialects</a></li>
<li><a href="#_access_cljs_from_js">12.2.4. Access CLJS from JS</a></li>
</ul>
</li>
<li><a href="#cljsjs">12.3. Migrating cljsjs.*</a>
<ul class="sectlevel3">
<li><a href="#_why_not_use_cljsjs">12.3.1. Why not use CLJSJS?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#release">13. Generating Production Code&#8201;&#8212;&#8201;All Targets</a>
<ul class="sectlevel2">
<li><a href="#_release_configuration">13.1. Release Configuration</a>
<ul class="sectlevel3">
<li><a href="#Optimization">13.1.1. Optimizations</a></li>
<li><a href="#_release_specific_vs_development_configuration">13.1.2. Release-Specific vs. Development Configuration</a></li>
</ul>
</li>
<li><a href="#externs">13.2. Externs</a>
<ul class="sectlevel3">
<li><a href="#infer-externs">13.2.1. Externs Inference</a></li>
<li><a href="#_manual_externs">13.2.2. Manual Externs</a></li>
<li><a href="#_simplified_externs">13.2.3. Simplified Externs</a></li>
</ul>
</li>
<li><a href="#_code_stripping">13.3. Code Stripping</a></li>
<li><a href="#_build_report">13.4. Build Report</a></li>
</ul>
</li>
<li><a href="#_editor_integration">14. Editor Integration</a>
<ul class="sectlevel2">
<li><a href="#_cursive">14.1. Cursive</a></li>
<li><a href="#cider">14.2. Emacs / CIDER</a>
<ul class="sectlevel3">
<li><a href="#_launch_the_clojurescript_repl">14.2.1. ClojureScript REPLを起動します。</a></li>
<li><a href="#_simplify_startup_with_dir_local">14.2.2. dir-localで起動を簡素化</a></li>
</ul>
</li>
<li><a href="#_proto_repl_atom">14.3. Proto REPL (Atom)</a></li>
<li><a href="#_chlorine_atom">14.4. Chlorine (Atom)</a></li>
<li><a href="#_calva_vs_code">14.5. Calva (VS Code)</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_2">14.5.1. 依存関係</a></li>
<li><a href="#_connecting_calva_to_the_repls">14.5.2. Connecting Calva to the REPLs</a></li>
<li><a href="#_features">14.5.3. Features</a></li>
</ul>
</li>
<li><a href="#_fireplace_vim_vim_neovim">14.6. Fireplace.vim (Vim/Neovim)</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_3">14.6.1. 依存関係</a></li>
<li><a href="#_preparing_the_app">14.6.2. Preparing the app</a></li>
<li><a href="#_connecting_fireplace_vim_to_repl_server">14.6.3. Connecting Fireplace.vim to REPL Server</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_troubleshooting">15. Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#failed-to-load">15.1. Startup Errors</a>
<ul class="sectlevel3">
<li><a href="#_deps_edn_tools_deps">15.1.1. deps.edn / tools.deps</a></li>
<li><a href="#_project_clj_leiningen">15.1.2. project.clj / Leiningen</a></li>
</ul>
</li>
<li><a href="#repl-troubleshooting">15.2. REPL</a>
<ul class="sectlevel3">
<li><a href="#cljs-repl-anatomy">15.2.1. Anatomy of the CLJS REPL</a></li>
<li><a href="#_javascript_runtimes">15.2.2. JavaScript Runtimes</a></li>
<li><a href="#missing-js-runtime">15.2.3. Missing JS runtime</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#publish">16. Publishing Libraries</a>
<ul class="sectlevel2">
<li><a href="#publish-lein">16.1. Leiningen</a>
<ul class="sectlevel3">
<li><a href="#_disable_jar_signing">16.1.1. Disable JAR Signing</a></li>
<li><a href="#_keep_your_jar_clean">16.1.2. Keep your JAR clean</a></li>
</ul>
</li>
<li><a href="#publish-deps-cljs">16.2. Declaring JS dependencies</a></li>
</ul>
</li>
<li><a href="#_what_to_do_when_things_don_t_work">17. What to do when things don’t work?</a></li>
<li><a href="#_hacking">18. Hacking</a>
<ul class="sectlevel2">
<li><a href="#_patching_libraries">18.1. Patching Libraries</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a><a class="link" href="#_introduction">1. Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> は、シンプルさと使いやすさに焦点を当てて ClojureScript プロジェクトをコンパイルするために必要なものをすべて提供します。提供されているビルドターゲットは、手動設定のほとんどを抽象化しているので、ビルドに必要な要素だけを設定する必要があります。各ターゲットはそれぞれの環境に最適なデフォルトを提供し、開発中やリリースビルドで最適化されたエクスペリエンスを得ることができます。</p>
</div>
<div class="sect2">
<h3 id="_high_level_overview"><a class="anchor" href="#_high_level_overview"></a><a class="link" href="#_high_level_overview">1.1. High-Level Overview</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> は2つの部分から構成されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://clojars.org/thheller/shadow-cljs">shadow-cljs</a> 実際の作業をすべて処理するClojureライブラリ。</p>
</li>
<li>
<p><a href="https://www.npmjs.com/package/shadow-cljs">shadow-cljs</a> <code>npm</code> パッケージは、ほとんどのビルド機能をコマンドラインから直接実行するための便利なインターフェイスを提供します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>必要であれば <code>shadow-cljs</code> Clojureライブラリを他のClojure/JVMビルドツール(例: <a href="https://leiningen.org/">leiningen</a>やhttps://clojure.org/guides/deps_and_cli[Clojure CLI]ツール)に簡単に統合することができます。</p>
</div>
<div class="paragraph">
<p>CLJS開発に合わせて最適化された開発体験を提供するため <code>npm</code> パッケージを使用することをお勧めします。</p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_workflow"><a class="anchor" href="#_basic_workflow"></a><a class="link" href="#_basic_workflow">1.2. Basic Workflow</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> を使うときは <code>shadow-cljs.edn</code> 設定ファイルに1つ以上のビルドを定義することになります。各ビルドは <code>:target</code> プロパティを持ち、ターゲット環境(ブラウザ <code>node.js</code> アプリケーション、Chrome 拡張機能など)に最適化された設定プリセットを表します。</p>
</div>
<div class="paragraph">
<p>各ビルドは、コンパイルのトリガーに使用されるコマンドに応じて、開発またはリリースの出力を生成することができます。標準的なビルドコマンドは以下の通りです。<code>compile</code>,<code>watch</code>,<code>release</code> です。</p>
</div>
<div class="sect3">
<h4 id="_development_mode"><a class="anchor" href="#_development_mode"></a><a class="link" href="#_development_mode">1.2.1. Development Mode</a></h4>
<div class="paragraph">
<p>開発ビルドを一度 <code>compile</code> するか <code>watch</code> プロセスを実行してソースファイルを監視し、自動的に再コンパイルすることができます (必要に応じてコードをライブリロードすることもできます)。</p>
</div>
<div class="paragraph">
<p>すべての開発ビルドは、高速なフィードバックサイクルと、実行中のコードと直接対話するための REPL のような他の機能を備え、開発者の経験に合わせて最適化されています。</p>
</div>
<div class="paragraph">
<p>開発ビルドは非常に大きくなり <code>:target</code> によってはコンパイルされたマシン上でしか動作しない可能性があるため、決して公開してはいけません。</p>
</div>
</div>
<div class="sect3">
<h4 id="_release_mode"><a class="anchor" href="#_release_mode"></a><a class="link" href="#_release_mode">1.2.2. Release Mode</a></h4>
<div class="paragraph">
<p>`release`ビルドを作成すると、開発に関連するすべてのコードが削除され、最終的にClosure Compilerでコードが変換されます。これはJavaScript用の最適化コンパイラで、コード全体のサイズを大幅に削減します。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_important_concepts"><a class="anchor" href="#_important_concepts"></a><a class="link" href="#_important_concepts">1.3. Important Concepts</a></h3>
<div class="paragraph">
<p>`shadow-cljs`を使うときには、いくつかの重要な概念を理解しておく必要があります。これらの概念は、すべてのものがどのように組み合わされ、ツールがあなたのコードでどのように動作するかを理解するために不可欠なものです。</p>
</div>
<div class="sect3">
<h4 id="_the_classpath"><a class="anchor" href="#_the_classpath"></a><a class="link" href="#_the_classpath">1.3.1. The Classpath</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> は、ファイルを扱う際に Java Virtual Machine (JVM) とその ”classpath" を使用します。これは、多くのクラスパスエントリで構成された仮想ファイルシステムです。各エントリは</p>
</div>
<div class="ulist">
<ul>
<li>
<p>設定の`:source-paths`エントリで管理されるローカルファイルシステムディレクトリ。</p>
</li>
<li>
<p>または、Clojure(Script)やJVMライブラリを表す <code>.jar</code> ファイル。これらは多くのファイルを含む圧縮されたアーカイブです(基本的にはただの <code>.zip</code> ファイル)。これらは <code>:dependencies</code> によって追加されます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Clojure(Script)では、すべてのものが名前空間になっており、それぞれの名前はファイルに解決されることが期待されています。名前空間が <code>(ns demo.app)</code> の場合、コンパイラはクラスパス上に <code>demo/app.cljs</code> (または <code>.cljc</code>) を見つけることを期待しています。クラスパスは見つかるまで順番に検索されます。例えば <code>:source-paths ["src/main/" "src/test/test"]</code> を設定したとすると、コンパイラは最初に <code>src/main/demo/app.cljs</code> を探し、次に <code>src/test/demo/app.cljs</code> を探すことになります。ソースパス上にファイルが見つからない場合、JVMはクラスパス上の <code>.jar</code> ファイルを探し始めます。ライブラリのルートに <code>demo/app.cljs</code> を見つけると、そのファイルが使用されます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
ファイル名がクラスパス上に複数回存在する場合、最初のものだけが使用されます。JVMとClojure(Script)上のすべてのものは、そのような衝突を避けるために名前空間が設定されています。各パッケージが一意の名前を持たなければならない <code>npm</code> と非常に似ています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>そのため、名前の選択や名前の間隔はきちんと決めておくことをお勧めします。常に <code>(ns your-company.components.foo)</code> の上に <code>(ns components.foo)</code> を使うことは、繰り返しのように思えるかもしれませんが、後になって多くの頭痛の種を避けることができます。</p>
</div>
<div class="paragraph">
<p>これは <code>npm</code> とは異なり、パッケージ名自体がパッケージ内部で使われることはなく、相対パスのみが使われます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_server_mode"><a class="anchor" href="#_server_mode"></a><a class="link" href="#_server_mode">1.3.2. Server Mode</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> は <code>watch</code> のような長時間のタスクを実行する場合に必要な、&#34;server&#34; モードで起動することができます。 <code>watch</code> はまだ起動していなければ暗黙のうちにサーバインスタンスを起動します。サーバはビルドが接続するWebsocketエンドポイントを提供し、他のすべてのエンドポイントと同様に nREPL, Socket REPL, 開発用HTTPサーバを提供します。</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> CLIインターフェースを使用する場合、すべてのコマンドは新しいJVMを起動する代わりに、実行中のサーバインスタンスJVMを再利用します。これにより、JVM起動時間が非常に遅くなる可能性を排除するので、実質的に速くなります。</p>
</div>
<div class="paragraph">
<p>いったんサーバが起動してしまえば <code>:dependencies</code> が変更されたときだけ再起動すればよく、それ以外のことはすべて REPL を使って行うことができます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_repl"><a class="anchor" href="#_repl"></a><a class="link" href="#_repl">1.3.3. REPL</a></h4>
<div class="paragraph">
<p>REPLはすべてのClojure(Script)開発の中心であり、すべてのCLIコマンドはREPLから直接使用することもできます。たとえコマンドラインがより身近に感じられるかもしれませんが、REPLに慣れることは絶対に価値があります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_about_this_book"><a class="anchor" href="#_about_this_book"></a><a class="link" href="#_about_this_book">1.4. About this Book</a></h3>
<div class="sect3">
<h4 id="_work_in_progress"><a class="anchor" href="#_work_in_progress"></a><a class="link" href="#_work_in_progress">1.4.1. Work in Progress</a></h4>
<div class="paragraph">
<p>これは作業中のものです。エラーを発見した場合は、修正のためのPR(訳注：pull request?)、または問題の詳細を記載した問題を投稿してください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_contributing"><a class="anchor" href="#_contributing"></a><a class="link" href="#_contributing">1.4.2. Contributing</a></h4>
<div class="paragraph">
<p>この本のソースは <a href="https://github.com/shadow-cljs/shadow-cljs.github.io">Github</a> でホストされています。</p>
</div>
</div>
<div class="sect3">
<h4 id="_conventions_used"><a class="anchor" href="#_conventions_used"></a><a class="link" href="#_conventions_used">1.4.3. Conventions Used</a></h4>
<div class="paragraph">
<p>本書には多くの例が掲載されています。これらの中で使われているものの多くは、文脈から明らかなはずですが、誤解を防ぐためには、著者の意図を知ることが大切です。</p>
</div>
<div class="paragraph">
<p>コマンドラインの例を示す際には、BASH のコメント (<code>#</code> で始まる) を含めることがあり、通常は、コマンドとその出力を分離することを示すために、標準的なユーザ UNIX プロンプト <code>$</code> を含めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># A comment. This command lists files:
$ ls -l
shadow-cljs.edn
project.clj
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>例の多くは、コンパイラの設定ファイルです。このファイルには EDN マップが含まれています。すでに必須オプションについて説明している場合は、わかりやすくするために省略します。この場合、"必要だが現在の焦点には入っていない内容 "を示すために、通常は省略記号("&#8230;&#8203;")を入れます。</p>
</div>
<div class="listingblock">
<div class="title">Example 1. 依存関係の指定</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [[lib <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>]]}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example 2. ソースパスの追加</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、関心のある構成の入れ子を理解するのに十分なコンテキストを簡潔に含めることができます:</p>
</div>
<div class="listingblock">
<div class="title">Example 3. 入れ子になったオプション</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:build-id</span> {<span class="keyword">..</span><span class="keyword">.</span>
                     <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コード例も同様に短縮しています。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a><a class="link" href="#_installation">2. Installation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standalone_via_code_npm_code"><a class="anchor" href="#_standalone_via_code_npm_code"></a><a class="link" href="#_standalone_via_code_npm_code">2.1. <code>npm</code> 経由のスタンドアローン</a></h3>
<div class="paragraph">
<p>下記を必要とします:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nodejs.org"><code>node.js</code></a> (v6.0.0.0+, 最新バージョンを推奨)</p>
</li>
<li>
<p><a href="https://www.npmjs.com"><code>npm</code></a> または <a href="https://www.yarnpkg.com"><code>yarn</code></a></p>
</li>
<li>
<p>Java SDK (バージョン8以上) <a href="http://openjdk.java.net/install/">OpenJDK</a>または <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle</a>のいずれか。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>プロジェクトディレクトリに`package.json`が必要です。もしまだない場合は、npm init -yを実行することで作成できます。
またプロジェクトディレクトリがない場合は</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ npx create-cljs-project my-project</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで必要な基本ファイルがすべて作成されるので、以下のコマンドをスキップすることができます。</p>
</div>
<div class="paragraph">
<p>既に <code>package.json</code> があり <code>shadow-cljs</code> を追加したい場合は、以下のように実行してください。</p>
</div>
<div class="listingblock">
<div class="title">NPM</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ npm install --save-dev shadow-cljs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Yarn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ yarn add --dev shadow-cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>便利なように <code>npm install -g shadow-cljs</code> や <code>yarn global add shadow-cljs</code> を実行することができます。これにより、後で <code>shadow-cljs</code> コマンドを直接実行できるようになります。プロジェクトには常にshadow-cljsのバージョンがインストールされているはずです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_library"><a class="anchor" href="#_library"></a><a class="link" href="#_library">2.2. Library</a></h3>
<div class="paragraph">
<p>スタンドアロン版を <code>npm</code> 経由で実行することを推奨しますが <code>shadow-cljs</code> を他の Clojure JVM ツール (例えば <code>lein</code>, <code>boot</code>, &#8230;&#8203;. など) に埋め込むこともできます。</p>
</div>
<div class="paragraph">
<p>アーティファクトは以下の場所にあります。</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://clojars.org/thheller/shadow-cljs"><img src="https://img.shields.io/clojars/v/thheller/shadow-cljs.svg" alt="shadow cljs"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://github.com/thheller/shadow-cljs"><img src="https://img.shields.io/npm/v/shadow-cljs.svg" alt="shadow cljs"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a><a class="link" href="#_usage">3. Usage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>`shadow-cljs`は様々な方法で使うことができますが、一般的なワークフローは同じです。</p>
</div>
<div class="paragraph">
<p>開発中にはビルドを一度コンパイルするか <code>watch</code> ワーカーを実行してソースファイルの変更を監視し、自動的に再コンパイルするかを選択することができます。 <a href="#devtools">enabled</a> の場合 <code>watch</code> ワーカーはコードをホットリロードして REPL を提供します。開発中は、開発者の経験と高速なフィードバックサイクルに焦点を当てています。開発コードは決して公開されるべきではありません。</p>
</div>
<div class="paragraph">
<p>いよいよ本気を出す時が来た時には、<a href="#release"><code>release</code></a>ビルドを作成し、本番に適した最適化されたビルドを作成します。このために <a href="https://developers.google.com/closure/compiler/">Closure Compiler</a> を使用します。これは、あなたのコードに <code>:advanced</code> 最適化を適用して、最適な出力を作成します。これは、ネイティブのJavaScriptで多くのinteropを使用しているときに適切に動作するために、いくつかの<a href="#externs">tuning</a>を必要とするかもしれませんが、ClojureScript(とhttps://developers.google.com/closure/library/[Closure Library]からのコード)では完璧に動作します。</p>
</div>
<div class="sect2">
<h3 id="_command_line"><a class="anchor" href="#_command_line"></a><a class="link" href="#_command_line">3.1. Command Line</a></h3>
<div class="paragraph">
<p>グローバルに<a href="#_installation">インストール</a>する場合は <code>shadow-cljs</code> コマンドを直接使うことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs help</code></pre>
</div>
</div>
<div class="paragraph">
<p>ローカルの <code>npm</code> インストールのみを使いたい場合は <code>npx</code> や <code>yarn</code> を使って起動することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># npm
$ npx shadow-cljs help

# yarn
$ yarn shadow-cljs help

# manually
$ ./node_modules/.bin/shadow-cljs help</code></pre>
</div>
</div>
<div class="paragraph">
<p>このガイドでは、例を短くするためにグローバルインストールを想定していますが、これは必須ではありません。</p>
</div>
<div class="listingblock">
<div class="title">開発中によく使われる shadow-cljs コマンド</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># 一度ビルドをコンパイルして終了する
$ shadow-cljs compile app

# コンパイルして見張る
$ shadow-cljs watch app

# ビルド用の REPL に接続します (ウォッチの実行中に利用可能)
$ shadow-cljs cljs-repl app

# スタンドアロン node repl に接続
$ shadow-cljs node-repl</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">本番用に最適化されたリリースビルドの実行</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs release app</code></pre>
</div>
</div>
<div class="paragraph">
<p>時々 <code>:advanced</code> のコンパイルに起因するリリース上の問題が発生することがあります。これらのコマンドは原因を突き止めるのに役立ちます。</p>
</div>
<div class="listingblock">
<div class="title">Release debugging commands.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs check app
$ shadow-cljs release app --debug</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="server-mode"><a class="anchor" href="#server-mode"></a><a class="link" href="#server-mode">3.1.1. Server Mode</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> コマンドの起動はかなり遅くなります。これを改善するために <code>shadow-cljs</code> は "server mode" で実行することができます。専用のプロセスで開始され、毎回新しい JVM/Clojure インスタンスを起動する必要がないので、他のすべてのコマンドがより速く実行できます。</p>
</div>
<div class="paragraph">
<p>長時間実行するようなコマンドは、暗黙のうちにサーバインスタンスを起動しますが(例: <code>watch</code>)、多くの場合専用のサーバプロセスを実行しておくことを推奨します。</p>
</div>
<div class="paragraph">
<p>専用のターミナルでフォアグラウンドでプロセスを実行することができます。サーバを終了させるには <code>CTRL+C</code> を使います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs server

# または (サーバプロセスを制御するためにREPLを使用したい場合は)
$ shadow-cljs clj-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、共通の <code>start|stop|restart</code> 関数で制御されたバックグラウンドでサーバを実行することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs start
$ shadow-cljs stop
$ shadow-cljs restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>どのサーバーでも一旦実行されると、他のすべてのコマンドはそれを使用して、はるかに高速に実行されます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_tool_integration"><a class="anchor" href="#_build_tool_integration"></a><a class="link" href="#_build_tool_integration">3.2. Build Tool Integration</a></h3>
<div class="paragraph">
<p>主なディストリビューションは <a href="https://clojars.org/thheller/shadow-cljs">Clojars</a> から入手できる <code>.jar</code> ファイルだけなので <code>shadow-cljs</code> は他の Clojure ツールと統合することができます。デフォルトでは <code>:dependencies</code> は <code>shadow-cljs.edn</code> で管理されていますが、他のビルドツールを使って依存関係を管理することもできます。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
スタンドアロンの <code>shadow-cljs</code> バージョンを使用することを強くお勧めします。このコマンドは、他のツールではできないユーザーエクスペリエンスを最適化するために多くのことを行います (例えば、起動の高速化など)。また、依存関係の競合やその他の関連するエラーを処理する手間も省けます。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="Leiningen"><a class="anchor" href="#Leiningen"></a><a class="link" href="#Leiningen">3.2.1. Leiningen</a></h4>
<div class="paragraph">
<p><a href="https://leiningen.org/">Leiningen</a>を使って依存関係を管理したい場合は <code>shadow-cljs.edn</code> の設定に <code>:lein</code> エントリを追加してください。この設定では <code>shadow-cljs</code> コマンドは <code>lein</code> を使って JVM を起動し <code>shadow-cljs.edn</code> の <code>:source-paths</code> や <code>:dependencies</code> は無視します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:lein</span> <span class="predefined-constant">true</span>
 <span class="comment">; :source-paths と :dependencies はこのファイルでは無視され</span>
 <span class="comment">; project.clj を通して設定されます</span>
 <span class="symbol">:builds</span> { <span class="keyword">..</span><span class="keyword">.</span> }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">専用の <code>lein</code> プロファイルを使う</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:lein</span> {<span class="symbol">:profile</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">+cljs</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample project.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject my-awesome-project
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:profiles</span>
  {<span class="symbol">:cljs</span>
   {<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/cljs</span><span class="delimiter">&quot;</span></span>]
    <span class="symbol">:dependencies</span> [[thheller/shadow-cljs <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>]
                   [reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.8.1</span><span class="delimiter">&quot;</span></span>]]}})</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>project.clj</code> を使って <code>:dependencies</code> を管理する場合、手動で <a href="https://clojars.org/thheller/shadow-cljs">thheller/shadow-cljs</a> アーティファクトを <code>:dependencies</code> (直接またはプロファイル) に含めなければなりません。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>shadow-cljs</code> を起動したり、ビルドをコンパイルしようとしたときに、奇妙な Java Stackstraces が発生する場合、依存関係の競合があるかもしれません。shadow-cljs` が <code>org.clojure/clojurescript</code> と <code>closure-compiler</code> のバージョンにマッチした状態で使われていることが非常に重要です。必要なバージョンは <code>lein deps :tree</code> で確認でき、https://clojars.org/thheller/shadow-cljs[clojars] (右側) にリストアップされています。
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_running_tasks_directly_from_leiningen"><a class="anchor" href="#_running_tasks_directly_from_leiningen"></a><a class="link" href="#_running_tasks_directly_from_leiningen">Leiningenから直接タスクを実行する</a></h5>
<div class="paragraph">
<p>また <code>shadow-cljs</code> コマンド自体を使いたくない場合は <code>lein</code> を使って <code>shadow-cljs</code> コマンドを直接実行することもできます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
コマンドを実行するには <code>shadow-cljs</code> コマンドを使用することをお勧めします。これは <code>lein</code> を直接使用する場合に追加の JVM を起動するよりも、コマンドの実行速度を大幅に向上させることができます。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">REPLやライブリロードをせずに、一度だけ :devモードでコンパイルする。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m shadow.cljs.devtools.cli compile build-id</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">:release モードに最適化されたビルドを作成する。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m shadow.cljs.devtools.cli release build-id</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deps-edn"><a class="anchor" href="#deps-edn"></a><a class="link" href="#deps-edn">3.2.2. tools.deps / deps.edn</a></h4>
<div class="paragraph">
<p>新しい <a href="https://clojure.org/guides/deps_and_cli">deps.edn</a> は、組み込みのメソッドや <code>lein</code> を使う代わりに <code>:dependencies</code> や <code>:source-paths</code> を管理するために使うこともできます。すべての <code>shadow-cljs</code> コマンドは、代わりに新しい <code>clojure</code> ユーティリティを使って起動されます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>tools.deps</code> はまだかなりの頻度で変更されています。最新のバージョンを使用していることを確認してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これを使用するには、設定で <code>:deps true</code> プロパティを設定します。どの <code>deps.edn</code> エイリアスを使用するかを設定することもできます。</p>
</div>
<div class="paragraph">
<p>手動で <code>deps.edn</code> に <code>thheller/shadow-cljs</code> アーティファクトを追加する必要があります。</p>
</div>
<div class="listingblock">
<div class="title">Simple <code>shadow-cljs.edn</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:deps</span> <span class="predefined-constant">true</span>
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Simple <code>deps.edn</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:deps</span> {thheller/shadow-cljs {<span class="symbol">:mvn/version</span> &lt;latest&gt;}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> with :cljs alias</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:deps</span> {<span class="symbol">:aliases</span> [<span class="symbol">:cljs</span>]}
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>deps.edn</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:deps</span> {<span class="keyword">..</span><span class="keyword">.</span>}
 <span class="symbol">:aliases</span>
 {<span class="symbol">:cljs</span>
  {<span class="symbol">:extra-deps</span> {thheller/shadow-cljs {<span class="symbol">:mvn/version</span> &lt;latest&gt;}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>直接 <code>clj</code> で実行するなら</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:deps</span> {<span class="keyword">..</span><span class="keyword">.</span>}
 <span class="symbol">:aliases</span>
 {<span class="symbol">:shadow-cljs</span>
  {<span class="symbol">:extra-deps</span> {thheller/shadow-cljs {<span class="symbol">:mvn/version</span> &lt;latest&gt;}}
   <span class="symbol">:main-opts</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">-m</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">shadow.cljs.devtools.cli</span><span class="delimiter">&quot;</span></span>]}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">clj -A<span class="symbol">:shadow-cljs</span> watch app</code></pre>
</div>
</div>
<div class="paragraph">
<p>コマンドラインで <code>-A</code> を使って追加のエイリアスを指定することもできます。 例. <code>shadow-cljs -A:foo:bar &#8230;&#8203;</code>.など。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
エイリアスが適用されるのは新しいインスタンス/サーバが起動したときだけです。これらは <code>shadow-cljs</code> コマンドを使って実行中のサーバに接続しているときには適用されません。<code>clj</code> を使って実行すると、常に新しい JVM が起動され、サーバモードはサポートされません。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_boot"><a class="anchor" href="#_boot"></a><a class="link" href="#_boot">3.2.3. Boot</a></h4>
<div class="paragraph">
<p>著者は Boot の経験がほとんどないため、この章では貢献を必要としています。Bootでは、関数からツールチェーンを構築できることを理解しています。<code>shadow-cljs</code> は通常の JVM ライブラリなので、その中の関数を呼び出してタスクを呼び出すことができます。</p>
</div>
<div class="paragraph">
<p>いくつかのbootタスクはここにあります: <a href="https://github.com/jgdavey/boot-shadow-cljs" class="bare">https://github.com/jgdavey/boot-shadow-cljs</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clj-run"><a class="anchor" href="#clj-run"></a><a class="link" href="#clj-run">3.3. Running Clojure Code</a></h3>
<div class="paragraph">
<p>コマンドラインから特定のClojure関数を呼び出すために`shadow-cljs` CLIを使うことができます。これは、特定のタスクの前後にコードを実行したい場合に便利です。例えば <code>release</code> ビルドの出力をリモートサーバに <code>rsync</code> したいとします。</p>
</div>
<div class="listingblock">
<div class="title">Example Clojure Namespace in <code>src/my/build.clj</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.build</span>
  (<span class="symbol">:require</span>
    [shadow.cljs.devtools.api <span class="symbol">:as</span> shadow]
    [clojure.java.shell <span class="symbol">:refer</span> (sh)]))

(<span class="keyword">defn</span> <span class="function">release</span> []
  (shadow/release <span class="symbol">:my-build</span>)
  (sh <span class="string"><span class="delimiter">&quot;</span><span class="content">rsync</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-arzt</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/output-dir</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my@server.com:some/path</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Running the <code>release</code> function</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-run my.build/release
# or
$ shadow-cljs run my.build/release</code></pre>
</div>
</div>
<div class="paragraph">
<p>呼び出された関数には、コマンドラインを介して引数を渡すことができます。</p>
</div>
<div class="listingblock">
<div class="title">通常の Clojure fn args で引数を使用する</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
(<span class="keyword">defn</span> <span class="function">release</span> [server]
  (shadow/release <span class="symbol">:my-build</span>)
  (sh <span class="string"><span class="delimiter">&quot;</span><span class="content">rsync</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-arzt</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/output-dir</span><span class="delimiter">&quot;</span></span> server))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">コマンドラインからサーバーへの受け渡し</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-run my.build/release my@server.com:some/path</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
通常の <code>(defn release [&amp; args])</code> 構造体は、 <a href="https://github.com/clojure/tools.cli">tools.cli</a> のように引数を解析したい場合にも動作します。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>あなたはここでClojureのフルパワーにアクセスすることができます。お望みならば、この上にツール全体を構築することができます。ボーナスとして、この方法で書いたものはすべてClojure REPL経由で直接利用可能です。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<a href="#server-mode">server</a>を実行している場合、名前空間は自動的にリロードされず、一度だけロードされます。REPLを使って開発を行い、通常通りリロードすることをお勧めします(例: <code>(require 'my.build :reload)</code>)。また <code>shadow-cljs clj-eval "(require 'my.build :reload)"</code> を実行して、コマンドラインから手動でリロードすることもできます。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_calling_watch_via_clj_run"><a class="anchor" href="#_calling_watch_via_clj_run"></a><a class="link" href="#_calling_watch_via_clj_run">3.3.1. Calling watch via clj-run</a></h4>
<div class="paragraph">
<p>デフォルトでは <code>clj-run</code> によって呼び出された関数は <code>compile</code>, <code>release</code> や他のClojure機能を実行するのに十分な最小限の <code>shadow-cljs</code> ランタイムにしかアクセスできません。JVMは、関数が完了すると終了します。</p>
</div>
<div class="paragraph">
<p>あるビルドに対して <code>watch</code> を起動したい場合、呼び出した関数がフルサーバを必要とすることを宣言する必要があります。これにより、明示的に <code>(shadow.cljs.devtools.server/stop!)</code> を呼び出すか <code>CTRL+C</code> でプロセスを起動するまでプロセスは生きたままになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.run</span>
  (<span class="symbol">:require</span> [shadow.cljs.devtools.api <span class="symbol">:as</span> shadow]))

<span class="comment">;; これは、完全なサーバインスタンスがないために失敗します。</span>
(<span class="keyword">defn</span> <span class="function">foo</span>
  [&amp; args]
  (shadow/watch <span class="symbol">:my-build</span>))

<span class="comment">;; このメタデータはサーバが起動されていることを確認します。</span>
(<span class="keyword">defn</span> <span class="function">foo</span>
  {<span class="symbol">:shadow/requires-server</span> <span class="predefined-constant">true</span>}
  [&amp; args]
  (shadow/watch <span class="symbol">:my-build</span>))</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repl_2"><a class="anchor" href="#_repl_2"></a><a class="link" href="#_repl_2">4. REPL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>REPLはClojure(Script)コードを扱うときに持っていると非常に強力なツールです。<code>shadow-cljs</code> は、標準ビルドに統合されたバリアントだけでなく、すぐに始められるようにいくつかの組み込みバリアントを提供しています。</p>
</div>
<div class="paragraph">
<p>すぐにいくつかのコードをテストしたい場合は、組み込みの REPL で十分です。より複雑なセットアップを必要とする場合は、実際のビルドを使用するのがベストです。</p>
</div>
<div class="sect2">
<h3 id="_clojurescript_repl"><a class="anchor" href="#_clojurescript_repl"></a><a class="link" href="#_clojurescript_repl">4.1. ClojureScript REPL</a></h3>
<div class="paragraph">
<p>デフォルトでは <code>node-repl</code> と <code>browser-repl</code> のどちらかを選ぶことができます。どちらも似たような動作をしますが、一方は管理された <code>node.js</code> プロセスで動作し、他方は実際のコードを評価するために使用されるブラウザウィンドウを開くという点が違います。</p>
</div>
<div class="sect3">
<h4 id="node-repl"><a class="anchor" href="#node-repl"></a><a class="link" href="#node-repl">4.1.1. Node REPL</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs node-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、すでに接続されている <code>node</code> プロセスで空のCLJS REPLを起動します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
ノードREPLを終了した場合 <code>node</code> プロセスも終了します。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>node-repl</code> を使うと、追加の設定なしに始めることができます。これは通常の方法、すなわち <code>(require '[your.core :as x])</code> ですべてのコードにアクセスすることができます。ビルドに接続されていないので、ファイルが変更されてもコードの自動再構築は行われず、ホットリロードも行いません。</p>
</div>
</div>
<div class="sect3">
<h4 id="browser-repl"><a class="anchor" href="#browser-repl"></a><a class="link" href="#browser-repl">4.1.2. Browser REPL</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs browser-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは空のCLJS REPLを起動し、コードが実行される関連するブラウザウィンドウを開きます。ブラウザで実行するだけでなく、これは上記の <code>node-repl</code> と同じ機能をすべて持っています。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
ブラウザのウィンドウを閉じると、REPLは動作を停止します。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="build-repl"><a class="anchor" href="#build-repl"></a><a class="link" href="#build-repl">4.1.3. Build-specific REPL</a></h4>
<div class="paragraph">
<p><code>node-repl</code> と <code>browser-repl</code> は特定のビルド設定をしなくても動作します。つまり、あなたが指示したことは何でもできるだけで、それ自体は何もしません。</p>
</div>
<div class="paragraph">
<p>特定のものをビルドしたい場合は、提供されている build-targets の一つを使ってビルドを設定する必要があります。それらのほとんどは、ClojureScript REPLのために必要なコードを自動的に注入します。追加の設定は必要ありません。ビルドCLJS REPLが動作するためには、2つのものが必要です。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ビルド用に実行中の <code>watch</code></p>
</li>
<li>
<p><code>:target</code> の JS ランタイムに接続します。つまり <code>:browser</code> ターゲットを使用している場合は、生成された JS が読み込まれたブラウザを開く必要があります。node.jsのビルドでは <code>node</code> プロセスを実行することを意味します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>両方が揃ったら、コマンドラインまたはClojure REPLからCLJS REPLに接続することができます。</p>
</div>
<div class="listingblock">
<div class="title">CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch build-id
...

# 別のターミナルウィンドウ$ shadow-cljs cljs-repl build-id
shadow-cljs - connected to server
[3:1]~cljs.user=&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">REPL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-repl
...
[2:0]~shadow.user=&gt; (shadow/watch :browser)
[:browser] Configuring build.
[:browser] Compiling ...
[:browser] Build completed. (341 files, 1 compiled, 0 warnings, 3,19s)
:watching
[2:0]~shadow.user=&gt; (shadow/repl :browser)
[2:1]~cljs.user=&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
REPLを終了するには <code>:repl/quit</code> とタイプします。これはREPLを終了するだけで <code>watch</code> は実行されたままです。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
複数の <code>watch</code> "worker" を並行して実行し、それらの REPL に接続/切断することができます。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">接続不能ランタイムエラー</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">[3:1]~cljs.user=&gt; (js/alert &quot;foo&quot;)
There is no connected JS runtime.</code></pre>
</div>
</div>
<div class="paragraph">
<p>これが表示された場合は、ブラウザでアプリを開くか <code>node</code> プロセスを開始する必要があります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clojure_repl"><a class="anchor" href="#_clojure_repl"></a><a class="link" href="#_clojure_repl">4.2. Clojure REPL</a></h3>
<div class="paragraph">
<p>提供されているClojureScript REPLに加えて、Clojure REPLも提供されています。これは <code>shadow-cljs</code> プロセスを制御し、それを通して他のすべてのビルドコマンドを実行するために使用することができます。Clojure REPLから始めて、いつでもCLJS REPLにアップグレードすることができます。</p>
</div>
<div class="listingblock">
<div class="title">Running from the CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-repl
...
shadow-cljs - REPL - see (help), :repl/quit to exit
[1:0]~shadow.user=&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>名前空間 <code>shadow.cljs.devtools.api</code> は、多かれ少なかれCLIに対応する関数を持っています。デフォルトでは <code>shadow</code> という名前でエイリアスされています。</p>
</div>
<div class="listingblock">
<div class="title">Example commands</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs watch foo</span>
(shadow.cljs.devtools.api/watch <span class="symbol">:foo</span>)
<span class="comment">;; this is identical, due to the provided ns alias</span>
(shadow/watch <span class="symbol">:foo</span>)
<span class="comment">;; shadow-cljs watch foo --verbose</span>
(shadow/watch <span class="symbol">:foo</span> {<span class="symbol">:verbose</span> <span class="predefined-constant">true</span>})
<span class="comment">;; shadow-cljs compile foo</span>
(shadow/compile <span class="symbol">:foo</span>)
<span class="comment">;; shadow-cljs release foo</span>
(shadow/release <span class="symbol">:foo</span>)

<span class="comment">;; shadow-cljs browser-repl</span>
(shadow/browser-repl)
<span class="comment">;; shadow-cljs node-repl</span>
(shadow/node-repl)
<span class="comment">;; shadow-cljs cljs-repl foo</span>
(shadow/repl <span class="symbol">:foo</span>)

<span class="comment">;; Once you are in a CLJS REPL you can use</span>
<span class="symbol">:repl/quit</span>
<span class="comment">;; or</span>
<span class="symbol">:cljs/quit</span>
<span class="comment">;; to drop back down to CLJ.</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="embedded"><a class="anchor" href="#embedded"></a><a class="link" href="#embedded">4.2.1. Embedded</a></h4>
<div class="paragraph">
<p>また、他のCLJプロセス内から <code>shadow-cljs</code> を完全に使用することも可能です。クラスパスに <code>thheller/shadow-cljs</code> アーティファクトがロードされていれば問題ありません。</p>
</div>
<div class="listingblock">
<div class="title">Example using <code>lein repl</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein repl
nREPL server started on port 57098 on host 127.0.0.1 - nrepl://127.0.0.1:57098
REPL-y 0.4.3, nREPL 0.6.0
Clojure 1.10.0
...

user=&gt; (require '[shadow.cljs.devtools.server :as server])
nil
user=&gt; (server/start!)
...
:shadow.cljs.devtools.server/started
user=&gt; (require '[shadow.cljs.devtools.api :as shadow])
nil
user=&gt; (shadow/compile :foo)
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>(shadow.cljs.devtools.server/stop!)</code> これは実行中のビルドプロセスもすべて停止します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
CLJS REPLに切り替えたい場合は、サーバを起動する際に使用したツールで追加の設定が必要になるかもしれません。 <code>lein</code> はデフォルトでnREPLを使うようになっているので、追加のnREPL <code>:middleware</code> を設定する必要があります。 <code>clj</code> を使う場合は、nREPLを使わないので問題ありません。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="config"><a class="anchor" href="#config"></a><a class="link" href="#config">5. Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> はプロジェクトのルートディレクトリにある <code>shadow-cljs.edn</code> ファイルによって設定されます。デフォルトのファイルは <code>shadow-cljs init</code> を実行することで作成できます。このファイルには、グローバルな設定を含むマップと、すべてのビルド用の <code>:builds</code> エントリが含まれているはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>設定例は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span>
 [[reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.8.0-alpha2</span><span class="delimiter">&quot;</span></span>]]

 <span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例のファイル構成は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── my
        └── app.cljs</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="source-paths"><a class="anchor" href="#source-paths"></a><a class="link" href="#source-paths">5.1. Source Paths</a></h3>
<div class="paragraph">
<p><code>:source-paths</code> は JVM のクラスパスを設定します。コンパイラはこの設定を使ってClojure(Script)のソースファイル(例: <code>.cljs</code> )を見つけます。</p>
</div>
<div class="paragraph">
<p>全てを一つのソースパスに入れるのは良いのですが、ソースファイルを特定の方法で"グループ"化したい場合は、複数のソースパスを使うことができます。例えば、テストを別々にしておきたい場合などに便利です。</p>
</div>
<div class="listingblock">
<div class="title">複数のソースパスの使用</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">src/test</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ファイル構成</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── my
            └── app.cljs
    └── test
        └── my
            └── app_test.cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>ソースファイルを拡張子(例: <code>src/clj</code>, <code>src/cljs</code>, <code>src/cljc</code>)で分けることは推奨されていません。なぜかこれは CLJS プロジェクトのテンプレートで広く使われていますが、使いにくくなるだけです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependencies"><a class="anchor" href="#_dependencies"></a><a class="link" href="#_dependencies">5.2. 依存関係</a></h3>
<div class="sect3">
<h4 id="_clojure_script"><a class="anchor" href="#_clojure_script"></a><a class="link" href="#_clojure_script">5.2.1. Clojure(Script)</a></h4>
<div class="paragraph">
<p>依存関係は <code>shadow-cljs.edn</code> 設定ファイルのルートにある <code>:dependencies</code> キーで管理されます。依存関係は <code>lein</code> や <code>boot</code> のような他の Clojure ツールと同じ記法で宣言されます。</p>
</div>
<div class="paragraph">
<p>各依存関係は、外側のベクトルに入れ子にした <code>[library-name "version-string"]</code> を用いてベクトルとして記述しています。</p>
</div>
<div class="listingblock">
<div class="title">:dependencies の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dependencies</span> [[reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.9.1</span><span class="delimiter">&quot;</span></span>]]
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ソースパスが指定されるのは、設定全体の中で <strong>一度</strong> だけであることに注意してください。システムは名前空間依存性グラフを使用して、任意のビルドの最終出力に必要なコードを決定します。</p>
</div>
</div>
<div class="sect3">
<h4 id="npm-install"><a class="anchor" href="#npm-install"></a><a class="link" href="#npm-install">5.2.2. JavaScript</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> は、https://www.npmjs.com/[<code>npm</code>] エコシステムと完全に統合して JavaScript の依存関係を管理します。</p>
</div>
<div class="paragraph">
<p>依存関係の管理には <code>npm</code> や <code>yarn</code> を使うことができます。</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
npm
</td>
<td class="hdlist2">
<p><a href="https://docs.npmjs.com/" class="bare">https://docs.npmjs.com/</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
yarn
</td>
<td class="hdlist2">
<p><a href="https://yarnpkg.com/en/docs" class="bare">https://yarnpkg.com/en/docs</a></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>どちらもプロジェクトディレクトリの <code>package.json</code> ファイルを使って依存関係を管理します。 ほとんどのパッケージは <code>npm</code> で利用できるので、インストール方法を説明してくれます。これらの説明は <code>shadow-cljs</code> にも適用されます。</p>
</div>
<div class="listingblock">
<div class="title">Installing a JavaScript package</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># npm
$ npm install the-thing

# yarn
$ yarn add the-thing</code></pre>
</div>
</div>
<div class="paragraph">
<p>これ以上は必要ありません。依存関係は <code>package.json</code> ファイルに追加され、これが管理に使われます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
まだ <code>package.json</code> を持っていない場合は、コマンドラインから <code>npm init</code> を実行します。
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_missing_js_dependency"><a class="anchor" href="#_missing_js_dependency"></a><a class="link" href="#_missing_js_dependency">Missing JS Dependency?</a></h5>
<div class="paragraph">
<p>JS の依存関係の欠落に関連したエラーに遭遇するかもしれません。ほとんどの ClojureScript ライブラリはまだ <code>npm</code> パッケージを宣言していません。私たちは <code>npm</code> を直接使いたいので、ライブラリが <code>:npm-deps</code> を適切に宣言するまでは <code>npm</code> パッケージを手動でインストールしなければなりません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">必要なJSの依存関係 &quot;react&quot; が利用できません、これは...</code></pre>
</div>
</div>
<div class="paragraph">
<p>ということは <code>npm install react</code> をするべきだということです。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<code>react</code> の場合、次の3つのパッケージが必要になるでしょう。 <code>npm install react react-dom create-react-class</code> 
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="user-config"><a class="anchor" href="#user-config"></a><a class="link" href="#user-config">5.3. User Configuration</a></h3>
<div class="paragraph">
<p>ほとんどの設定はプロジェクト自身で <code>shadow-cljs.edn</code> を使って行いますが、いくつかの設定はユーザに依存することがあります。https://docs.cider.mx[CIDER] のようなツールは <code>shadow-cljs.edn</code> で依存関係を追加しても Cursive を使っている別のチームメンバーには意味がないので、追加の <code>cider-nrepl</code> 依存関係を必要とするかもしれません。</p>
</div>
<div class="paragraph">
<p>制限された設定オプションのセットを <code>~/.shadow-cljs/config.edn</code> に追加することができ、このユーザのマシンでビルドされたすべてのプロジェクトに適用されます。</p>
</div>
<div class="paragraph">
<p>依存関係を追加するには、通常の <code>:dependencies</code> キーを使用します。ここで追加された依存関係はすべてのプロジェクトに適用されることに注意してください。依存関係は最小限に抑え、ツール関連の依存関係だけをここに入れてください。ビルドに関連するものはすべて <code>shadow-cljs.edn</code> のままにしておくべきです。これらの依存関係は <code>deps.edn</code> や <code>lein</code> を使うときにも自動的に追加されます。</p>
</div>
<div class="listingblock">
<div class="title">Example ~/.shadow-cljs/config.edn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span>
 [[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.21.1</span><span class="delimiter">&quot;</span></span>]]}
<span class="comment">;; このバージョンは古いかもしれません、利用可能なものをチェックしましょう。</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>依存関係を解決するために <code>deps.edn</code> を使う場合、追加のエイリアスを有効にしたいことがあるかもしれません。これは <code>:deps-aliases</code> で行うことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs.edn in project</span>
{<span class="symbol">:deps</span> {<span class="symbol">:aliases</span> [<span class="symbol">:cljs</span>]}}

<span class="comment">;; ~/.shadow-cljs/config.edn</span>
{<span class="symbol">:deps-aliases</span> [<span class="symbol">:cider</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより <code>deps.edn</code> を使っているプロジェクトで <code>shadow-cljs</code> コマンドが <code>[:cider :cljs]</code> エイリアスを使うようになります。これは <code>~/.clojure/deps.edn</code> に追加の <code>:cider</code> エイリアスがある場合に便利です。</p>
</div>
<div class="paragraph">
<p>デフォルトでは <code>shadow-cljs</code> サーバモードは必要ないかもしれない組み込みの nREPL サーバを起動します。これを無効にするには、ユーザ設定で <code>:nrepl false</code> を設定します。</p>
</div>
<div class="paragraph">
<p>ユーザー設定で現在認められている他の値は、 <a href="#open-file-command">:open-file-command</a> だけです。他のオプションは現在のところ何の影響もありません。</p>
</div>
</div>
<div class="sect2">
<h3 id="_server_options"><a class="anchor" href="#_server_options"></a><a class="link" href="#_server_options">5.4. Server Options</a></h3>
<div class="paragraph">
<p>このセクションでは <code>shadow-cljs</code> サーバインスタンスを設定する他のオプションについて説明します。これらはオプションです。</p>
</div>
<div class="sect3">
<h4 id="nREPL"><a class="anchor" href="#nREPL"></a><a class="link" href="#nREPL">5.4.1. nREPL</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> <a href="#server-mode">server</a> は <a href="https://nrepl.org">nREPL</a> サーバを TCP 経由で提供します。起動メッセージを見るとnREPLのポート番号が表示されており、その数値は <code>target/shadow-cljs/nrepl.port</code> に格納されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch app
shadow-cljs - HTTP server available at http://localhost:8600
shadow-cljs - server version: &lt;version&gt; running at http://localhost:9630
shadow-cljs - nREPL server started on port 64967
shadow-cljs - watching build :app
[:app] Configuring build.
[:app] Compiling ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>ポート番号や追加のミドルウェアは <code>shadow-cljs.edn</code> で設定することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:nrepl</span> {<span class="symbol">:port</span> <span class="integer">9000</span>
         <span class="symbol">:middleware</span> []} <span class="comment">; optional list of namespace-qualified symbols</span>
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>デフォルトのグローバル設定ファイルは <code>~/.nrepl/nrepl.edn</code> またはローカルの <code>.nrepl.edn</code> にあり、起動時に読み込まれ <code>:middleware</code> を設定するのに使われます。</p>
</div>
<div class="paragraph">
<p>人気のあるミドルウェア <a href="https://github.com/clojure-emacs/cider-nrepl">cider-nrepl</a> がクラスパス上にあれば(例えば <code>:dependencies</code> に含まれているなど)、自動的に使用されます。追加の設定は必要ありません。これは <code>:nrepl {:cider false}</code> を設定することで無効にできます。</p>
</div>
<div class="paragraph">
<p>接続時に開始する名前空間は <code>:nrepl</code> オプションで <code>:init-ns</code> を設定することで設定できます。デフォルトは <code>shadow.user</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:nrepl</span> {<span class="symbol">:init-ns</span> my.repl}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>nREPLサーバは <code>:nrepl false</code> を設定することで無効にすることができます。</p>
</div>
<div class="sect4">
<h5 id="_nrepl_usage"><a class="anchor" href="#_nrepl_usage"></a><a class="link" href="#_nrepl_usage">nREPL Usage</a></h5>
<div class="paragraph">
<p>nREPLサーバに接続するとき、接続は常にClojure REPLとして始まります。CLJS REPLへの切り替えは<a href="#cljs-repl">non-nREPL version</a>と同様に動作します。まず、与えられたビルドのための <code>watch</code> を開始する必要があり、次に、現在のnREPLセッションをそのビルドに切り替えるために、このビルドを選択する必要があります。ビルドを選択した後は、ClojureではなくClojureScriptで全てが評価されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="repl">(shadow/watch :the-build)
(shadow/repl :the-build)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Use <code>:cljs/quit</code> to return to Clojure.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_embedded_nrepl_server"><a class="anchor" href="#_embedded_nrepl_server"></a><a class="link" href="#_embedded_nrepl_server">Embedded nREPL Server</a></h5>
<div class="paragraph">
<p>独自のnREPLサーバを提供する他のツール(例: <code>lein</code>)に埋め込まれた <code>shadow-cljs</code> を使う場合 <code>shadow-cljs</code> ミドルウェアを設定する必要があります。そうしないと、CLJとCLJSのREPLを切り替えることができません。</p>
</div>
<div class="listingblock">
<div class="title">Example Leiningen <code>project.clj</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject my-amazing-project <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:repl-options</span>
  {<span class="symbol">:init-ns</span> shadow.user <span class="comment">;; or any of your choosing</span>
   <span class="symbol">:nrepl-middleware</span>
   [shadow.cljs.devtools.server.nrepl/middleware]}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
CLJS REPLを使用する前に、<a href="#embedded">embedded server</a>を手動で起動する必要があります。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="socket-repl"><a class="anchor" href="#socket-repl"></a><a class="link" href="#socket-repl">5.4.2. Socket REPL</a></h4>
<div class="paragraph">
<p>Clojure Socket REPLはサーバモードで自動的に起動され、デフォルトではランダムなポートを使用します。ツールは、ポート番号を含む <code>.shadow-cljs/socket-repl.port</code> をチェックすることで、それが起動されたポートを見つけることができます。</p>
</div>
<div class="paragraph">
<p>また <code>shadow-cljs.edn</code> を使って固定ポートを設定することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:socket-repl</span>
 {<span class="symbol">:port</span> <span class="integer">9000</span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ソケットREPLを無効にするには <code>:socket-repl false</code> を設定します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_ssl"><a class="anchor" href="#_ssl"></a><a class="link" href="#_ssl">5.4.3. SSL</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> HTTPサーバはSSLをサポートしています。一致する秘密鍵と証明書を提供するJavaキーストアが必要です。</p>
</div>
<div class="listingblock">
<div class="title">SSL設定をした <code>shadow-cljs.edn</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:ssl</span> {<span class="symbol">:keystore</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">ssl/keystore.jks</span><span class="delimiter">&quot;</span></span>
       <span class="symbol">:password</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">shadow-cljs</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記はデフォルトなので、これらを使いたい場合は <code>:ssl {}</code> を設定するだけで大丈夫です。</p>
</div>
<div class="paragraph">
<p>javaの <code>keytool</code> コマンドを使用してキーストアを作成することができます。信頼できる自己署名証明書を作成することも可能ですが、少々複雑です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://gist.github.com/jchandra74/36d5f8d0e11960dd8f80260801109ab0">OpenSSL</a>のLinuxとWindowsの説明書 (WSL経由)</p>
</li>
<li>
<p><a href="https://certsimple.com/blog/localhost-ssl-fix">macOS</a>の説明書</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>作成した <code>Certificates.p12</code> (macOS) または <code>localhost.pfx</code> (Linux, Windows) ファイルは <code>keytool</code> ユーティリティを使って必要な <code>keystore.jks</code> に変換することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ keytool -importkeystore -destkeystore keystore.jks -srcstoretype PKCS12 -srckeystore localhost.pfx</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
証明書は、"localhost"（または使用したいホスト）のSAN（Subject Alternative Name）で生成する必要があります。SAN は、Chrome が証明書を信頼して警告を表示しないようにするために必要です。エクスポート時に使用するパスワードは、キーストアに割り当てられたパスワードと一致している必要があります。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="http"><a class="anchor" href="#http"></a><a class="link" href="#http">5.4.4. Primary HTTP(S)</a></h4>
<div class="paragraph">
<p>shadow-cljs` サーバはプライマリ HTTP サーバを一つ起動します。これはホットリロードとREPLクライアントに使われるUIとウェブソケットを提供するために使われます。デフォルトではポート9630を listen します。もしそのポートが使用中であれば、1つずつインクリメントして、開いているポートが見つかるまで再試行します。</p>
</div>
<div class="listingblock">
<div class="title">使用ポートを示す起動メッセージ</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">shadow-cljs - server running at http://0.0.0.0:9630</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ssl</code> が設定されている場合は、代わりに <code>https://</code> を用いてサーバを利用できるようになります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
サーバは <code>:ssl</code> を使うと自動的に HTTP/2 をサポートします。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>代わりに自分のポートを設定したい場合は <code>:http</code> 設定で設定することができます。</p>
</div>
<div class="listingblock">
<div class="title"><code>:http</code> を設定した <code>shadow-cljs.edn</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:http</span> {<span class="symbol">:port</span> <span class="integer">12345</span>
        <span class="symbol">:host</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my.machine.local</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:ssl</code> はサーバを <code>https://</code> のみに切り替えます。もし <code>http://</code> バージョンを維持したい場合は <code>:ssl-port</code> を別途設定することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:http</span> {<span class="symbol">:port</span> <span class="integer">12345</span>
        <span class="symbol">:ssl-port</span> <span class="integer">23456</span>
        <span class="symbol">:host</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dev-http"><a class="anchor" href="#dev-http"></a><a class="link" href="#dev-http">5.4.5. Development HTTP(S)</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> は <code>:dev-http</code> 設定項目で追加の基本的な HTTP サーバを提供することができます。デフォルトでは、これらは設定されたパスからすべての静的ファイルを提供し、リソースが見つからない場合は <code>index.html</code> にフォールバックします (これはブラウザのプッシュ状態を利用するアプリケーションを開発する際に典型的に必要とされるものです)。</p>
</div>
<div class="paragraph">
<p>これらのサーバは <code>shadow-cljs</code> がサーバモードで動作しているときに自動的に起動します。これらのサーバはどのビルドにも依存せず、それぞれに固有の <code>:output-dir</code> が使われている限り、複数のビルドに対応するファイルを提供するために使うことができます。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">IMPORTANT</dt>
<dd>
<p>これらは静的ファイルを提供する汎用的なウェブサーバです。ライブリロードや REPL ロジックには必要ありません。どのウェブサーバでも可能ですが、これらは利便性のために提供されているだけです。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">基本的な例として <code>public</code> ディレクトリを経由して <code><a href="http://localhost:8000" class="bare">http://localhost:8000</a></code> を提供する例。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:dev-http</code> は <code>port-number</code> から <code>config</code> へのマップを期待しています。config`は最も一般的なシナリオのためのいくつかのショートカットをサポートしています。</p>
</div>
<div class="listingblock">
<div class="title">Serve directory from filesystem root</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Serve from classpath root</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:public</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これはクラスパス上の <code>public/index.html</code> を経由して <code>/index.html</code> へのリクエストを見つけようとします。これは <code>.jar</code> ファイル内のファイルを含むかもしれません。</p>
</div>
<div class="listingblock">
<div class="title">Serve from multiple roots</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:c</span><span class="delimiter">&quot;</span></span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、まず <code>&lt;project-root&gt;/a/index.html</code>、次に <code>&lt;project-root&gt;/b/index.html</code>、次に <code>c/index.html</code> をクラスパス上で見つけようとします。何も見つからなければ、デフォルトのハンドラが呼ばれます。</p>
</div>
<div class="paragraph">
<p>長い設定バージョンではマップを想定しており、サポートされているオプションは以下の通りです。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:root</code></dt>
<dd>
<p>(String) リクエストに応答するパス。 <code>classpath:</code> で始まるパスは、ファイルシステムではなくクラスパスから提供します。ファイルシステムのパスはすべてプロジェクトのルートからの相対パスです。</p>
</dd>
<dt class="hdlist1"><code>:roots</code></dt>
<dd>
<p>(Vector of Strings) 複数のルートパスが必要な場合は <code>:roots</code> を使う。</p>
</dd>
<dt class="hdlist1"><code>:ssl-port</code></dt>
<dd>
<p><code>ssl</code> が設定されている場合、このポートを使ってssl接続を行い、通常のポートで通常のHTTPをサーバする。もし <code>:ssl-port</code> が設定されておらず <code>:ssl</code> が設定されている場合、デフォルトのポートは SSL リクエストのみを提供するようになります。</p>
</dd>
<dt class="hdlist1"><code>:host</code></dt>
<dd>
<p>省略可能です。listenするホスト名。デフォルトは localhost です。</p>
</dd>
<dt class="hdlist1"><code>:handler</code></dt>
<dd>
<p>オプションです。完全修飾シンボル。与えられたリクエストに対してリソースが見つからなかった場合に使われる <code>(defn handler [req] resp)</code> です。デフォルトは <code>shadow.http.push-state/handle</code> です。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>以下の2つのオプションは、デフォルトのビルトインハンドラを使用している場合にのみ適用され、通常は変更する必要はありません。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:push-state/headers</code></dt>
<dd>
<p>(オプション)  HTTP ヘッダのマップを返します。デフォルトは <code>text/html</code> 標準ヘッダ。</p>
</dd>
<dt class="hdlist1"><code>:push-state/index</code></dt>
<dd>
<p>(オプション) ファイルを提供、デフォルトは <code>index.html</code>  。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:dev-http</span>
 {<span class="integer">8080</span> {<span class="symbol">:root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:handler</span> my.app/handler}}}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="dev-http-proxy"><a class="anchor" href="#dev-http-proxy"></a><a class="link" href="#dev-http-proxy">Reverse Proxy Support</a></h5>
<div class="paragraph">
<p>デフォルトでは、開発サーバはローカルでリクエストを送ろうとしますが、時には外部のウェブサーバを使ってリクエストを送ろうとすることもあるでしょう (例: APIリクエスト)。これは <code>:proxy-url</code> で設定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:dev-http</span>
 {<span class="integer">8000</span>
  {<span class="symbol">:root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:proxy-url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://some.host</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code><a href="http://localhost:8000/api/foo" class="bare">http://localhost:8000/api/foo</a></code> へのリクエストは、代わりに <code><a href="https://some.host/api/foo" class="bare">https://some.host/api/foo</a></code> が返すコンテンツを返します。ローカルファイルを持たないリクエストはすべてプロキシされたサーバによって処理されます。</p>
</div>
<div class="paragraph">
<p>接続処理を設定するための追加オプションは次のとおりです。</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:proxy-rewrite-host-header</code></dt>
<dd>
<p>boolean, デフォルトは true です。オリジナルのHostヘッダを使うか <code>:proxy-url</code> のものを使うかを決定します。上の例で <code>localhost</code> と <code>some.host</code> を比較してみましょう。</p>
</dd>
<dt><code>:proxy-reuse-x-forwarded</code></dt>
<dd>
<p>boolean, デフォルトはfalseです。プロキシが <code>X-Forwarded-For</code> リストに自分自身を追加するか、新しいプロキシを開始するかを設定します。</p>
</dd>
<dt><code>:proxy-max-connection-retries</code></dt>
<dd>
<p>int, デフォルトは1</p>
</dd>
<dt><code>:proxy-max-request-time</code></dt>
<dd>
<p>ミリ秒をintで指定します、デフォルトは 30000 です。30秒のリクエストタイムアウト。</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jvm-opts"><a class="anchor" href="#jvm-opts"></a><a class="link" href="#jvm-opts">5.5. JVM Configuration</a></h3>
<div class="paragraph">
<p><code>shadow-cljs.edn</code> がJVMの起動を担当している場合、JVMに直接渡す追加のコマンドライン引数を設定することができます。例えば、shadow-cljsが使用するメモリの量を減らしたり増やしたりすることができます。</p>
</div>
<div class="paragraph">
<p>これは <code>shadow-cljs.edn</code> のルートで <code>:jvm-opts</code> を設定することで行われます。</p>
</div>
<div class="listingblock">
<div class="title">例：メモリ消費を1GBへ設定</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:jvm-opts</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">-Xmx1G</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>JVMに渡すことができる引数はバージョンによって異なりますが、 <a href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">こちら</a> に例示的なリストがあります。RAMの割り当てが少なすぎたり多すぎたりすると、パフォーマンスが低下する可能性があることに注意してください。通常はデフォルトで十分です。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>deps.edn</code> や <code>project.clj</code> を使う場合は、それらのファイルで <code>:jvm-opts</code> を設定する必要があります。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_configuration"><a class="anchor" href="#_build_configuration"></a><a class="link" href="#_build_configuration">6. Build Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs.edn</code> は <code>:builds</code> セクションも必要です。ビルドはビルドIDをキーにしたビルドのマップでなければなりません。</p>
</div>
<div class="listingblock">
<div class="title">A configuration file with a build map.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [[some-library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.2.1</span><span class="delimiter">&quot;</span></span>] <span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>   {<span class="symbol">:target</span>     <span class="symbol">:browser</span>
          <span class="keyword">..</span><span class="keyword">.</span> browser-specific options <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="symbol">:tests</span> {<span class="symbol">:target</span> <span class="symbol">:karma</span>
          <span class="keyword">..</span><span class="keyword">.</span> karma-specific options <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>各ビルドはコンパイラがビルドする成果物を記述します。ビルドターゲットは <code>shadow-cljs</code> の拡張可能な機能であり、コンパイラにはすでにかなりの数のビルドターゲットが用意されています。</p>
</div>
<div class="sect2">
<h3 id="_build_target"><a class="anchor" href="#_build_target"></a><a class="link" href="#_build_target">6.1. Build Target</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> の各ビルドは <code>:target</code> を定義しなければなりません。デフォルトのビルドインは <a href="#target-browser">browser</a> と <a href="#target-node"><code>node.js</code></a> です。これらはすべて <code>:dev</code> モードと <code>:release</code> モードを持つという基本的なコンセプトを共有しています。 <code>:dev</code> モードは、高速なコンパイル、ライブコードのリロード、REPLのような通常の開発上の利点をすべて提供します。リリースモードでは、プロダクション向けに最適化された出力を生成します。</p>
</div>
<div class="paragraph">
<p>ターゲットは別の章でカバーされています。</p>
</div>
<div class="paragraph">
<p>その一部をご紹介します。</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><a href="#target-browser"><code>:browser</code></a></dt>
<dd>
<p>Webブラウザでの実行に適した出力コード。</p>
</dd>
<dt><a href="#target-bootstrap"><code>:bootstrap</code></a></dt>
<dd>
<p>bootstrap cljs環境に適した出力コード。</p>
</dd>
<dt><a href="#target-browser-test"><code>:browser-test</code></a></dt>
<dd>
<p>必要なファイルを決定するためのテストをスキャンし、ブラウザでの実行に適したテストを出力します。</p>
</dd>
<dt><a href="#target-karma"><code>:karma</code></a></dt>
<dd>
<p>テストをスキャンして必要なファイルを判断し、カルマランナーに対応したテストを出力します。 <a href="http://karma-runner.github.io/2.0/index.html">Karma</a>を参照。</p>
</dd>
<dt><a href="#target-node-library"><code>:node-library</code></a></dt>
<dd>
<p>nodeライブラリとして使用するのに適した出力コード。</p>
</dd>
<dt><a href="#target-node-script"><code>:node-script</code></a></dt>
<dd>
<p>nodeスクリプトとして使用するのに適した出力コード。</p>
</dd>
<dt><a href="#target-npm-module"><code>:npm-module</code></a></dt>
<dd>
<p>NPM モジュールとして使用するのに適した出力コード。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>各ターゲットは、選択したターゲットによって残りのビルドオプションが異なるため、それぞれの章で詳しく説明します。</p>
</div>
</div>
<div class="sect2">
<h3 id="devtools"><a class="anchor" href="#devtools"></a><a class="link" href="#devtools">6.2. Development Options</a></h3>
<div class="paragraph">
<p>各ビルド <code>:target</code> は通常、何らかの開発サポートを提供します。これらは各 <code>:build</code> の <code>:devtools</code> キーの下にグループ化されています。</p>
</div>
<div class="sect3">
<h4 id="_repl_3"><a class="anchor" href="#_repl_3"></a><a class="link" href="#_repl_3">6.2.1. REPL</a></h4>
<div class="paragraph">
<p>REPL のための <code>watch</code> コードは自動的に注入され、通常は追加の設定を必要としません。REPLの動作を制御するための追加オプションがあります:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:repl-init-ns</code> は REPL をどの名前空間で開始するかを設定することができます。デフォルトは <code>cljs.user</code> です。</p>
</li>
<li>
<p><code>:repl-pprint</code> は、evalの結果を印刷する際に通常の <code>pr-str</code> の代わりに <code>cljs.pprint</code> を使用するようにします。デフォルトはfalseです。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:repl-init-ns</span> my.app
                   <span class="symbol">:repl-pprint</span> <span class="predefined-constant">true</span>
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preloads"><a class="anchor" href="#_preloads"></a><a class="link" href="#_preloads">6.2.2. Preloads</a></h4>
<div class="paragraph">
<p>開発者として、あなたの時間のほとんどは開発モードに費やされています。おそらく <code>figwheel</code>, <code>boot-reload</code>, <code>devtools</code> などのツールをよく知っているでしょう。これらのうちの 1 つ以上がビルドに必要であることはほぼ間違いありません。</p>
</div>
<div class="paragraph">
<p>プリロードは、生成された Javascript の前に特定の名前空間を強制的に挿入するために使用されます。これは一般的に、アプリケーションが実際にロードされて実行される前にツールやインストルメンテーションを注入するために使用されます。preloads オプションは <code>shadow-cljs-edn</code> の <code>:devtools</code>/<code>:preloads</code> セクションにある名前空間のリストです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:preloads</span> [fulcro.inspect.preload]
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
バージョン 2.0.130 以降、shadow-cljs は <code>watch</code> と <code>compile</code> のプリロードに <code>cljs-devtools</code> を自動的に追加します。必要なのは <code>binaryage/devtools</code> が <code>dependencies</code> リストにあることを確認するだけです。(注意: binaryage/<strong>cljs-</strong>devtools  <strong>ではありません。</strong>) 特定のターゲットに <code>cljs-devtools</code> を入れたくない場合は <code>:devtools</code> セクションに <code>:console-support false</code> を追加することで、これを抑制することができます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_hot_code_reload"><a class="anchor" href="#_hot_code_reload"></a><a class="link" href="#_hot_code_reload">6.2.3. Hot Code Reload</a></h4>
<div class="paragraph">
<p>React と ClojureScript のエコシステムは、この種のことを非常に便利にしてくれます。 <code>shadow-cljs</code> システムには、外部ツールに頼らずにホットコードのリロードを行うために必要なものがすべて含まれています。</p>
</div>
<div class="paragraph">
<p>使用するには、単に実行するだけです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">shadow-cljs watch build-id</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lifecycle_hooks"><a class="anchor" href="#_lifecycle_hooks"></a><a class="link" href="#_lifecycle_hooks">6.2.4. Lifecycle Hooks</a></h4>
<div class="paragraph">
<p>ホットコードのリロードが更新されたコードを取り込む直前と直後に関数を実行するようにコンパイラを設定することができます。これらは、古いコードの上で閉じてしまうようなものを止めたり起動したりするのに便利です。</p>
</div>
<div class="paragraph">
<p>これらは、ビルド設定の <code>:devtools</code> セクションで設定することができますし、コードの中で直接メタデータタグを使って設定することもできます。</p>
</div>
<div class="sect4">
<h5 id="_metadata"><a class="anchor" href="#_metadata"></a><a class="link" href="#_metadata">Metadata</a></h5>
<div class="paragraph">
<p>通常のCLJSの <code>defn</code> varsに特定のメタデータを設定することで、ライブリロード時にこれらの関数が特定のタイミングで呼び出されるようにコンパイラに通知することができます。</p>
</div>
<div class="listingblock">
<div class="title">hook config via metadata</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:dev/before-load</span> stop []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> ^<span class="symbol">:dev/after-load</span> start []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは新しいコードを読み込む前に <code>my.app/stop</code> を呼び出し、すべての新しいコードが読み込まれたときに <code>my.app/start</code> を呼び出すことになります。このように複数の関数にタグを付けることができ、それらの関数は名前空間の依存関係の順に呼び出されます。</p>
</div>
<div class="paragraph">
<p>リロード処理を進める前に完了すべきいくつかの非同期作業を行う必要がある場合に備えて、これらの非同期バリアントもあります。</p>
</div>
<div class="listingblock">
<div class="title">async hooks example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:dev/before-load-async</span> stop [done]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>)
  (js/setTimeout
    (<span class="keyword">fn</span> []
      (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop complete</span><span class="delimiter">&quot;</span></span>)
      (done)))

(<span class="keyword">defn</span> ^<span class="symbol">:dev/after-load-async</span> start [done]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>)
  (js/setTimeout
    (<span class="keyword">fn</span> []
      (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start complete</span><span class="delimiter">&quot;</span></span>)
      (done)))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
関数は、その作業が完了したときに呼び出されなければならないコールバック関数を1つ受け取ります。コールバック関数が呼び出されなかった場合、リロード処理は進みません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>名前空間にメタデータでタグを付けることができるので、再コンパイルしてもリロードされることはありません。</p>
</div>
<div class="listingblock">
<div class="title">A non-reloadable ns</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> ^<span class="symbol">:dev/once</span> my.thing)

(js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">will only execute once</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>名前空間は常にリロードするようにタグ付けすることもできます。</p>
</div>
<div class="listingblock">
<div class="title">An always-reloadable ns</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> ^<span class="symbol">:dev/always</span> my.thing)

(js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">will execute on every code change</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_config"><a class="anchor" href="#_config"></a><a class="link" href="#_config">Config</a></h5>
<div class="paragraph">
<p>メタデータに加えて <code>shadow-cljs.edn</code> でライフサイクルフックを設定することができます。</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:before-load</code></dt>
<dd>
<p>再コンパイルされたファイルをリフレッシュする直前に実行する関数のシンボル(名前空間付き)。 この関数は本質的に同期的でなければなりません。</p>
</dd>
<dt><code>:before-load-async</code></dt>
<dd>
<p>リフレッシュの直前に実行する関数 <code>(fn [done])</code> のシンボル (名前空間付き)。この関数は非同期処理を行うことができますが、完了したことを示すために <code>(done)</code> を呼び出す必要があります。</p>
</dd>
<dt><code>:after-load</code></dt>
<dd>
<p>ホットコードのリロードが完了した後に実行される関数のシンボル（名前空間付き）。</p>
</dd>
<dt><code>:after-load-async</code></dt>
<dd>
<p>ホットコードのリロードが完了した後に実行される関数 <code>(fn [done])</code> のシンボル (名前空間付き)。この関数は非同期処理を行うことができますが、完了したことを示すために <code>(done)</code> を呼び出す必要があります。</p>
</dd>
<dt><code>:autoload</code></dt>
<dd>
<p>コードをホットロードするかどうかを制御するブール値。コールバックのいずれかが設定されている場合、暗黙的に <code>true</code> に設定されます。デフォルトでは <code>:browser</code> ターゲットに対して常に有効で、無効にするには <code>false</code> をセットします。</p>
</dd>
<dt><code>:ignore-warnings</code></dt>
<dd>
<p>警告を含むコードをリロードするかどうかを制御するブール値。デフォルトは <code>false</code> です。</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">A sample of lifecycle hooks.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:before-load</span>  my.app/stop
                   <span class="symbol">:after-load</span>   my.app/start
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
フックは <code>cljs.user</code> 名前空間では宣言できません。フックは、フックを含む名前空間が実際にビルドに含まれている場合にのみ使用されます。追加の名前空間を使う場合は、必ず <code>:preloads</code> でインクルードしてください。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<code>:after-load</code> や <code>:before-load</code> が設定されていない場合、コンパイラは <code>:browser</code> ターゲットのコードのみをホットリロードします。それでもホットリロードしたいがコールバックが必要ない場合は、代わりに <code>:autoload true</code> を設定することができます。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-hooks"><a class="anchor" href="#build-hooks"></a><a class="link" href="#build-hooks">6.3. Build Hooks</a></h3>
<div class="paragraph">
<p>コンパイルパイプラインの特定の段階でカスタムコードを実行することが望ましい場合があります。<code>:build-hooks</code> は、どの関数を呼び出すかを宣言し、その時点でのビルド状態に完全にアクセスできるようにします。これは非常に強力であり、多くの可能なツールオプションを開くことができます。</p>
</div>
<div class="paragraph">
<p>これらはビルドごとに <code>:build-hooks</code> キーの下で設定されます。</p>
</div>
<div class="listingblock">
<div class="title">Exampe :build-hooks</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:build-hooks</span>
        [(my.util/hook <span class="integer">1</span> <span class="integer">2</span> <span class="integer">3</span>)]
        <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example hook code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.util</span>)

(<span class="keyword">defn</span> <span class="function">hook</span>
  {<span class="symbol">:shadow.build/stage</span> <span class="symbol">:flush</span>}
  [build-state &amp; args]
  (<span class="keyword">prn</span> [<span class="symbol">:hello-world</span> args])
  build-state)</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例では、ビルドが完了した後に <code>:flush</code> <a href="#compile-stages">stage</a> (すなわち、ディスクに書き込まれる) を呼び出します。この例では <code>[:hello-world (1 2 3)]</code> と表示されますが、実際のフックではもっと便利なものをお願いします。</p>
</div>
<div class="paragraph">
<p>フックは通常の <strong>Clojure</strong> 関数にメタデータを追加したものです。メタデータ <code>{:shadow.build/stage :flush}</code> は、このフックを <code>:flush</code> のためだけに呼び出すようにコンパイラに指示します。複数のステージの後にフックを呼び出す場合は、代わりに <code>{:shadow.build/stage #{:configure :flush}}</code> を設定することができます。そうしないとフックは何もしないので、少なくとも一つのステージを設定する必要があります。</p>
</div>
<div class="paragraph">
<p>すべてのビルドフックは <code>:target</code> の作業が完了した後に呼び出されます。これらのフックは <code>build-state</code> (現在のすべてのビルドデータを含む clojure マップ) を第一引数として受け取り、この <code>build-state</code> を変更したかどうかに関わらず返さなければ <strong>なりません。</strong> 複数のステージを使用する場合、後のステージが参照できるように <code>build-state</code> に追加のデータを追加することができます。誤ってビルド全体を壊してしまわないように、名前空間キーのみを使用することを強くお勧めします。</p>
</div>
<div class="paragraph">
<p><code>build-state</code> には、フックに役立つかもしれない重要なエントリがいくつかあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:shadow.build/build-id</code> - 現在のビルドのID (例えば <code>:app</code>)</p>
</li>
<li>
<p><code>:shadow.build/mode</code> - <code>:dev</code> or <code>:release</code></p>
</li>
<li>
<p><code>:shadow.build/stage</code> - the current stage</p>
</li>
<li>
<p><code>:shadow.build/config</code> - ビルドコンフィグ。フックの設定データを直接ビルドコンフィグに保存するか、フック自体の引数として渡すことができます。</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>watch</code> を実行していると、すべてのフックはビルドごとに繰り返し呼び出されます。ビルドのパフォーマンスにかなりの影響を与えるので、あまり多くの作業をしないようにしてください。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="compile-stages"><a class="anchor" href="#compile-stages"></a><a class="link" href="#compile-stages">6.3.1. Compilation Stages</a></h4>
<div class="paragraph">
<p>`:build-hooks``が使用できるステージは下記の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:configure</code> - 初期の <code>:target</code> 固有の設定</p>
</li>
<li>
<p><code>:compile-prepare</code> - コンパイル開始前に呼び出されます。</p>
</li>
<li>
<p><code>:compile-finish</code> - すべてのコンパイルが終了した後に呼び出されます。</p>
</li>
<li>
<p><code>:optimize-prepare</code> - Closure Compilerの最適化フェーズを実行する前に呼び出されます (<code>:release</code> のみ)</p>
</li>
<li>
<p><code>:optimize-finish</code> - Closureコンパイルの終了時に呼び出されます。 (<code>:release</code> のみ)</p>
</li>
<li>
<p><code>:flush</code> - ディスクにすべてを書き込んだ後に呼び出されます</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>実行中の <code>watch</code> では <code>:configure</code> が呼ばれるのは一度だけです。他のどれかは再コンパイルのたびに (順番に) 再度呼ばれるかもしれません。ビルド状態 <code>build-state</code> は、ビルド設定が変更されるまで再利用され、その時点で破棄されて新しいものが作成されます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiler_cache"><a class="anchor" href="#_compiler_cache"></a><a class="link" href="#_compiler_cache">6.4. Compiler Cache</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> はデフォルトですべてのコンパイル結果をキャッシュします。個々のソースファイルに関連する何かが変更されると、キャッシュは無効になります (例: コンパイラの設定の変更、依存関係の変更など)。これは開発者の体験を <strong>大幅</strong> に向上させます。</p>
</div>
<div class="paragraph">
<p>しかし、副作用のあるマクロを多く使用している場合 (ファイルを読んだり、コンパイラの状態の外に保存したり)、キャッシュを無効にすることは必ずしも確実にできるわけではありません。そのような場合は、キャッシュを完全に無効にする必要があるかもしれません。</p>
</div>
<div class="paragraph">
<p>副作用のあるマクロを含むことが知られている名前空間は、キャッシュをブロックすることができます。これらはそれ自体はキャッシュされず、それらを必要とする名前空間もキャッシュされません。 <a href="https://github.com/cerner/clara-rules">clara-rules</a> ライブラリには副作用のあるマクロがあり、デフォルトでブロックされています。どの名前空間をグローバルにブロックするかは <code>:cache-blockers</code> 設定で指定できます。これは名前空間シンボルのセットを期待しています。</p>
</div>
<div class="listingblock">
<div class="title">clara.rules キャッシュブロックの例 (デフォルトで行われています)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:cache-blockers</span> #{clara.rules}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>さらに <code>:build-options</code> <code>:cache-level</code> エントリを使用することで、キャッシュの量をより広範囲に制御することができます。サポートされているオプションは以下の通りです:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:all</code>
</td>
<td class="hdlist2">
<p>デフォルトでは、すべての CLJS ファイルがキャッシュされます。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:jars</code>
</td>
<td class="hdlist2">
<p>ライブラリからのファイルのみをキャッシュします。 つまり <code>.jar</code> ファイル内のソースファイル。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:off</code>
</td>
<td class="hdlist2">
<p>CLJSのコンパイル結果をキャッシュしない(最も遅いオプション)</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Compiling without Cache</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:build-options</span>
   {<span class="symbol">:cache-level</span> <span class="symbol">:off</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>キャッシュファイルはビルドごとに専用のディレクトリに保存されるので、ビルド間でキャッシュが共有されることはありません。id が <code>:app</code> のビルドは <code>:dev</code> キャッシュをディレクトリに格納します。</p>
</div>
<div class="listingblock">
<div class="title"><code>cljs/core.cljs</code> のキャッシュ場所</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">target/shadow-cljs/builds/app/dev/ana/cljs/core.cljs.cache.transit.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>デフォルトの <code>:cache-root</code> 設定は <code>target/shadow-cljs</code> で、すべてのキャッシュファイルをどこに書き込むかを制御します。これは全体に設定され、ビルドごとに設定できるわけではありません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:cache-root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.shadow-cljs</span><span class="delimiter">&quot;</span></span>
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}

<span class="comment">;; cache then goes to</span>
<span class="comment">;; .shadow-cljs/builds/app/dev/ana/cljs/core.cljs.cache.transit.json</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>キャッシュルート <code>:cache-root</code> は常にプロジェクトディレクトリからの相対パスですが、絶対パスを指定することもできます (例: <code>/tmp/shadow-cljs</code>)。</p>
</div>
</div>
<div class="sect2">
<h3 id="closure-defines"><a class="anchor" href="#closure-defines"></a><a class="link" href="#closure-defines">6.5. Closure Defines</a></h3>
<div class="paragraph">
<p>Closure ライブラリとコンパイラでは、基本的にコンパイル時の定数である変数を定義することができます。これらを使用してビルドの特定の機能を設定することができます。Closureコンパイラは <code>:advanced</code> 最適化を実行する際に定数として扱いますので、デッドコード除去パスでは完全にサポートされています。</p>
</div>
<div class="paragraph">
<p>コード内で定義することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">your.app</span>)

(goog-define VERBOSE <span class="predefined-constant">false</span>)

(<span class="keyword">when</span> VERBOSE
  (<span class="keyword">println</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>これはデフォルトで <code>your.app/VERBOSE</code> 変数を <code>false</code> に定義します。これにより <code>:advanced</code> のコンパイル時に <code>println</code> が削除されます。これを <code>:closure-defines</code> オプションで <code>true</code> に切り替えると <code>println</code> が有効になります。これは開発用にのみ行うことも、常に行うこともできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:modules</span> {<span class="symbol">:app</span> {<span class="symbol">:entries</span> [your.app]}}
   <span class="comment">;; to enable in development only</span>
   <span class="symbol">:dev</span> {<span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}}
   <span class="comment">;; to enable always</span>
   <span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}
   <span class="comment">;; you may also enable it for release as well</span>
   <span class="symbol">:release</span> {<span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}}
   }}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
"disabled" バリアントをデフォルトとして使用する方が一般的に安全です。変数 <code>:closure-defines</code> を設定するのを忘れた場合、ほとんどの場合、使用されるコードは少なくなりますが、多くはなりません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Closure Defines from the Closure Library</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>goog.DEBUG</code>: クロージャーライブラリはこれを多くの開発機能に利用します。 <code>shadow-cljs</code> は <code>release</code> ビルドでは自動的に <code>false</code> に設定します。</p>
</li>
<li>
<p><code>goog.LOCALE</code> は <code>goog.i18n.DateTimeFormat</code> のような特定のローカライゼーション機能を設定するために使用します。標準のロケール文字列を受け付け、デフォルトは <code>en</code> です。ほとんどすべてのロケールに対応しています。 <a href="https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimesymbols.js">こちら</a> および <a href="https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimesymbolsext.js">こちら</a> を参照ください。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="compiler-options"><a class="anchor" href="#compiler-options"></a><a class="link" href="#compiler-options">6.6. Compiler Options</a></h3>
<div class="paragraph">
<p>CLJSコンパイラはコードの生成方法に影響を与えるいくつかのオプションをサポートしています。ほとんどの場合 <code>shadow-cljs</code> は <code>:target</code> ごとにいくつかの良いデフォルト値を選択しますが、時々それらのいくつかを変更したくなるかもしれません。</p>
</div>
<div class="paragraph">
<p>これらはすべてビルド設定の <code>:compiler-options</code> キーの下にグループ化されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:fn-invoke-direct</span> <span class="predefined-constant">true</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>標準のClojureScript <a href="https://clojurescript.org/reference/compiler-options">コンパイラオプション</a> のほとんどは、デフォルトで有効になっているか、適用されていません。そのため、実際に効果があるものはほとんどありません。それらの多くは特定の <code>:target</code> タイプに固有のものであり、普遍的には適用されません (例えば <code>:compiler-options {:output-wrapper true}</code> は <code>:target :browser</code> にのみ関連しています)。</p>
</div>
<div class="paragraph">
<p>現在サポートされているオプションには以下のものがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:optimizations</code> は <code>:advanced</code>, <code>:simple</code>, <code>:whitespace</code> をサポートしており、デフォルトは <code>:advanced</code> です。 <code>:none</code> は開発時のデフォルトであり、手動で設定することはできません。 <code>release</code> に <code>:none</code> を指定しても動作しません。</p>
</li>
<li>
<p><code>:infer-externs</code> <code>:all</code>, <code>:auto</code>, <code>true</code> または <code>false</code>, デフォルトは <code>true</code> です。</p>
</li>
<li>
<p><code>:static-fns</code> (ブール値) デフォルトは <code>true</code> です。</p>
</li>
<li>
<p><code>:fn-invoke-direct</code> (ブール値) デフォルトは <code>false</code> です。</p>
</li>
<li>
<p><code>:elide-asserts</code> (ブール値) デフォルトは開発版では <code>false</code>, <code>release</code> ビルド版では <code>true</code> です。</p>
</li>
<li>
<p><code>:pretty-print</code> と <code>:pseudo-name</code> のデフォルトは <code>false</code> です。 <code>shadow-cljs release app --debug</code> を使うと、設定に触れずに一時的に両方を有効にすることができます。これは <code>release</code> ビルドで問題が発生したときに非常に便利です。</p>
</li>
<li>
<p><code>:source-map</code> (ブール値) デフォルトは開発中は <code>true</code> で <code>release</code> では <code>false</code> です。</p>
</li>
<li>
<p><code>:source-map-includes-sources-content</code> (ブール値) デフォルトは <code>true</code> で、ソースマップが <code>.map</code> ファイルに直接ソースを含めるかどうかを決定します。</p>
</li>
<li>
<p><code>:source-map-detail-level</code> <code>:all</code> または <code>:synmbols</code> (<code>:synmbols</code> は全体のサイズを少し小さくしますが、精度は少し落ちます)</p>
</li>
<li>
<p><code>:externs</code> pathのベクタです、デフォルトは <code>[]</code></p>
</li>
<li>
<p><code>:checked-arrays</code> (ブール値), デフォルトは <code>false</code></p>
</li>
<li>
<p><code>:anon-fn-naming-policy</code></p>
</li>
<li>
<p><code>:rename-prefix</code> and <code>:rename-prefix-namespace</code></p>
</li>
<li>
<p><code>:warnings</code> は <code>{warning-type true|false}</code> のマップとして使用します。 例えば 特定の警告をオフにするには <code>:warnings {:undeclared-var false}</code> とします。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>サポートされていない、または適用されないオプション</strong></p>
</div>
<div class="paragraph">
<p>全く効果がないオプションには以下のようなものがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:verbose</code> はビルド設定ではなく <code>shadow-cljs compile app --verbose</code> を実行することで制御されます。</p>
</li>
<li>
<p><code>:foreign-libs</code> and <code>:libs</code></p>
</li>
<li>
<p><code>:stable-names</code> は常に有効で、無効にすることはできません。</p>
</li>
<li>
<p><code>:install-deps</code></p>
</li>
<li>
<p><code>:source-map-path</code>, <code>:source-asset-path</code> and <code>:source-map-timestamp</code></p>
</li>
<li>
<p><code>:cache-analysis</code> は常に有効で、無効にすることはできません。</p>
</li>
<li>
<p><code>:recompile-dependents</code></p>
</li>
<li>
<p><code>:preamble</code></p>
</li>
<li>
<p><code>:hashbang</code> (<code>:node-script</code> ターゲットはこれをサポートしていますが、他のターゲットはこれをサポートしていません)</p>
</li>
<li>
<p><code>:compiler-stats</code> は詳細な情報を得るために <code>--verbose</code> を使用します。</p>
</li>
<li>
<p><code>:optimize-constants</code> は <code>release</code> ビルドに対して常に行われ、無効にすることはできません。</p>
</li>
<li>
<p><code>:parallel-build</code> は常に有効です</p>
</li>
<li>
<p><code>:aot-cache</code></p>
</li>
<li>
<p><code>:package-json-resolution</code> 代わりに <a href="#js-resolve">:js-options :resolve</a> を参照してください。</p>
</li>
<li>
<p><code>:watch-fn</code></p>
</li>
<li>
<p><code>:process-shim</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="warnigs-as-errors"><a class="anchor" href="#warnigs-as-errors"></a><a class="link" href="#warnigs-as-errors">6.6.1. Warnings as Errors</a></h4>
<div class="paragraph">
<p>ビルドを継続するのではなく、警告を表示してビルドを失敗させたいと思うことがあります (CI環境など)。コンパイラのオプション <code>:warnings-as-errors</code> を使って、この処理方法をカスタマイズすることができます。</p>
</div>
<div class="listingblock">
<div class="title">すべての警告をエラーとして扱う</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:warnings-as-errors</span> <span class="predefined-constant">true</span>}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">特定の警告のみを投げる</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:warnings-as-errors</span> #{<span class="symbol">:undeclared-var</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>可能性のある警告型キーワードのセットは、 <a href="https://github.com/clojure/clojurescript/blob/5ad96a8b3ae2e3616a19715ba9ba2471a36933a2/src/main/clojure/cljs/analyzer.cljc#L124-L163">こちら</a> を参照してください。</p>
</div>
<div class="listingblock">
<div class="title">特定の名前空間に対してのみ投げる</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:warnings-as-errors</span> {<span class="symbol">:ignore</span> #{some.ns some.library.*}
                                           <span class="symbol">:warnings-types</span> #{<span class="symbol">:undeclared-var</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:ignore</code> は名前空間を参照するシンボルのセットを取ります。直接一致か <code>.*</code> ワイルドカードのいずれかを使用することができます。<code>:warning-types</code> は上記と同じ機能を持ちますが、指定しない場合は無視された名前空間を除いてすべての警告を投げることになります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_output_language_options"><a class="anchor" href="#_output_language_options"></a><a class="link" href="#_output_language_options">6.7. Output Language Options</a></h3>
<div class="paragraph">
<p>デフォルトでは、生成された JS 出力は ES5 と互換性があり、すべての"新機能"は polyfills を使用して互換性のあるコードにトランスパイルされます。これは現在のところ最も安全なデフォルトであり、アクティブに使用されているほとんどのブラウザ (IE10+ を含む) をサポートしています。</p>
</div>
<div class="paragraph">
<p>よりモダンな環境にのみ配慮し、置換せずにオリジナルのコードを保持したい場合は、他の出力オプションを選択することができます (例: <code>node</code>, Chrome Extensions, &#8230;&#8203;.など)。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
これは主に <a href="#npm">npm</a> や <code>.js</code> ファイルを <a href="#classpath-js">classpath</a> からインポートした JS コードに影響を与えることに注意してください。CLJSは現在のところES5の出力のみを生成し、より高いオプションを設定しても影響を受けません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これは <code>:compiler-options</code> の <code>:output-feature-set</code> で設定できます。古い <code>:language-out</code> オプションは <code>:output-feature-set</code> に取って代わられたものなので、使用すべきではありません。</p>
</div>
<div class="paragraph">
<p>Supported options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:es3</code></p>
</li>
<li>
<p><code>:es5</code></p>
</li>
<li>
<p><code>:es6</code> - <code>class</code>, <code>const</code>, <code>let</code>, &#8230;&#8203;</p>
</li>
<li>
<p><code>:es7</code> - exponent <code>**</code> operator</p>
</li>
<li>
<p><code>:es8</code> - <code>async/await</code>, <code>generators</code>, object literals with spread, &#8230;&#8203;</p>
</li>
<li>
<p><code>:es-next</code> - all the features the Closure Compiler currently supports</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:script</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:main</span> foo.bar/main
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:output-feature-set</span> <span class="symbol">:es7</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これらのオプションに関するドキュメントは少しまばらで、ほとんどが <a href="https://github.com/google/closure-compiler/blob/master/src/com/google/javascript/jscomp/parsing/parser/FeatureSet.java">こちら</a> のコードに書かれています。</p>
</div>
</div>
<div class="sect2">
<h3 id="_conditional_reading"><a class="anchor" href="#_conditional_reading"></a><a class="link" href="#_conditional_reading">6.8. Conditional Reading</a></h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
この機能は <code>shadow-cljs</code> でのみ動作します。ClojureScriptプロジェクトによって公式に <a href="https://dev.clojure.org/jira/browse/CLJS-2396">rejected</a> されました。CLJSではまだ問題なくコンパイルできますが、公式ブランチ(`:cljs`など)でしか動作しません。いつかは <a href="https://groups.google.com/d/msg/clojure-dev/8YJJM8lJuQs/hR5_vUZPCQAJ">supported</a> になるかもしれませんが、今のところはそうではありません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> は <code>.cljc</code> ファイルに追加のリーダ機能を設定することができます。デフォルトでは <code>:clj</code>, <code>:cljs</code>, <code>:cljr</code> のために別々のコードを生成するためにリーダ条件式を使うことしかできません。しかし、多くの CLJS ビルドでは <code>:target</code> に基づいてどのコードを生成するかを選択することが望ましいです。</p>
</div>
<div class="paragraph">
<p>例: <code>npm</code> パッケージの中には <code>:browser</code> をターゲットにしたときにのみ動作するものもありますが <code>:node-script</code> ビルドでも使用したい <code>ns</code> があるかもしれません。これはReactアプリでサーバーサイドレンダリング(SSR)を使おうとしているときに頻繁に起こるかもしれません。 <code>codemirror</code> はそのようなパッケージの一つです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">codemirror</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> CodeMirror]))

<span class="comment">;; suppose you create a CodeMirror instance on some React :ref</span>
(<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
  (<span class="keyword">let</span> [cm (CodeMirror/fromTextArea dom-node <span class="error">#</span>js {<span class="keyword">..</span><span class="keyword">.</span>})]
    <span class="keyword">..</span><span class="keyword">.</span>))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>この名前空間は両方のビルド(<code>:node-script</code> と <code>:browser</code>)で正常にコンパイルされますが <code>:node-script</code> を実行しようとすると <code>codemirror</code> パッケージが DOM にアクセスしようとするので失敗します。 <code>react-dom/server</code> は refs を使わないので <code>init-cm</code> 関数は決して呼ばれません。</p>
</div>
<div class="paragraph">
<p><a href="#closure-defines">:closure-defines</a> を使って <code>init-cm</code> 関数を条件付きでコンパイルすることができますが、余分な <code>:require</code> を取り除くためには使えません。リーダー条件式を使えば、これを簡単に行うことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
 (<span class="symbol">:require</span>
   [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
   <span class="comment">;; 注意：ここでは順番が重要です。</span>
   <span class="comment">;; 最初の該当するブランチが使われます。</span>
   <span class="comment">;; もし :cljs が先に使われた場合は、 :server ビルドで取得されます</span>
   <span class="error">#</span>?@(<span class="symbol">:node</span> [[]]
       <span class="symbol">:cljs</span> [[<span class="string"><span class="delimiter">&quot;</span><span class="content">codemirror</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> CodeMirror]])))

<span class="error">#</span>?(<span class="symbol">:node</span> <span class="comment">;; node platform override</span>
   (<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
    <span class="symbol">:no-op</span>)
   <span class="symbol">:cljs</span> <span class="comment">;; default impl</span>
   (<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
     <span class="keyword">..</span><span class="keyword">.</span> actual impl <span class="keyword">..</span><span class="keyword">.</span>))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>:reader-feature</code> config examples</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 <span class="comment">;; アプリのビルドは正常に設定されており、調整は必要ありません</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="comment">;; サーバに :node reader機能を追加すると</span>
  <span class="comment">;; デフォルトの :cljs の代わりに使用されます</span>
  <span class="symbol">:server</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:compiler-options</span>
   {<span class="symbol">:reader-features</span> #{<span class="symbol">:node</span>}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで <code>:server</code> ビルドでは <code>codemirror</code> が不要になり <code>init-cm</code> 関数が削除されます。ただの</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]))

<span class="comment">;; これは、実際にはどこにも呼ばれなかった場合</span>
<span class="comment">;; デッドコードとして削除される可能性が高いでしょう</span>

(<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node] <span class="symbol">:no-op</span>)
<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
この機能は <code>.cljc</code> ファイルでのみ利用可能で <code>.cljs</code> ファイルでは失敗します。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="config-merge"><a class="anchor" href="#config-merge"></a><a class="link" href="#config-merge">6.9. Overriding from the CLI</a></h3>
<div class="paragraph">
<p><code>shadow-cljs.edn</code> の設定に静的に追加できない値や、環境によっては変更される可能性のある値をコマンドラインからビルド設定に小さな調整を加えることが望ましい場合があります。</p>
</div>
<div class="paragraph">
<p>追加の設定データを <code>--config-merge {:some "data"}</code> コマンドラインオプションで渡すことができます。CLIから追加されたデータは <code>shadow-cljs.edn</code> ファイルからのデータを上書きします。</p>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn` config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">CLIから <code>:output-dir</code> を上書きする</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs release app --config-merge '{:output-dir &quot;somewhere/else&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">CLIから <code>:closure-defines</code> を上書きする</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs release app --config-merge '{:closure-defines {your.app/DEBUG true}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>config-merge</code> は1つのEDNマップを想定しており、複数回使用することができるので、左から右にマージされます。追加されたデータはbuild-hooksからも見えます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
複数のビルドIDを指定すると、指定した全てのビルドにマージされます。 <code>shadow-cljs release frontend backend --config-merge '{:hello "world"}'</code> は両方に適用されます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="shadow-env"><a class="anchor" href="#shadow-env"></a><a class="link" href="#shadow-env">6.10. Using Environment Variables</a></h3>
<div class="paragraph">
<p>環境変数を使って <code>shadow-cljs.edn</code> の設定値を設定することは可能ですが、代わりに <code>--config-merge</code> を使うことを検討してください。どうしても環境変数を使わなければならない場合は <code>#shadow/env "FOO"</code> リーダータグで設定することができます。もっと短い <code>#env</code> を使うこともできます。</p>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn` config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:closure-defines</span> {your.app/URL <span class="error">#</span>shadow/env <span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span>}
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>また <code>#shadow/env</code> で使用できるフォームもいくつかサポートされています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span>shadow/env <span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span>
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span>]
<span class="comment">;; 環境変数が設定されていない場合にデフォルト値として使用されます</span>
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">default-value</span><span class="delimiter">&quot;</span></span>]
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span> <span class="symbol">:default</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">default-value</span><span class="delimiter">&quot;</span></span>]
<span class="comment">;; PORT 環境変数を整数に変換します</span>
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">PORT</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> <span class="symbol">:int</span> <span class="symbol">:default</span> <span class="integer">8080</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>サポートされる <code>:as</code> の強制力は <code>:int</code>, <code>:bool</code>, <code>:keyword</code>, <code>:symbol</code> です。与えられた <code>:default</code> の値は変換されず、すでに正しい型になっているものとみなされます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>shadow-cljs</code> プロセスが起動したときに使用された環境変数が使用されます。サーバプロセスが使用されている場合、その環境変数は他のコマンドで設定される可能性のある環境変数よりも優先して使用されます。これはほとんどの場合、開発中に関連していますが、混乱を招くかもしれません。 <code>config-merge</code> にはこの制限はありません。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="build-target-defaults"><a class="anchor" href="#build-target-defaults"></a><a class="link" href="#build-target-defaults">6.11. Build and Target defaults</a></h3>
<div class="paragraph">
<p>すべてのビルド、または特定のタイプのすべてのターゲットに使用されるデフォルト設定を使用することができます。</p>
</div>
<div class="paragraph">
<p>コンフィギュレーションのマージ順序は <code>:build-defaults</code> &#8594; <code>:target-defaults</code> &#8594; 実際のビルドコンフィグ &#8594; 追加コンフィグの順で上書きされます。</p>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn` config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:build-defaults</span>
 {<span class="symbol">:closure-defines</span>
   {your.app/VERBOSE <span class="predefined-constant">true</span>}}

 <span class="symbol">:target-defaults</span>
 {<span class="symbol">:browser</span>
   {<span class="symbol">:js-options</span>
     {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:global</span>
                         <span class="symbol">:global</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span>}}}}}

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この例では <code>:app</code> ターゲットは <code>:build-defaults</code> と <code>:browser</code> の <code>:target-defaults</code> の両方を継承します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
マージ順の後の設定は、以前の設定項目を上書きすることはできますが、削除することはできません。デフォルトが設定されている場合、それを削除するには、それを上書きするしかありません。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-browser"><a class="anchor" href="#target-browser"></a><a class="link" href="#target-browser">7. Targeting the Browser</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>browser</code> ターゲットはブラウザ環境で実行することを意図した出力を生成します。開発中はライブコードのリロード、REPL、CSSのリロードをサポートしています。 <code>release</code> の出力はClosureコンパイラによって <code>:advanced</code> の最適化が施されて最小化されます。</p>
</div>
<div class="paragraph">
<p>A basic browser configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/assets/app/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/assets/app/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}]}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_output_settings"><a class="anchor" href="#_output_settings"></a><a class="link" href="#_output_settings">7.1. Output Settings</a></h3>
<div class="paragraph">
<p>ブラウザ ターゲットは多くのファイルを出力し、それらすべてのためのディレクトリが必要です。これらのアセットを何らかのサーバーで提供する必要があり、Javascript の読み込みコードは、これらのアセットへのサーバー中心のパスを知る必要があります。指定する必要があるオプションは以下の通りです。</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:output-dir</code></dt>
<dd>
<p>すべてのコンパイラの出力に使用するディレクトリです。</p>
</dd>
<dt><code>:asset-path</code></dt>
<dd>
<p><strong>webサーバのルート</strong> から <code>:output-dir</code> にあるリソースまでの相対パス。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>エントリーポイントのjavascriptファイルと関連するすべてのJSファイルは <code>:output-dir</code> に現れます。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
各ビルドはそれ自身の :output-dir を必要とし、複数のビルドを同じディレクトリに置くことはできません。また、このディレクトリはそのビルドが独占的に所有していなければなりません。他のファイルを入れてはいけません。 <code>shadow-cljs</code> は何も削除しませんが、放っておいた方が安全です。コンパイルは開発中にメインのエントリーポイントjavascriptファイル以外にも多くのファイルを作成します: ソースマップ、オリジナルのソース、生成されたソースなどです。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>asset-path</code> は生成された javascript の中のモジュールの読み込みコードのパスに追加される接頭辞です。これにより、javascriptモジュールをWebサーバーのルートの特定のサブディレクトリに出力することができます。開発中の動的な読み込み (ホットコードの再読み込み) や本番環境 (コードの分割) では、ファイルを正しく見つけるためにこれが必要になります。</p>
</div>
<div class="paragraph">
<p>生成されたファイルをこのようにディレクトリとアセットパスに配置することで、他のアセット（画像やCSSなど）が偶然に衝突することなく、同じサーバー上に簡単に共存できるようになります。</p>
</div>
<div class="paragraph">
<p>例えば、URI <code>/x</code> を要求されたときにウェブサーバが <code>public/x</code> というフォルダを提供し、モジュールの <code>output-dir</code> が <code>public/assets/app/js</code> である場合、アセットパスは <code>/assets/app/js</code> でなければなりません。絶対的なアセットパスを使う必要はありませんが、それを強く推奨します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_modules"><a class="anchor" href="#_modules"></a><a class="link" href="#_modules">7.2. Modules</a></h3>
<div class="paragraph">
<p>モジュールはコンパイルされたソースがどのようにバンドルされ、最終的な <code>.js</code> がどのように生成されるかを設定します。各モジュールは Entry Namespace のリストを宣言し、その依存関係グラフを構築します。複数のモジュールを使用する場合は、最大量のコードがグラフの外側に移動するようにコードが分割されます。目標は、ブラウザが最初にロードしなければならないコードの量を最小限に抑え、残りのコードをオンデマンドでロードすることです。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
最初のうちは :modules をあまり気にしないでください。最初は1つのモジュールから始めて、後で分割してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>設定の <code>:modules</code> セクションは常にモジュールIDがキーとなるマップです。モジュールIDはJavascriptのファイル名を生成するためにも使われます。モジュール <code>:main</code> は <code>:output-dir</code> に <code>main.js</code> を生成します。</p>
</div>
<div class="paragraph">
<p>モジュールで利用可能なオプションは以下の通りです:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>このモジュールの出力コードの依存関係グラフのルートノードとして機能する名前空間。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:init-fn</code>
</td>
<td class="hdlist2">
<p>モジュールが最初にロードされたときに呼び出されるべき関数を指す完全修飾シンボル。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:depends-on</code>
</td>
<td class="hdlist2">
<p>このモジュールに必要なものをすべて搭載するためにロードしなければならない他のモジュールの名前です。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:prepend</code>
</td>
<td class="hdlist2">
<p>jsの出力の前に付加される文字列の内容。コメントや著作権表示などに便利です。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:append</code>
</td>
<td class="hdlist2">
<p>jsの出力に追加される文字列コンテンツ。コメントや著作権表示などに便利です。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:prepend-js</code>
</td>
<td class="hdlist2">
<p>Closureオプティマイザーで実行される有効なjavascriptを含むモジュールの出力に付加する文字列。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:append-js</code>
</td>
<td class="hdlist2">
<p>モジュールの出力に追加する文字列で、Closureオプティマイザーで実行される有効なjavascriptを含みます。</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows a minimum module configuration:</p>
</div>
<div class="listingblock">
<div class="title">Example :browser config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example :browser config with :init-fn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:init-fn</span> my.app/init}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> は <code>:entry</code> のコードエントリーポイントのルートセットから依存関係グラフを辿り、実際にコンパイルして出力に含めるために必要なすべてのものを見つけます。必要のない名前空間は含まれません。</p>
</div>
<div class="paragraph">
<p>上記の設定は <code>public/js/main.js</code> ファイルを作成します。開発中には、たくさんのファイルを含む <code>public/js/cljs-runtime</code> ディレクトリが追加されます。このディレクトリは <code>release</code> ビルドには必要ありません。</p>
</div>
</div>
<div class="sect2">
<h3 id="CodeSplitting"><a class="anchor" href="#CodeSplitting"></a><a class="link" href="#CodeSplitting">7.3. Code Splitting</a></h3>
<div class="paragraph">
<p>複数のモジュールを宣言するには、少しだけ静的な設定を追加する必要があります。これにより、コンパイラはモジュールがどのように相互に関連しているか、また後でどのようにモジュールをロードするかを把握することができます。</p>
</div>
<div class="paragraph">
<p>どのモジュールがどのモジュールに依存しているかを宣言する必要があります ( <code>:deined-on</code> を使って)。これをどのように構成するかは完全にあなたのニーズ次第であり、残念ながらすべてに当てはまる解決策はありません。</p>
</div>
<div class="paragraph">
<p>あなたが実際に異なるページを持つ伝統的なウェブサイトを持っているとします。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>www.acme.com</code> - ホームページ</p>
</li>
<li>
<p><code>www.acme.com/login</code> - ログインフォーム</p>
</li>
<li>
<p><code>www.acme.com/protected</code> - ログインしていないと利用できない保護されたセクション</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このための良い構成の一つは、各ページに1つずつ全てのページで共有される共通モジュールを持つことでしょう</p>
</div>
<div class="listingblock">
<div class="title">Example config with multiple ':modules'</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
 <span class="symbol">:modules</span>
 {<span class="symbol">:shared</span>
  {<span class="symbol">:entries</span> [my.app.common]}
  <span class="symbol">:home</span>
  {<span class="symbol">:entries</span> [my.app.home]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
  <span class="symbol">:login</span>
  {<span class="symbol">:entries</span> [my.app.login]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
  <span class="symbol">:protected</span>
  {<span class="symbol">:entries</span> [my.app.protected]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<code>shared</code> モジュールの <code>:entries</code> を空のままにしておくと、コンパイラが他のモジュール間でどの名前空間が共有されているかを把握できるようになります。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Generated file structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
└── public
    └── js
        ├── shared.js
        ├── home.js
        ├── login.js
        └── protected.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>ホームページ用のHTMLには常に <code>shared.js</code> を各ページに、その他のページにはユーザーがどのページにいるかに応じて条件付きで含めることになります。</p>
</div>
<div class="listingblock">
<div class="title">'/login' のHTML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/shared.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/login.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>.js</code> ファイルは正しい順序でインクルードしなければなりません。<a href="#BrowserManifest"><code>manifest.edn</code></a>がこれを助けてくれます。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_loading_code_dynamically"><a class="anchor" href="#_loading_code_dynamically"></a><a class="link" href="#_loading_code_dynamically">7.3.1. Loading code dynamically</a></h4>
<div class="paragraph">
<p>最近ではシングルページアプリ(SPA)が人気を集めていますが、似たような働きをしています。</p>
</div>
<div class="sect4">
<h5 id="_using_shadow_cljs_s_built_in_loader_support"><a class="anchor" href="#_using_shadow_cljs_s_built_in_loader_support"></a><a class="link" href="#_using_shadow_cljs_s_built_in_loader_support">Using shadow-cljs&#8217;s built-in Loader Support</a></h5>
<div class="paragraph">
<p>コンパイラは <code>shadow.loader</code> ユーティリティの名前空間を使用するために必要なデータの生成をサポートしています。これは、実行時にモジュールをオンデマンドでロードできるようにするためのシンプルなインターフェースを公開しています。</p>
</div>
<div class="paragraph">
<p>ビルド設定に <code>:module-loader true</code> を追加するだけです。ローダは常にデフォルトのモジュール (他のすべてのものが依存するモジュール) に注入されます。</p>
</div>
<div class="paragraph">
<p>実行時には <code>shadow.loader</code> 名前空間を使ってモジュールをロードすることができます。また、ページ内で <code>&lt;script&gt;</code> タグを使用するだけで、積極的にモジュールをロードすることもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:module-loader</span> <span class="predefined-constant">true</span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>メインのエントリーポイントに以下のようなものがあったとします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [shadow.loader <span class="symbol">:as</span> loader]))

(<span class="keyword">defn</span> <span class="function">fn-to-call-on-load</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">extra loaded</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> <span class="function">fn-to-call-on-error</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">extra load failed</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>そうすると、以下のような式でコードをロードすることができます。</p>
</div>
<div class="listingblock">
<div class="title">Loading a module</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; loadはgoog.async.Deferredを返し、promiseのように使うことができます。</span>
(<span class="keyword">-&gt;</span> (loader/load <span class="string"><span class="delimiter">&quot;</span><span class="content">extra</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">.</span>then fn-to-call-on-load fn-to-call-on-error))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Loading many modules</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; 引数はJS配列でなければなりませんがgoog.async.Deferredが返ります。</span>
(loader/load-many <span class="error">#</span>js [<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Including a callback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(loader/with-module <span class="string"><span class="delimiter">&quot;</span><span class="content">extra</span><span class="delimiter">&quot;</span></span> fn-to-call-on-load)</code></pre>
</div>
</div>
<div class="paragraph">
<p>モジュールがロードされているかどうかは <code>(loaded? "module-name")</code> で確認できます。</p>
</div>
<div class="sect5">
<h6 id="_loader_costs"><a class="anchor" href="#_loader_costs"></a><a class="link" href="#_loader_costs">Loader Costs</a></h6>
<div class="paragraph">
<p>ローダの使用は非常に軽量です。ローダにはいくつかの依存関係がありますが、他の方法では使用しないかもしれません。実際には <code>:module-loader true</code> を使うと、デフォルトのモジュールに約8KBのgzipが追加されます。これは <code>goog.net</code> や <code>goog.event</code> をどの程度使用しているか、また、リリースビルドにどの程度の最適化を使用しているかによって異なります。</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_the_standard_clojurescript_api"><a class="anchor" href="#_using_the_standard_clojurescript_api"></a><a class="link" href="#_using_the_standard_clojurescript_api">Using the Standard ClojureScript API</a></h5>
<div class="paragraph">
<p>生成されたコードは標準のClojureScript <code>cljs.loader</code> APIを使用することができます。説明はClojureScriptのウェブサイトの <a href="https://clojurescript.org/news/2017-07-10-code-splitting">ドキュメンテーション</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>標準APIを使用する利点は、あなたのコードが他の人とうまく連携できることです。これはライブラリの作者にとって特に重要かもしれません。不利な点は、標準ディストリビューションの動的モジュールロードAPIが <code>shadow-cljs</code> のサポートに比べて、現在のところ使い勝手がやや悪いことです。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="output-wrapper"><a class="anchor" href="#output-wrapper"></a><a class="link" href="#output-wrapper">7.4. Output Wrapper</a></h3>
<div class="paragraph">
<p><strong>リリースビルドのみ</strong>: Closureコンパイラの <code>:advanced</code> コンパイルによって生成されたコードは、多くのグローバル変数を生成し、ページ内で実行されている他のJSとの競合を引き起こす可能性があります。作成された変数を分離するには、コードを匿名関数でラップして、そのスコープ内でのみ適用される変数にすることです。</p>
</div>
<div class="paragraph">
<p><code>release</code> はデフォルトでは <code>:browser</code> のビルドで <code>:modules</code> が1つしかない場合は <code>(function(){&lt;コード&gt;}).call(this);</code> でラップされているので、グローバル変数は生成されません。そのため、グローバル変数は生成されません。</p>
</div>
<div class="paragraph">
<p>複数の <code>:modules</code> (別名 <a href="#CodeSplitting">code splitting</a>) を使用する場合、これはデフォルトでは有効になっていません。Closureコンパイラは <code>:rename-prefix-namespace</code> という名前の複数の <code>:modules</code> と組み合わせて出力ラッパーを使用できるようにする追加オプションをサポートしています。これによりコンパイラーはビルドで使用される全ての「グローバル」変数を1つの実際のグローバル変数にスコープするようになります。デフォルトでは <code>:output-wrapper</code> が <code>true</code> に設定されている場合、これは <code>:remame-prefix-namespace "$APP"</code> に設定されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:target</span> <span class="symbol">:browser</span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:compiler-options</span>
  {<span class="symbol">:output-wrapper</span> <span class="predefined-constant">true</span>
   <span class="symbol">:rename-prefix-namespace</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">MY_APP</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは <code>MY_APP</code> グローバル変数を作成するだけです。すべての「global」変数の前に <code>MY_APP.</code> が付くようになったので (例えば <code>a</code> だけではなく <code>MY_APP.a</code>)、コードサイズは大幅に大きくなる可能性があります。これを短くしておくことが重要です。ブラウザ圧縮(例: <code>gzip</code>)は、余分なコードのオーバーヘッドを減らすのに役立ちますが、ビルド中のグローバル変数の量によっては、コードサイズが顕著に増加する可能性があります。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
作成された変数は、実際には直接役立つものではないことに注意してください。この変数には、多くのmunged/minifiedされたプロパティが含まれています。すべてのエクスポートされた変数(例: <code>^:export</code>)はグローバルスコープにエクスポートされ、この設定の影響を受けません。この設定は、作成されるグローバル変数の量を制限するのに役立つだけで、他には何もありません。直接使用しないでください。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_web_workers"><a class="anchor" href="#_web_workers"></a><a class="link" href="#_web_workers">7.5. Web Workers</a></h3>
<div class="paragraph">
<p>また <code>:modules</code> 設定は、ウェブワーカーとして利用することを意図したファイルを生成するためにも利用できる。任意のモジュールをウェブワーカーとして宣言するには <code>:web-worker true</code> を設定します。生成されたファイルには、依存関係を自動的にロードする追加のブートストラップコードが含まれます。モジュールが動作する方法は、ワーカーによってのみ使用されるコードが、ワーカーの最終ファイルにのみ存在することを保証します。各ワーカーは専用のCLJS名前空間を持つべきです。</p>
</div>
<div class="listingblock">
<div class="title">ウェブワーカースクリプトの生成例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:modules</span>
   {<span class="symbol">:shared</span>
    {<span class="symbol">:entries</span> []}
    <span class="symbol">:main</span>
    {<span class="symbol">:init-fn</span> my.app/init
     <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
    <span class="symbol">:worker</span>
    {<span class="symbol">:init-fn</span> my.app.worker/init
     <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}
     <span class="symbol">:web-worker</span> <span class="predefined-constant">true</span>}}
   }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記の設定により <code>worker.js</code> が生成され、これを使ってウェブワーカーを起動することができます。これには <code>:shared</code> モジュールのすべてのコードが含まれています (ただし <code>:main</code> は含まれていません)。名前空間 <code>my.app.worker</code> のコードはワーカー内でのみ実行されます。ワーカーの生成は開発モードとリリースモードの両方で行われます。</p>
</div>
<div class="paragraph">
<p><code>shared</code> モジュールの空の <code>:entries []</code> は <code>:main</code> と <code>:worker</code> モジュール間で共有されているすべてのコードを収集するようにすることに注意してください。</p>
</div>
<div class="listingblock">
<div class="title">Sample echo worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app.worker</span>)

(<span class="keyword">defn</span> <span class="function">init</span> []
  (js/self.addEventListener <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>
    (<span class="keyword">fn</span> [^js e]
      (js/postMessage (<span class="keyword">..</span> e -data)))))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample using the worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> <span class="function">init</span> []
  (<span class="keyword">let</span> [worker (js/Worker. <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/worker.js</span><span class="delimiter">&quot;</span></span>)]
    (<span class="keyword">..</span> worker (addEventListener <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [e] (js/console.log e))))
    (<span class="keyword">..</span> worker (postMessage <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
これで <code>:shared</code> モジュールができたので、それを HTML で適切にロードする必要があります。<code>main.js</code> を読み込んだだけではエラーが発生します。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">HTML Loading shared.js and main.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">&lt;script src<span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">/js/shared.js</span><span class="delimiter">&quot;</span></span>&gt;&lt;/script&gt;
&lt;script src<span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">/js/main.js</span><span class="delimiter">&quot;</span></span>&gt;&lt;/script&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cacheable_output"><a class="anchor" href="#_cacheable_output"></a><a class="link" href="#_cacheable_output">7.6. Cacheable Output</a></h3>
<div class="paragraph">
<p>ウェブ設定では、余計なリクエストを避けるために <code>.js</code> ファイルを非常に長い間キャッシュしておくことが望ましいです。一般的には、リリースされたバージョンごとに <code>.js</code> ファイルに一意の名前を生成します。これにより、アクセスに使用するURLが変更されるため、永遠にキャッシュしても安全です。</p>
</div>
<div class="sect3">
<h4 id="release-version"><a class="anchor" href="#release-version"></a><a class="link" href="#release-version">7.6.1. Release Versions</a></h4>
<div class="paragraph">
<p>各リリースに固有のファイル名を作成するには <code>:release-version</code> の設定で行うことができます。通常はコマンドラインから <a href="#config-merge">--config-merge</a> で指定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">shadow-cljs release app --config-merge '{<span class="symbol">:release-version</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example :modules config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより、通常の <code>main.js</code> と <code>extra.js</code> の代わりに <code>public/js</code> に <code>main.v1.js</code> と <code>extra.v1.js</code> のファイルが作成されます。</p>
</div>
<div class="paragraph">
<p>手動のバージョンを使うこともできますし、ビルド時に <code>git</code> sha のような自動化されたものを使うこともできます。ただ、キャッシュを使うとユーザは古いファイルの新しいバージョンを要求しないためユーザに何かを出荷したら、それが何であれ弾き上げるようにしてください。</p>
</div>
</div>
<div class="sect3">
<h4 id="NameHashing"><a class="anchor" href="#NameHashing"></a><a class="link" href="#NameHashing">7.6.2. Filenames with Fingerprint-Hash</a></h4>
<div class="paragraph">
<p>ビルド設定に <code>:module-hash-names true</code> を追加することで、生成された各出力モジュールファイルの MD5 シグネチャを自動的に作成することができます。これは <code>:main</code> モジュールがデフォルトの <code>main.js</code> の代わりに <code>main.&lt;md5hash&gt;.js</code> を生成することを意味します。</p>
</div>
<div class="paragraph">
<p><code>:module-hash-names true</code> の場合モジュールハッシュの長さが32で完全なmd5ハッシュを含んでいることになります。もし短い方が良い場合は、代わりに1-32の間の数字を指定することができます (例: <code>module-hash-name 8</code>)。ハッシュを短くすると競合が発生する可能性が高くなることに注意してください。完全なハッシュを使うことをお勧めします。</p>
</div>
<div class="listingblock">
<div class="title">Example :module-hash-names config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:module-hash-names</span> <span class="predefined-constant">true</span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これまでの <code>main.js</code> の代わりに <code>:output-dir</code> に <code>main.&lt;hash&gt;.js</code> を生成するようになりました。</p>
</div>
<div class="paragraph">
<p>リリースごとにファイル名が変わることがあるので、HTMLに含めるのは少し複雑になります。 <a href="#BrowserManifest">Output Manifest</a>がそれを助けてくれます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="BrowserManifest"><a class="anchor" href="#BrowserManifest"></a><a class="link" href="#BrowserManifest">7.7. Output Manifest</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> は <code>:output-dir</code> に <code>manifest.edn</code> ファイルを生成します。このファイルにはモジュールの設定の説明と、元のモジュール名を実際のファイル名にマップする追加の <code>:output-name</code> プロパティが含まれています (<code>:module-hash-names</code> 機能を使うときに重要です)。</p>
</div>
<div class="listingblock">
<div class="title">ハッシュ化されたファイル名を使用した場合の manifest.edn の出力サンプル。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:module-id</span> <span class="symbol">:common</span>,
  <span class="symbol">:name</span> <span class="symbol">:common</span>,
  <span class="symbol">:output-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">common.15D142F7841E2838B46283EA558634EE.js</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:entries</span> [<span class="keyword">..</span><span class="keyword">.</span>],
  <span class="symbol">:depends-on</span> #{},
  <span class="symbol">:sources</span> [<span class="keyword">..</span><span class="keyword">.</span>]}
 {<span class="symbol">:module-id</span> <span class="symbol">:page-a</span>,
  <span class="symbol">:name</span> <span class="symbol">:page-a</span>,
  <span class="symbol">:output-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">page-a.D8844E305644135CBD5CBCF7E359168A.js</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:entries</span> [<span class="keyword">..</span><span class="keyword">.</span>],
  <span class="symbol">:depends-on</span> #{<span class="symbol">:common</span>},
  <span class="symbol">:sources</span> [<span class="keyword">..</span><span class="keyword">.</span>]}
 <span class="keyword">..</span><span class="keyword">.</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>マニフェストには、依存関係の順に並べ替えられたすべての <code>:modules</code> が含まれています。これを使って <code>:module-id</code> を実際に生成されたファイル名にマップすることができます。</p>
</div>
<div class="paragraph">
<p>開発ビルドでもこのファイルが生成されますので、新しいビルドが完了したときに変更があるかどうかを確認することができます。開発中は <code>:module-hash-names</code> は適用されないので、通常のファイル名を取得します。</p>
</div>
<div class="paragraph">
<p>生成されるマニフェストファイルの名前は <code>:build-options :manifest-name</code> エントリで設定できます。デフォルトは <code>manifest.edn</code> です。ファイル名の末尾に <code>.json</code> を指定した場合、出力は EDN ではなく JSON になります。ファイルは設定された <code>:output-dir</code> からの相対的なものになります。</p>
</div>
<div class="listingblock">
<div class="title">Example manifest.json config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:build-options</span> {<span class="symbol">:manifest-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">manifest.json</span><span class="delimiter">&quot;</span></span>}
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development_support"><a class="anchor" href="#_development_support"></a><a class="link" href="#_development_support">7.8. Development Support</a></h3>
<div class="paragraph">
<p><code>:browser</code> の設定の <code>:devtools</code> セクションは、ビルドや CSS のリロードのためにオプションの dev-time HTTP サーバを設定するためのいくつかの追加オプションをサポートしています。</p>
</div>
<div class="sect3">
<h4 id="hud"><a class="anchor" href="#hud"></a><a class="link" href="#hud">7.8.1. Heads-Up Display (HUD)</a></h4>
<div class="paragraph">
<p><code>:browser</code> ターゲットはビルドが開始されたときにロードインディケータを表示するために HUD を使用するようになりました。また、警告やエラーがあれば表示されます。</p>
</div>
<div class="paragraph">
<p>これを完全に無効にするには <code>:devtools</code> セクションで <code>:hud false</code> を設定します。</p>
</div>
<div class="paragraph">
<p>また <code>:hud #{:errors :warnings}</code> を設定することで、気になる機能を指定して、特定の機能を切り替えることもできます。これにより、エラーや警告は表示されますが、進捗状況は表示されません。利用可能なオプションは <code>:errors</code>, <code>:warnings</code>, <code>:progress</code> です。含まれるオプションのみが有効になり、それ以外はすべて無効になります。</p>
</div>
<div class="sect4">
<h5 id="open-file-command"><a class="anchor" href="#open-file-command"></a><a class="link" href="#open-file-command">Opening Files</a></h5>
<div class="paragraph">
<p>警告にはソースの場所へのリンクが含まれており、クリックするとエディタでファイルを開くことができます。このためには少しの設定が必要です。</p>
</div>
<div class="paragraph">
<p>この設定は、プロジェクトの <code>shadow-cljs.edn</code> の設定で行うか、ホームディレクトリの <code>~/.shadow-cljs/config.edn</code> の下にあるグローバルな設定で行うことができます。</p>
</div>
<div class="listingblock">
<div class="title"><code>:open-file-command</code> configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:open-file-command</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">idea</span><span class="delimiter">&quot;</span></span> <span class="symbol">:pwd</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">--line</span><span class="delimiter">&quot;</span></span> <span class="symbol">:line</span> <span class="symbol">:file</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>open-file-command</code> は非常に単純なDSLを表すベクトルを期待します。文字列はそのまま保持され、キーワードはそれぞれの値に置き換えられます。複数のパラメータを組み合わせる必要がある場合は <code>clojure.core/format</code> スタイルのパターンを使って、入れ子になったベクトルを使うことができます。</p>
</div>
<div class="paragraph">
<p>上記の例では、次のように実行されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ idea /path/to/project-root --line 3 /path/to/project-root/srv/main/demo/foo.cljs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>emacsclient</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:open-file-command</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">emacsclient</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-n</span><span class="delimiter">&quot;</span></span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">+%s:%s</span><span class="delimiter">&quot;</span></span> <span class="symbol">:line</span> <span class="symbol">:column</span>] <span class="symbol">:file</span>]}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ emacsclient -n +3:1 /path/to/project-root/srv/main/demo/foo.cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>利用可能な置換変数は以下の通りです:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:pwd</code></dt>
<dd>
<p>プロセス作業ディレクトリ (別名プロジェクトルート)</p>
</dd>
<dt><code>:file</code></dt>
<dd>
<p>ファイルの絶対パス</p>
</dd>
<dt><code>:line</code></dt>
<dd>
<p>警告/エラーの行番号</p>
</dd>
<dt><code>:column</code></dt>
<dd>
<p>カラム番号</p>
</dd>
<dt><code>:wsl-file</code></dt>
<dd>
<p>WSLファイルのパスを変換したもの。WSL Bashで <code>shadow-cljs</code> を実行するときに便利。<code>/mnt/c/Users/someone/code/project/src/main/demo/foo.cljs</code> のパスを <code>C:\Users...</code> に変換します。</p>
</dd>
<dt><code>:wsl-pwd</code></dt>
<dd>
<p><code>:pwd</code> を変換したもの</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_css_reloading"><a class="anchor" href="#_css_reloading"></a><a class="link" href="#_css_reloading">7.8.2. CSS Reloading</a></h4>
<div class="paragraph">
<p>また、ブラウザのdevtoolsは、あなたのためにCSSをリロードすることができます。これはデフォルトで有効になっており、組み込みの <a href="#dev-http">development HTTP servers</a> を使用している場合は、ほとんどの場合、追加の設定は必要ありません。</p>
</div>
<div class="paragraph">
<p>ページに含まれるスタイルシートは、ファイルシステム上で変更されるとリロードされます。絶対パスの使用を推奨しますが、相対パスも同様に動作します。</p>
</div>
<div class="listingblock">
<div class="title">Example HTML snippet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/css/main.css</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Hiccup since we aren&#8217;t savages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[<span class="symbol">:link</span> {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/css/main.css</span><span class="delimiter">&quot;</span></span>}]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using the built-in dev HTTP server</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これにより <code>public/css/main.css</code> が変更されたときにブラウザが <code>/css/main.css</code> をリロードするようになります。</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> は現在のところ CSS の直接コンパイルをサポートしていませんが、通常のツールは動作しますので、別途実行する必要があります。ただ、出力が正しい場所に生成されることを確認してください。</p>
</div>
<div class="paragraph">
<p>組み込みのHTTPサーバを使用していない場合は、代わりに <code>:watch-dir</code> を指定することができます。</p>
</div>
<div class="listingblock">
<div class="title">Example :watch-dir config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
    {<span class="symbol">:builds</span>
      {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
             <span class="symbol">:devtools</span> {<span class="symbol">:watch-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>HTTP サーバが仮想ディレクトリからファイルを提供していて、ファイルシステムのパスが HTML で使われているパスと正確に一致しない場合は <code>:watch-path</code> を設定することでパスを調整することができます。</p>
</div>
<div class="listingblock">
<div class="title">例 <code>public/css/main.css</code> が <code>/foo/css/main.css</code> の下に提供されている場合</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 {<span class="symbol">:builds</span>
  {<span class="symbol">:app</span>
   {<span class="keyword">..</span><span class="keyword">.</span>
    <span class="symbol">:devtools</span> {<span class="symbol">:watch-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
               <span class="symbol">:watch-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/foo</span><span class="delimiter">&quot;</span></span>}}}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proxy-support"><a class="anchor" href="#proxy-support"></a><a class="link" href="#proxy-support">7.8.3. Proxy Support</a></h4>
<div class="paragraph">
<p>デフォルトでは、devtools クライアントは設定された <a href="#http">HTTP server</a> (通常は <code>localhost</code>) を介して <code>shadow-cljs</code> プロセスに接続しようとします。リバースプロキシを使って HTML を提供している場合は、それができないかもしれません。どのURLを使うかは <code>:devtools-url</code> で設定することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:before-load</span>  my.app/stop
                   <span class="symbol">:after-load</span>   my.app/start
                   <span class="symbol">:devtools-url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://some.host/shadow-cljs</span><span class="delimiter">&quot;</span></span>
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> はリクエストを行う際に <code>:devtools-url</code> をベースにします。これは最終的な URL ではないので、設定したパス (例えば <code>/shadow-cljs/*</code>) で始まるすべてのリクエストが <code>shadow-cljs</code> が動作しているホストに転送されるようにしなければなりません。</p>
</div>
<div class="listingblock">
<div class="title">Incoming Request to Proxy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">https://some.host/shadow-cljs/ws/foo/bar?asdf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">must forward to</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">http<span class="symbol">://localhost</span><span class="error">:</span><span class="integer">9630</span>/foo/bar?asdf</code></pre>
</div>
</div>
<div class="paragraph">
<p>クライアントは、ファイルをロードするために通常の XHR 要求と同様に WebSocket 要求を行います。プロキシが適切に WebSocket をアップグレードしていることを確認してください。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
リクエストは、ビルド自体で設定されたものではなく、メインの <a href="#http">HTTP server</a> に転送されなければなりません。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-react-native"><a class="anchor" href="#target-react-native"></a><a class="link" href="#target-react-native">8. Targeting React Native</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>:target :react-native</code> は、デフォルトの <code>react-native</code> ツール (例: <code>metro</code>) に統合するコードを生成します。これらのツールをラップする <code>expo</code> のようなツールは自動的に動作し、追加の設定は必要ありません。</p>
</div>
<div class="paragraph">
<p>他のターゲット (<code>:source-paths</code> のようなもの) と同じ基本的な <a href="#config">main configuration</a> が必要ですが、ビルド固有の設定は非常に最小限で、少なくとも 2 つのオプションが必要です (<code>:target</code> 自体の他に)。</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:init-fn</code>
</td>
<td class="hdlist2">
<p>(必須)。アプリのinit関数の名前空間修飾シンボル。この関数は起動時に一度だけ呼び出され、おそらく何かをレンダリングする必要があります。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(必須)。出力ファイルの書き込みに使用するディレクトリ。</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample :react-native config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:react-native</span>
   <span class="symbol">:init-fn</span> demo.app/init
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コンパイルすると <code>app/index.js</code> ファイルが生成され、これは <code>react-native</code> ツールのエントリーポイントとして使用されることを意図しています。開発中の <code>:output-dir</code> にはさらに多くのファイルが含まれますが、生成された <code>app/index.js</code> だけを直接参照するようにしてください。 <code>release</code> ビルドでは最適化された <code>app/index.js</code> が生成されるだけで、追加のファイルは必要ありません。</p>
</div>
<div class="sect2">
<h3 id="_react_native"><a class="anchor" href="#_react_native"></a><a class="link" href="#_react_native">8.1. React Native</a></h3>
<div class="paragraph">
<p><code>react-native`を使うには2つの方法があり、ネイティブコードやライブラリを使えるプレーンな `react-native</code> と <a href="https://expo.io/">expo</a> でラップされたもの(後述)です。上記のすべてのステップを踏めば、プレーンな <code>react-native</code> で shadow-cljs を使い始めることができます。この例のリポジトリを参照してください:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/thheller/reagent-react-native" class="bare">https://github.com/thheller/reagent-react-native</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_expo"><a class="anchor" href="#_expo"></a><a class="link" href="#_expo">8.2. Expo</a></h3>
<div class="paragraph">
<p><a href="https://expo.io/">expo</a> を使うと <code>react-native</code> を使うのがとても簡単になります。提供されている設定例は2つあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/thheller/fulcro-expo" class="bare">https://github.com/thheller/fulcro-expo</a></p>
</li>
<li>
<p><a href="https://github.com/thheller/reagent-expo" class="bare">https://github.com/thheller/reagent-expo</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>どちらの例も <code>expo init &#8230;&#8203;</code> を使って生成されたもので、設定の変更点は生成された <code>app.json</code> に適切な <code>entryPoint</code> を追加することだけでした。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{
  <span class="string"><span class="delimiter">&quot;</span><span class="content">expo</span><span class="delimiter">&quot;</span></span><span class="error">:</span> {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span><span class="error">:</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello-world</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">slug</span><span class="delimiter">&quot;</span></span><span class="error">:</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">reagent-expo</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">..</span><span class="keyword">.</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">entryPoint</span><span class="delimiter">&quot;</span></span><span class="error">:</span><span class="string"><span class="delimiter">&quot;</span><span class="content">./app/index.js</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">..</span><span class="keyword">.</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは手動で行うこともできますが <code>shadow.expo/render-root</code> 関数を使用することで行うこともでき、代わりにReact Elementのインスタンスがレンダリングを開始することを直接期待できます。</p>
</div>
<div class="listingblock">
<div class="title">From the Reagent &lt;a href="https://github.com/thheller/reagent-expo/blob/2c73ed0513a8f5050b250c0c7e53b9ae7543cee9/src/main/test/app.cljs#L34-L40"&gt;example&lt;/a&gt;</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">start</span>
  {<span class="symbol">:dev/after-load</span> <span class="predefined-constant">true</span>}
  []
  (expo/render-root (r/as-element [root])))

(<span class="keyword">defn</span> <span class="function">init</span> []
  (start))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>init</code> は起動時に一度だけ呼び出されます。この例では特別な設定をする必要がないので <code>start</code> を直接呼び出すだけです。 <code>start</code> は <code>watch</code> が実行されているときには、コードの変更がリロードされた後、毎回繰り返し呼び出されます。 <code>reagent.core/as-element</code> 関数は、試薬のHiccup markupから必要なReact要素を生成するために利用できます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-node"><a class="anchor" href="#target-node"></a><a class="link" href="#target-node">9. Targeting node.js</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>スタンドアロンスクリプトとして使用することを目的としたコードや、ライブラリとして使用することを目的としたコードの生成をビルトインでサポートしています。設定ファイルに必要な基本設定については、 <a href="#config">common configuration</a> の項を参照してください。</p>
</div>
<div class="sect2">
<h3 id="target-node-script"><a class="anchor" href="#target-node-script"></a><a class="link" href="#target-node-script">9.1. node.js Scripts</a></h3>
<div class="paragraph">
<p><code>:target :node-script</code> はシングルファイルのスタンドアロン出力を生成し <code>node.js</code> を使って実行できます。コードはClojureScriptだけで、エントリポイントの定義も簡単です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.script</span>)

(<span class="keyword">defn</span> <span class="function">main</span> [&amp; cli-args]
  (<span class="keyword">prn</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_build_options"><a class="anchor" href="#_build_options"></a><a class="link" href="#_build_options">9.1.1. Build Options</a></h4>
<div class="paragraph">
<p>他のターゲット (<code>:source-paths</code> など) と同じ基本的な <a href="#config">main configuration</a> が必要ですが、いくつかのノード固有のビルドターゲットオプションが必要になります:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:main</code>
</td>
<td class="hdlist2">
<p>(必須)。スクリプトのエントリポイント関数の名前空間修飾シンボル。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>(必須)。生成されたスクリプトのパスとファイル名。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(オプション)。開発モードでサポートするファイルのパス。デフォルトはキャッシュディレクトリです。</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample node script build</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:script</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:main</span> demo.script/main
   <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/demo-script/script.js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コンパイルすると、これはスタンドアロンの <code>out/demo-script/script.js</code> ファイルになり <code>node script.js &lt;command line args&gt;</code> から呼び出されることを意図しています。実行すると、起動時に <code>(demo.script/main &lt;command line args&gt;)</code> 関数が呼び出されます。これは <code>:output-to</code> で指定されたファイルのみを生成します。その他のサポートファイル(開発モード用など)は、一時的なサポートディレクトリに書き込まれます。</p>
</div>
</div>
<div class="sect3">
<h4 id="NodeHotCodeReload"><a class="anchor" href="#NodeHotCodeReload"></a><a class="link" href="#NodeHotCodeReload">9.1.2. Hot Code Reload</a></h4>
<div class="paragraph">
<p>サーバーやその他の長時間稼働するプロセスとして動作するスクリプトを書くことが多いでしょう。ホットコードリロードはこれらの作業を行う際に非常に便利で、設定も簡単です:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>start/stop コールバック関数を追加します。</p>
</li>
<li>
<p>これらのフックを使用するビルドを設定します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ここではnode内のhttpサーバの例を示します:</p>
</div>
<div class="listingblock">
<div class="title">ホットコードのリロードのための satrt/stop フックを持つサンプルノードスクリプト。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.script</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> http]))

(<span class="keyword">defn</span> <span class="function">request-handler</span> [req res]
  (<span class="keyword">.</span>end res <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>))

<span class="comment">; a place to hang onto the server so we can stop/start it</span>
(<span class="keyword">defonce</span> <span class="function">server-ref</span>
  (volatile! <span class="predefined-constant">nil</span>))

(<span class="keyword">defn</span> <span class="function">main</span> [&amp; args]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">starting server</span><span class="delimiter">&quot;</span></span>)
  (<span class="keyword">let</span> [server (http/createServer #(request-handler %1 %2))]

    (<span class="keyword">.</span>listen server <span class="integer">3000</span>
      (<span class="keyword">fn</span> [err]
        (<span class="keyword">if</span> err
          (js/console.error <span class="string"><span class="delimiter">&quot;</span><span class="content">server start failed</span><span class="delimiter">&quot;</span></span>)
          (js/console.info <span class="string"><span class="delimiter">&quot;</span><span class="content">http server running</span><span class="delimiter">&quot;</span></span>))
        ))

    (vreset! server-ref server)))

(<span class="keyword">defn</span> <span class="function">start</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Hook to start. Also used as a hook for hot code reload.</span><span class="delimiter">&quot;</span></span>
  []
  (js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">start called</span><span class="delimiter">&quot;</span></span>)
  (main))

(<span class="keyword">defn</span> <span class="function">stop</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Hot code reload hook to shut down resources so hot code reload can work</span><span class="delimiter">&quot;</span></span>
  [done]
  (js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">stop called</span><span class="delimiter">&quot;</span></span>)
  (when-some [srv @server-ref]
    (<span class="keyword">.</span>close srv
      (<span class="keyword">fn</span> [err]
        (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop completed</span><span class="delimiter">&quot;</span></span> err)
        (done)))))

(js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">__filename</span><span class="delimiter">&quot;</span></span> js/__filename)</code></pre>
</div>
</div>
<div class="paragraph">
<p>関連する設定は (<code>shadow-cljs.edn</code>) です。</p>
</div>
<div class="listingblock">
<div class="title">ホットコードのリロードのためのフックを追加。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   { <span class="symbol">:script</span> {<span class="keyword">..</span><span class="keyword">.</span> as before

              <span class="comment">; add in reload hooks</span>
              <span class="symbol">:devtools</span> {<span class="symbol">:before-load-async</span> demo.script/stop
                         <span class="symbol">:after-load</span> demo.script/start}}}}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
多くのライブラリは状態を隠したり、ホットコードのリロードがうまく動作しないような動作をしています。コンパイラは、それらのライブラリが何をしているかを知らないので、これを改善することはできません。ホット・コード・リロードがうまくいくのは、使用されたアーティファクトをきれいに 「stop」と「restart」することができる状況でのみです。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="target-node-library"><a class="anchor" href="#target-node-library"></a><a class="link" href="#target-node-library">9.2. node.js Libraries</a></h3>
<div class="paragraph">
<p><code>:target :node-library</code> は、標準のノードライブラリとして(<code>require</code> を介して)利用できるコードを出力し、コンパイルされた Javascript の成果物として再利用するためにコードを公開するのに便利です。</p>
</div>
<div class="paragraph">
<p>他のモードと同様に <a href="#config">main configuration options</a> が適用され、設定しなければなりません。ターゲット固有のオプションは以下の通りです:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p>Use :node-library</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>(必須)。生成されたライブラリのパスとファイル名。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(オプション)。開発モードでサポートするファイルのパス。デフォルトはキャッシュディレクトリです。</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ホットコードのリロードの話は <a href="#NodeHotCodeReload">the script target</a> と似ていますが、ロードされるコードの全てを簡単に制御できないので、うまくいかないかもしれません。</p>
</div>
<div class="paragraph">
<p>実際にエクスポートされるコードを制御するには、以下のオプションのいずれかを使用します:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:exports</code> -  キーワードと完全修飾シンボルのマップ</p>
</li>
<li>
<p><code>:exports-var</code> - 完全修飾シンボル</p>
</li>
<li>
<p><code>:exports-fn</code> - 完全修飾シンボル</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_single_static_default_export"><a class="anchor" href="#_single_static_default_export"></a><a class="link" href="#_single_static_default_export">9.2.1. Single static "default" export</a></h4>
<div class="paragraph">
<p><code>:exports-var</code> は、その var の下で宣言されたものを返すだけです。 これは <code>defn</code> または通常の <code>def</code> を指すことができます。</p>
</div>
<div class="listingblock">
<div class="title">Build config using <code>:exports-var</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">lib.js</span><span class="delimiter">&quot;</span></span>
                <span class="symbol">:exports-var</span> demo.ns/f
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example CLJS</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.ns</span>)

(<span class="keyword">defn</span> <span class="function">f</span> [<span class="keyword">..</span><span class="keyword">.</span>] <span class="keyword">..</span><span class="keyword">.</span>)
<span class="comment">;; OR</span>
(<span class="keyword">def</span> <span class="function">f</span> <span class="error">#</span>js {<span class="symbol">:foo</span> <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Consuming the generated code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ node
&gt; var f = require('./lib.js');
f(); // the actual demo.ns/f function</code></pre>
</div>
</div>
<div class="paragraph">
<p>効果的に <code>module.exports = demo.ns.f;</code> を生成しています。</p>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_static_named_exports"><a class="anchor" href="#_multiple_static_named_exports"></a><a class="link" href="#_multiple_static_named_exports">9.2.2. 複数の静的名前付きエクスポート</a></h4>
<div class="listingblock">
<div class="title">複数のエクスポートで構成を構築</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:exports</span> {<span class="symbol">:g</span>       demo.ns/f
                          <span class="symbol">:h</span>       other.ns/thing
                          <span class="symbol">:ns/ok?</span>  another.ns/ok?}
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このキーワードは、エクスポートされたオブジェクトのエントリの名前として使用されます。このキーワード名には <strong>munging は行われません</strong>  (ただし、名前空間は削除されます)。ですから、上の例では cljs <code>f</code> を <code>g</code> などにマップしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ node
&gt; var lib = require('./lib.js');
lib.g(); // call demo-ns/f
lib[&quot;ok?&quot;](); // call another-ns/ok?</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:exports-var</code> が指す <code>def</code> を使うことで、全く同じことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">exports</span> <span class="error">#</span>js {<span class="symbol">:g</span> f
                  <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_exports"><a class="anchor" href="#_dynamic_exports"></a><a class="link" href="#_dynamic_exports">9.2.3. "Dynamic" exports</a></h4>
<div class="paragraph">
<p>さらに、完全修飾シンボルとして <code>:exports-fn</code> を指定することもできます。これはJSオブジェクト(または関数)を返す引数を持たない関数を指します。この関数は <code>node</code> が戻り値をキャッシュするため、一度だけ呼び出されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.ns</span>
  (<span class="symbol">:require</span> [demo.other <span class="symbol">:as</span> other]))

(<span class="keyword">defn</span> <span class="function">generate-exports</span> []
  <span class="error">#</span>js {<span class="symbol">:hello</span> hello
       <span class="symbol">:foo</span> other/foo})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:exports-fn</span> demo.ns/generate-exports
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
exports設定は、エクスポートされたシンボルを自動的に追跡し、最適化の段階に渡します。これは <code>:exports</code> にリストされているものは、Google Closure の最適化によってリネームされないことを意味します。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_full_example"><a class="anchor" href="#_full_example"></a><a class="link" href="#_full_example">9.2.4. Full Example</a></h4>
<div class="paragraph">
<p>以下の例では、通常のNodeの <code>require</code> メカニズムで消費されることを意図した <code>lib.js</code> ファイルを作成しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.lib</span>)

(<span class="keyword">defn</span> <span class="function">hello</span> []
  (<span class="keyword">prn</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
  <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>ビルド構成は次のようになります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:library</span> {<span class="symbol">:target</span>    <span class="symbol">:node-library</span>
                    <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/demo-library/lib.js</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:exports</span>   {<span class="symbol">:hello</span> demo.lib/hello}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>で、実行時の使用方法は期待通りです:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ cd out/demo-library
$ node
<span class="keyword">&gt;</span> <span class="keyword">var</span> x <span class="keyword">=</span> <span class="keyword">require</span>('<span class="keyword">.</span>/lib')<span class="comment">;</span>
undefined
<span class="keyword">&gt;</span> x.hello()
hello
'hello'</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは <code>:node-script</code> のように <code>:output-to</code> で指定されたファイルのみを作成します。マップ <code>:exports</code> は CLJS の vars をエクスポート先の名前にマップします。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
開発モードでは、ノードスクリプトと同様に <a href="#NodeModes">same setup</a> を使用します（余分な依存関係があります）。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_code_npm_code_packages"><a class="anchor" href="#_creating_code_npm_code_packages"></a><a class="link" href="#_creating_code_npm_code_packages">9.3. Creating <code>npm</code> packages</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="target-npm-module"><a class="anchor" href="#target-npm-module"></a><a class="link" href="#target-npm-module">10. Embedding in the JS Ecosystem&#8201;&#8212;&#8201;The <code>:npm-module</code> Target</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>既存のJSプロジェクトにCLJSを統合することを目的とした追加ターゲットがあります。出力は既存のJSツール（例：webpack、browserify、babel、create-react-app、&#8230;&#8203;）とほとんど設定なしでシームレスに統合することができます。</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>出力ファイルのパスはデフォルトで <code>node_modules/shadow-cljs</code> に書き込まれます。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>(必須) コンパイルされるべき名前空間シンボルのベクトル</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn` config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:code</span>
  {<span class="symbol">:target</span> <span class="symbol">:npm-module</span>
   <span class="symbol">:entries</span> [demo.foo]}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>デフォルトの <code>:output-dir</code> の <code>"node_modules/shadow-cljs"</code> を使っている場合は、JSで <code>require("shadow-cljs/demo.foo")</code> を使うことで、宣言された名前空間にアクセスすることができます。 <code>node_modules</code> にないものを使うときは、相対パスを使ってインクルードする必要があります。<code>:output-dir &#34;out&#34;</code> とすると、プロジェクトのルートから <code>require(&#34;./out/demo.foo&#34;)</code> となります。</p>
</div>
<div class="paragraph">
<p>NPM上でコードを配布する予定があるのであれば、代わりに <a href="#NodeLibrary"><code>:node-library</code> target</a> を使うのが良いでしょう。</p>
</div>
<div class="sect2">
<h3 id="_working_with_optimizations"><a class="anchor" href="#_working_with_optimizations"></a><a class="link" href="#_working_with_optimizations">10.1. Working with Optimizations</a></h3>
<div class="paragraph">
<p><code>:node-library</code> ターゲットとは異なり、モジュールターゲットはエクスポートしたシンボルを何と呼びたいかを知らないので、そのままエクスポートします。advanced コンパイルを使っている場合は、すべてのものが短縮化された名前になります!</p>
</div>
<div class="paragraph">
<p>保存したいシンボルに <code>:export</code> のメタデータを追加するだけです:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.foo</span>)

(<span class="keyword">def</span> ^<span class="symbol">:export</span> foo <span class="float">5.662</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:export</span> bar [] <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>これはClojureScriptで理解されている標準的なアノテーションで、Google Closureがアーティファクトの名前を変更するのを防ぎます。JSコードは最適化された後でもアクセスすることができます。ヒント <code>^:export</code> がなければ、クロージャコンパイラはそれらを削除したり、名前を変更したりしているでしょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">var</span> <span class="keyword">ns</span> <span class="namespace">=</span> <span class="keyword">require</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">shadow-cljs/demo.foo</span><span class="delimiter">&quot;</span></span>)<span class="comment">;</span>

ns.foo<span class="comment">;</span>
ns.bar()<span class="comment">;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">11. Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> はテストのビルドを少し簡単にするためのユーティリティターゲットをいくつか提供します。</p>
</div>
<div class="paragraph">
<p>すべてのテストターゲットはテストランナーを生成し、設定可能な <code>:ns-regexp</code> にマッチするすべての名前空間を自動的に追加します。デフォルトのテストランナーは <code>cljs.test</code> 用にビルドされていますが、他のテストフレームワークを使いたい場合はカスタムランナーを作成することができます。</p>
</div>
<div class="paragraph">
<p>デフォルトの <code>:ns-regexp</code> は <code>"-test$"</code> なので、最初のテストは以下のようになります:</p>
</div>
<div class="listingblock">
<div class="title">File: `src/test/demo/app_test.cljs'</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app-test</span>
  (<span class="symbol">:require</span> [cljs.test <span class="symbol">:refer</span> (deftest is)]))

(deftest a-failing-test
  (is (<span class="keyword">=</span> <span class="integer">1</span> <span class="integer">2</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Clojureの世界では、テストファイルをそれぞれのソースパスに保存するのが一般的ですので、上の例では <code>shadow-cljs.edn</code> の設定で <code>:source-paths ["src/main" "src/test"]</code> を設定したと仮定しています。通常のアプリのコードは <code>src/main</code> に、テストは <code>src/test</code> に入れます。これは任意で、全てを <code>src</code> に入れておいて <code>:source-paths [&#34;src&#34;]</code> を使っても全く問題ありません。</p>
</div>
<div class="sect2">
<h3 id="target-node-test"><a class="anchor" href="#target-node-test"></a><a class="link" href="#target-node-test">11.1. Testing in node.js</a></h3>
<div class="paragraph">
<p>このターゲットは、指定された正規表現にマッチするすべてのテスト名前空間を含むテストランナーを作成します。</p>
</div>
<div class="paragraph">
<p>関連する設定オプションは以下の通りです:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:node-test</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>テストの実行に使用される最終的な出力ファイル。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(オプション) プロジェクトファイルに対して名前空間をマッチさせる正規表現。これはファイルのみをスキャンし、jarはスキャンしません。デフォルトは <code>"-test$test"</code> です。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:autorun</code>
</td>
<td class="hdlist2">
<p>(boolean, オプション) ビルドが完了したときに <code>node</code> 経由でテストを実行します。これは主に <code>watch</code> と組み合わせて使うことを意図しています。実行中のJVMを強制的に終了させる必要があるため <code>node</code> プロセスの終了コードは返されません。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:main</code>
</td>
<td class="hdlist2">
<p>(修飾されたシンボルです,オプション) 起動時にテストを実行するために呼び出される関数です。デフォルトは <code>shadow.test.node/main</code> で、これは <code>cljs.test</code> を使ってテストを実行します。</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">すべての <code>*-spec</code> 名前空間にマッチする設定をテストする</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:test</span>
  {<span class="symbol">:target</span>    <span class="symbol">:node-test</span>
   <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/node-tests.js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:ns-regexp</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:autorun</span>   <span class="predefined-constant">true</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ターゲット <code>:node-test</code> はテストファイルを生成するだけです。 `node`を経由して実行することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile test
# or
$ shadow-cljs release test

# run tests manually, :autorun will do this automatically
$ node out/node-tests.js

# compile &amp; test combined
$ shadow-cljs compile test &amp;&amp; node out/node-tests.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>成功した場合は <code>node</code> のプロセス終了コードは <code>0</code> に、失敗した場合は <code>1</code> に設定されます。(<code>:autorun</code> を利用している場合は <code>node</code> のプロセス終了コードは返されません)。</p>
</div>
</div>
<div class="sect2">
<h3 id="target-browser-test"><a class="anchor" href="#target-browser-test"></a><a class="link" href="#target-browser-test">11.2. Testing in the Browser</a></h3>
<div class="paragraph">
<p>このターゲットは、(ファイル名のパターンマッチに基づいて)テストを含む名前空間を収集し、テストランナーを起動するためのものです。自動的に <code>cljs.test</code> テストをスキャンして実行する組み込みのランナーが含まれています。</p>
</div>
<div class="paragraph">
<p>関連する設定オプションは以下の通りです:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:browser-test</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:test-dir</code>
</td>
<td class="hdlist2">
<p>ファイルを出力するフォルダ。下記参照。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(オプション) プロジェクトファイルに対して名前空間をマッチさせる正規表現。これはファイルのみをスキャンし、jarはスキャンしません。デフォルトは "-test$$" です。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:runner-ns</code>
</td>
<td class="hdlist2">
<p>(オプション) start、stopおよび init 関数を含むことができる名前空間。デフォルトは <code>shadow.test.browser</code> です。</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>通常の <code>:devtools</code> オプションがサポートされているので、通常はファイルを提供するために http サーバを作成します。一般的には以下のような設定が必要になります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:test</span>     {<span class="symbol">:target</span>    <span class="symbol">:browser-test</span>
                     <span class="symbol">:test-dir</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js/test</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:ns-regexp</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:runner-ns</span> tests.client-test-main
                     <span class="symbol">:devtools</span>  {<span class="symbol">:http-port</span>          <span class="integer">8021</span>
                                 <span class="symbol">:http-root</span>          <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js/test</span><span class="delimiter">&quot;</span></span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>テストディレクトリにはindex.htmlとjsフォルダがあることを覚えておいてください。</p>
</div>
<div class="paragraph">
<p>カスタムの <code>:runner-ns</code> を指定すると、以下のようになります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">tests.client-test-main</span>)

(<span class="keyword">defn</span> <span class="function">start</span> []
  <span class="keyword">..</span><span class="keyword">.</span> run the tests.<span class="keyword">..</span>)

(<span class="keyword">defn</span> <span class="function">stop</span> [done]
  <span class="comment">; テストは非同期にすることができます。ランナーが実際に終了したことを知ることができるように done を呼び出す必要があります  (done))</span>

(<span class="keyword">defn</span> ^<span class="symbol">:export</span> init []
  (start))</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは単に <code>init</code>, <code>start</code>, <code>stop</code> メソッドを持っているだけです。init`は起動時に一度だけ呼び出され <code>stop</code> はコードがリロードされる前に呼び出され <code>start</code> はすべてのコードがリロードされた後に呼び出されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<code>:runner-ns</code> はオプションで、デフォルトのままにしておきます。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_generated_output_in_code_test_dir_code"><a class="anchor" href="#_generated_output_in_code_test_dir_code"></a><a class="link" href="#_generated_output_in_code_test_dir_code">11.2.1. Generated output in <code>:test-dir</code></a></h4>
<div class="paragraph">
<p>出力には <code>test-dir</code> フォルダ内の2つの主要な成果物が含まれています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>index.html</code> - <code>index.html</code> ファイルが存在しない場合に限ります。デフォルトでは、生成されたファイルはテストをロードして <code>:runner-ns</code> で <code>init</code> を実行します。上書きされないカスタムバージョンを編集したり、追加したりすることができます。</p>
</li>
<li>
<p><code>js/test.js</code> - Javascriptのテスト。テストは常にこの名前を持ちます。モジュールのエントリは自動生成されます。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="target-karma"><a class="anchor" href="#target-karma"></a><a class="link" href="#target-karma">11.3. 継続的インテグレーションのためにテストをKarmaターゲットに絞る</a></h3>
<div class="paragraph">
<p>ある種のCIサーバ上のブラウザに対してCLJSテストを実行したい場合、コマンドラインからテストを実行してステータスコードを返すことができる必要があります。Karma はよく知られていてサポートされているテストランナーであり <code>shadow-cljs</code> にはテストに適切なラッパーを追加してテストを実行できるようにするターゲットが含まれています。</p>
</div>
<div class="sect3">
<h4 id="_installing_karma"><a class="anchor" href="#_installing_karma"></a><a class="link" href="#_installing_karma">11.3.1. Installing Karma</a></h4>
<div class="paragraph">
<p>完全な説明は <a href="http://karma-runner.github.io">website</a> を参照してください。通常、以下のようなものが必要になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">CITests</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Testing</span><span class="delimiter">&quot;</span></span>,
  <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  <span class="key"><span class="delimiter">&quot;</span><span class="content">devDependencies</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.0.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma-chrome-launcher</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.2.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma-cljs-test</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^0.1.0</span><span class="delimiter">&quot;</span></span>,
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">license</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MIT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>そのためには、Karma、ブラウザランチャー、cljs-testの統合が必要です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_build"><a class="anchor" href="#_the_build"></a><a class="link" href="#_the_build">11.3.2. The Build</a></h4>
<div class="paragraph">
<p>ビルドオプション:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:karma</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>jsファイルのパス/ファイル名。</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(オプション) テストの名前空間にマッチする正規表現、デフォルトは"-test$"です。</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>なので、こんな感じのものがあるかもしれません:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:ci</span>
  {<span class="symbol">:target</span> <span class="symbol">:karma</span>
   <span class="symbol">:output-to</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">target/ci.js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:ns-regexp</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>また <code>karma.conf.js</code> も必要です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">module.<span class="function">exports</span> = <span class="keyword">function</span> (config) {
    config.set({
        <span class="key">browsers</span>: [<span class="string"><span class="delimiter">'</span><span class="content">ChromeHeadless</span><span class="delimiter">'</span></span>],
        <span class="comment">// 出力ファイルがあるディレクトリ</span>
        <span class="key">basePath</span>: <span class="string"><span class="delimiter">'</span><span class="content">target</span><span class="delimiter">'</span></span>,
        <span class="comment">// ファイルそのもの</span>
        <span class="key">files</span>: [<span class="string"><span class="delimiter">'</span><span class="content">ci.js</span><span class="delimiter">'</span></span>],
        <span class="key">frameworks</span>: [<span class="string"><span class="delimiter">'</span><span class="content">cljs-test</span><span class="delimiter">'</span></span>],
        <span class="key">plugins</span>: [<span class="string"><span class="delimiter">'</span><span class="content">karma-cljs-test</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">karma-chrome-launcher</span><span class="delimiter">'</span></span>],
        <span class="key">colors</span>: <span class="predefined-constant">true</span>,
        <span class="key">logLevel</span>: config.LOG_INFO,
        <span class="key">client</span>: {
            <span class="key">args</span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">shadow.test.karma.init</span><span class="delimiter">&quot;</span></span>],
            <span class="key">singleRun</span>: <span class="predefined-constant">true</span>
        }
    })
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>で、以下のようにテストを実行することができます（ツールのグローバル実行ファイルをインストールしていると仮定します）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile ci
$ karma start --single-run
12 01 2018 01:19:24.222:INFO [karma]: Karma v2.0.0 server started at http://0.0.0.0:9876/
12 01 2018 01:19:24.224:INFO [launcher]: Launching browser ChromeHeadless with unlimited concurrency
12 01 2018 01:19:24.231:INFO [launcher]: Starting browser ChromeHeadless
12 01 2018 01:19:24.478:INFO [HeadlessChrome 0.0.0 (Mac OS X 10.12.6)]: Connected on socket TcfrjxVKmx7xN6enAAAA with id 85554456
LOG: 'Testing boo.sample-spec'
HeadlessChrome 0.0.0 (Mac OS X 10.12.6): Executed 1 of 1 SUCCESS (0.007 secs / 0.002 secs)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="js-deps"><a class="anchor" href="#js-deps"></a><a class="link" href="#js-deps">12. JavaScript Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="npm"><a class="anchor" href="#npm"></a><a class="link" href="#npm">12.1. NPM</a></h3>
<div class="paragraph">
<p><a href="https://www.npmjs.com/">npm</a> は JavaScript のデファクトスタンダードなパッケージマネージャです。ほとんどすべてのJSライブラリがここにあり、shadow-cljsはそれらのパッケージにアクセスするためのシームレスな統合を提供しています。</p>
</div>
<div class="sect3">
<h4 id="_using_npm_packages"><a class="anchor" href="#_using_npm_packages"></a><a class="link" href="#_using_npm_packages">12.1.1. Using npm packages</a></h4>
<div class="paragraph">
<p>ほとんどの npm パッケージには、実際のコードの使用方法についての説明が含まれています。「古い」 CommonJS のスタイルは、直接変換する require 呼び出しを持っているだけです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="keyword">var</span> react = require(<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>requireを呼び出す際に使用される文字列パラメータが何であれ、そのまま <code>:require</code> に転送します。":as" の別名はあなた次第です。これがわかれば、他のCLJSの名前空間と同じようにコードを使うことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(react/createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> では、 <strong>常に <code>ns</code> 形式と指定した <code>:as</code> のエイリアスを使用します。</strong> また <code>:reference</code> や <code>:rename</code> を使うこともできます。これは <code>:foreign-libs</code>/CLJSJS が行うものとは異なり、名前空間にそれをインクルードし、コードの中でグローバルな <code>js/Thhing</code> を使用します。</p>
</div>
<div class="paragraph">
<p>パッケージによっては <code>(:require ["thing" :as thing])</code> と <code>(thing)</code> を使って直接呼び出すことができる関数をエクスポートするだけのものもあります。</p>
</div>
<div class="paragraph">
<p>最近では、いくつかのパッケージが ES6 の <code>import</code> 文を使用するようになりました。これらのパッケージも、デフォルトのエクスポートに関連したわずかな違いがありますが、ほぼ1:1で変換されています。</p>
</div>
<div class="paragraph">
<p>変換には以下の表を使用することができます:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
このテーブルは、消費するコードが実際のES6+コードとしてパッケージ化されている場合にのみ適用されます。コードがCommonJSとしてパッケージ化されている場合 <code>:default</code> は適用されない場合があります。詳細は以下のセクションを参照してください。
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. ES6 Import to CLJS Require</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ES6 Import</th>
<th class="tableblock halign-left valign-top">CLJS Require</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import defaultExport from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :default defaultExport])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import * as name from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :as name])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export)])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export as alias } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :rename {export alias}])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export1 , export2 } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export1 export2)])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export1 , export2 as alias2 , [&#8230;&#8203;] } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export1) :rename {export2 alias2}])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import defaultExport, { export [ , [&#8230;&#8203;] ] } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export) :default defaultExport])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import defaultExport, * as name from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :as name :default defaultExport])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name"])</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以前は、実際には必要のないコードがたくさん含まれているバンドルコードを使用していたことに注意してください。今では、より良い状況になっています。ライブラリの中には、必要な部分だけを含めることができるようにパッケージ化されているものもあり、最終的なビルドのコード数を大幅に減らすことができます。</p>
</div>
<div class="paragraph">
<p><code>react-virtualized</code> は素晴らしい例です:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="comment">// react-virtualized' から任意のコンポーネントを名前付きエクスポートとしてインポートすることができます。 例：</span>
<span class="reserved">import</span> { Column, Table } from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized</span><span class="delimiter">'</span></span>
 
<span class="comment">// しかし、いくつかの react-virtualized コンポーネントだけを使用していて、</span>
<span class="comment">// アプリケーションのバンドルサイズが大きくなるのが気になる場合は、</span>
<span class="comment">// 以下のように必要なコンポーネントだけを直接インポートすることができます。</span>
<span class="reserved">import</span> AutoSizer from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized/dist/commonjs/AutoSizer</span><span class="delimiter">'</span></span>
<span class="reserved">import</span> List from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized/dist/commonjs/List</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>私たちのサポートが向上したことで、私たちはこれを簡単に変換することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-ns</span>
  <span class="comment">;; 全て</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (Column Table)])
  <span class="comment">;; または1つずつ</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized/dist/commonjs/AutoSizer</span><span class="delimiter">&quot;</span></span> <span class="symbol">:default</span> virtual-auto-sizer]
            [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized/dist/commonjs/List</span><span class="delimiter">&quot;</span></span> <span class="symbol">:default</span> virtual-list]))</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_about_default_exports"><a class="anchor" href="#_about_default_exports"></a><a class="link" href="#_about_default_exports">About :default Exports</a></h5>
<div class="paragraph">
<p>オプション <code>:default</code> は現在のところ <code>shadow-cljs</code> でしか利用できませんが、 <a href="https://dev.clojure.org/jira/browse/CLJS-2376">ここに投票する</a> で標準化できることを願っています(訳注：現在は投票を受け付けていません)。標準のCLJSとの互換性を保ちたいのであれば <code>:as alias</code> を使って <code>alias/default</code> を呼び出すこともできます。</p>
</div>
<div class="paragraph">
<p>デフォルトのエクスポートは ECMAScript モジュールに新たに追加されたもので、CommonJS コードには存在しません。CommonJSのコードの場合 <code>import Foo from "something""</code> の例を見かけることがあります。その場合は <code>(:require ["something" :default Foo])</code> は動作せず、代わりに <code>(:require ["something" :as Foo])</code> を使用しなければなりません。</p>
</div>
<div class="paragraph">
<p>もし <code>:require</code> が正しく動作しないようであれば、REPL で見てみることをお勧めします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs browser-repl (<span class="keyword">or</span> node-repl)
<span class="keyword">..</span><span class="keyword">.</span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (<span class="keyword">require</span> '[<span class="string"><span class="delimiter">&quot;</span><span class="content">react-tooltip</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> x])
<span class="predefined-constant">nil</span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; x
<span class="error">#</span>object[e]
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (goog/typeOf x)
<span class="string"><span class="delimiter">&quot;</span><span class="content">function</span><span class="delimiter">&quot;</span></span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (js/console.dir x)
<span class="predefined-constant">nil</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>任意のJSオブジェクトを表示することが必ずしも有用とは限らないので(上で見たように)、代わりに <code>(js/console.dir x)</code> を使用すると、ブラウザコンソールでより有用な再表示を得ることができます。また <code>goog/typeOf</code> も有用な場合があります。上の例では <code>:default</code> は基本的には <code>x/default</code> の文法上の糖質に過ぎないので <code>:default</code> を使ってもうまくいかないでしょう。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="js-provider"><a class="anchor" href="#js-provider"></a><a class="link" href="#js-provider">12.1.2. Package Provider</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> は、ビルドに <code>npm</code> パッケージを含めるためのいくつかの異なる方法をサポートしています。これらは <code>:js-options :js-provider</code> 設定で設定できます。各 <code>:target</code> は通常、ビルドに適したものを設定しますが、ほとんどの場合、この設定に触れる必要はありません。</p>
</div>
<div class="paragraph">
<p>現在サポートされているJSプロバイダは3つあります:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:require</code></dt>
<dd>
<p>JSの <code>require("thing")</code> 関数呼び出しに直接マップします。これはすべての <code>node.js</code> ターゲットのデフォルトで、実行時にネイティブに <code>require</code> を解決することができます。インクルードされたJSは何も処理されません。</p>
</dd>
<dt><code>:shadow</code></dt>
<dd>
<p><code>node_modules</code> 経由でJSを解決し、ビルド中に参照された各ファイルの修正版を含みます。これは <code>:browser</code> ターゲットのデフォルトです。 <code>node_modules</code> のソースは <code>:advanced</code> のコンパイルを通過しません。</p>
</dd>
<dt><code>:closure</code></dt>
<dd>
<p><code>:shadow</code> と同様に解決しますが、すべてのインクルードされたファイルをClosure Compiler CommonJS/ES6の書き換え機能を使って処理しようとします。これらのファイルは <code>:advanced</code> コンパイルによっても処理されます。</p>
</dd>
</dl>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title"><code>:shadow</code> vs <code>:closure</code></div>
<div class="paragraph">
<p>理想的には <code>:closure</code> をプライマリの JS プロバイダとして使いたいものです。しかし実際には <code>npm</code> で利用できるコードの多くは <code>:advanced</code> のコンパイルが行う積極的な最適化とは互換性がありません。これらのコードはコンパイルに全く失敗するか、実行時に識別するのが非常に困難な微妙なバグを露呈します。</p>
</div>
<div class="paragraph">
<p><code>:shadow</code> は <code>:simple</code> を経由してコードを処理するだけで、より信頼性の高いサポートを実現しつつ、合理的に最適化されたコードを得ることができるその場限りの解決方法のようなものです。出力は <code>webpack</code> のような他のツールが生成するものに匹敵します (あるいはそれよりも優れていることが多い)。</p>
</div>
<div class="paragraph">
<p>Closureのサポートがより信頼性の高いものになるまでは <code>:shadow</code> が <code>:browser</code> ビルドの推奨JSプロバイダです。</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title"><code>:browser</code> ビルドで <code>:closure</code> を使うための設定例。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span> {<span class="symbol">:js-provider</span> <span class="symbol">:closure</span>}
   }}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="js-resolve"><a class="anchor" href="#js-resolve"></a><a class="link" href="#js-resolve">12.1.3. Resolving Packages</a></h4>
<div class="paragraph">
<p>デフォルトでは <code>shadow-cljs</code> は <code>(:require [" thing" :as x])</code> 要求をすべて <code>npm</code> の規約に従って解決します。つまり <code>&lt;project&gt;/node_modules/thing/package.json</code> を見て、そこからコードを辿ります。この動作をカスタマイズするために <code>shadow-cljs</code> は <code>:resolve</code> という設定オプションを公開しています。</p>
</div>
<div class="sect4">
<h5 id="js-resolve-global"><a class="anchor" href="#js-resolve-global"></a><a class="link" href="#js-resolve-global">Using a CDN</a></h5>
<div class="paragraph">
<p>CDN経由で既にReactがページに含まれているとします。あなたは再び <code>js/React</code> を使い始めることができますが、私たちは正当な理由のためにそれをするのをやめました。代わりに <code>(:require ["react" :as react])</code> を使い続けることができますが、&#34;react&#34; の解決方法を設定してください!</p>
</div>
<div class="paragraph">
<p>以下はそのようなビルドのための <code>shadow-cljs.edn</code> の設定例です:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:global</span>
                       <span class="symbol">:global</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span>}}}}

  <span class="symbol">:server</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:app</code> のビルドではグローバルな <code>React</code> インスタンスを使用しますが <code>:server</code> のビルドでは &#34;react&#34; npm パッケージを使用してビルドを継続します。これを動作させるためにコードをいじる必要はありません。</p>
</div>
</div>
<div class="sect4">
<h5 id="js-resolve-npm"><a class="anchor" href="#js-resolve-npm"></a><a class="link" href="#js-resolve-npm">Redirecting “require”</a></h5>
<div class="paragraph">
<p>ビルドによっては、どの <code>npm</code> パッケージが実際に使用されるかをコントロールしたくないこともあるでしょう。コードを変更せずに、ビルド設定から特定の要求を &#34;redirect&#34; することができます。これは、そのようなパッケージを使っているソースにアクセスできない場合や、 あるビルドのためだけに変更したい場合に便利です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:npm</span>
                       <span class="symbol">:require</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">preact-compat</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="js-resolve-limitations"><a class="anchor" href="#js-resolve-limitations"></a><a class="link" href="#js-resolve-limitations">Limitations</a></h5>
<div class="paragraph">
<p><code>:shadow-js</code> と <code>:closure</code> は <code>:resolve</code> を完全に制御することができます。しかし <code>:js-provider :require</code> はより制限されています。標準の <code>require</code> がその後を制御しているため、最初の <code>require</code> だけが影響を受けることができます。つまり、パッケージが内部的に <code>require</code> するものに影響を与えることはできないということです。したがって <code>require</code> を直接使用するターゲット (例えば <code>:node-script</code>) と一緒に使用することは推奨されません。</p>
</div>
<div class="listingblock">
<div class="title">Redirecting "react" to "preact"</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:npm</span>
                       <span class="symbol">:require</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">preact-compat</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example use of react-table</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-table</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> rt]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>ブラウザ上では、すべての <code>"react"</code> requireが置き換えられ <code>"react-table"</code> が内部的に持っている <code>"react"</code> requireも置き換えられるので、上記の方法で問題なく動作します。しかし <code>:js-provider :require</code> の場合は <code>require("react-table")</code> が発行され <code>node</code> はそれをどのように解決するかを制御します。つまり、設定した <code>"preact"</code> ではなく、標準の <code>"react"</code> に解決されます。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="alt-node-modules"><a class="anchor" href="#alt-node-modules"></a><a class="link" href="#alt-node-modules">12.1.4. Alternate Modules Directories</a></h4>
<div class="paragraph">
<p>デフォルトでは <code>shadow-cljs</code> は JS パッケージを解決する際に <code>&lt;project-dir&gt;/node_modules</code> ディレクトリのみを参照します。これは <code>:js-options</code> の <code>:js-package-dirs</code> オプションで設定できます。これは全体またはビルドごとに適用することができます。</p>
</div>
<div class="paragraph">
<p>相対パスは、プロジェクトのルートディレクトリからの相対パスとして解決されます。パスは左から右へと試行され、最初にマッチしたパッケージが使用されます。</p>
</div>
<div class="listingblock">
<div class="title">Global config in <code>shadow-cljs.edn</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:js-options</span> {<span class="symbol">:js-package-dirs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">node_modules</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">../node_modules</span><span class="delimiter">&quot;</span></span>]}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Config applied to single build</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span> {<span class="symbol">:js-package-dirs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">node_modules</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">../node_modules</span><span class="delimiter">&quot;</span></span>]}}}}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="classpath-js"><a class="anchor" href="#classpath-js"></a><a class="link" href="#classpath-js">12.2. Dealing with .js Files</a></h3>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>危険: この機能は実験的なものです！</strong> 現在のところ <code>shadow-cljs</code> でのみサポートされており、他の CLJS ツールが使用しようとすると怒鳴りつけてきます。使用は自己責任で行ってください。この機能は当初CLJSコアから却下されましたが、私は便利だと思っていますし、さらなる議論なしに <a href="https://dev.clojure.org/jira/browse/CLJS-2061?focusedCommentId=46191&amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-46191">dismissed</a> にすべきではありませんでした。</p>
</div>
<div class="paragraph">
<p>CLJSには代替の <a href="https://clojurescript.org/guides/javascript-modules">実装</a> がありますが、これは <code>shadow-cljs</code> がサポートしていません。私はこの実装がある面で欠けていることを発見したので、別の解決策を選択しました。両方のアプローチの長所と短所を議論したいと思います。</p>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="#npm">npm</a> パッケージがどのように使われるかを説明しましたが、すでにたくさんのプレーンなJavaScriptを持っているコードベースで作業しているかもしれませんし、まだClojureScriptですべてを書き換えたくないかもしれません。 <code>shadow-cljs</code> は、JavaScriptとClojureScriptの間で100%完全な相互運用を提供します。つまり、あなたのJSはCLJSを使用でき、CLJSはあなたのJSを使用できるということです。</p>
</div>
<div class="paragraph">
<p>これを確実に動作させるためには、いくつかの規則に従う必要がありますが、いずれにせよ、あなたはすでにそれを行っている可能性があります。</p>
</div>
<div class="sect3">
<h4 id="_requiring_js"><a class="anchor" href="#_requiring_js"></a><a class="link" href="#_requiring_js">12.2.1. Requiring JS</a></h4>
<div class="paragraph">
<p><code>npm</code> パッケージが名前でアクセスする方法はすでに説明しましたが、クラスパスではフルパスか現在の名前空間からの相対パスのいずれかで <code>.js</code> ファイルにアクセスします。</p>
</div>
<div class="listingblock">
<div class="title">Loading JS from the classpath</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">/some-library/components/foo</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> foo]
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">./bar</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> bar <span class="symbol">:refer</span> (myComponent)]))</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
文字列が必要な場合、拡張子 <code>.js</code> は自動的に追加されますが、お好みで拡張子を指定することもできます。しかし、現在は <code>.js</code> のみがサポートされていることに注意してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>/some-library/components/foo</code> のような絶対的な要求は、コンパイラがクラスパス上の <code>some-library/components/foo.js</code> を探すことを意味します。同じクラスパスルールが適用されるので、ファイルは <code>:source-paths</code> または使用しているサードパーティの <code>.jar</code> ライブラリにあるかもしれません。</p>
</div>
<div class="paragraph">
<p>相対パスは、まず現在の名前空間を見て、その名前からの相対パスを解決することで解決されます。上の例では <code>demo/app.cljs</code> から <code>./bar</code> の require は <code>demo/bar.js</code> に解決されるので <code>(:require ["/demo/bar")</code> と同じです。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
ファイルが物理的に同じディレクトリにあってはいけません。ファイルの検索は、代わりにクラスパス上に表示されます。これは、相対的な要求が常に物理的なファイルに解決することを期待しているnodeとは異なります。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">パスが分離されたファイル構造の例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── demo
            └── app.cljs
    └── js
        └── demo
            └── bar.js</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_language_support"><a class="anchor" href="#_language_support"></a><a class="link" href="#_language_support">12.2.2. Language Support</a></h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
クラスパスには、コンパイラによる前処理なしで消費できるJavaScriptのみが含まれていることが期待されています。 <code>npm</code> にも非常に似たような規約があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Closureコンパイラは <code>ECMASCRIPT_NEXT</code> 言語設定を使用してクラスパス上のすべてのJavaScriptを処理するために使用されます。この設定が何を意味するのかはよくわかっていませんが、ほとんどのブラウザではまだサポートされていないかもしれない次世代のJavaScriptコードを表しています。ES6はES8の機能と同様に非常によくサポートされています。標準のCLJSと同様に、必要に応じてポリフィルを使用してES5までコンパイルされます。</p>
</div>
<div class="paragraph">
<p>Closureコンパイラは常に更新されていますので、新しい機能は時間の経過とともに利用可能になります。ただ、最新の最先端のプレビュー機能をすぐに使えるようになるとは思っていません。最近追加された <code>async/await</code> のような機能はすでに十分に機能しています。</p>
</div>
<div class="paragraph">
<p>JSは <code>import</code> や <code>export</code> を使ってESモジュール構文を使って記述する必要があります。JSファイルは他のJSファイルをインクルードしたり、CLJSコードを直接参照したりすることができます。また <code>npm</code> パッケージに直接アクセスすることもできますが、1つの注意点があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="comment">// regular JS require</span>
<span class="reserved">import</span> Foo, { something } from <span class="string"><span class="delimiter">&quot;</span><span class="content">./other.js</span><span class="delimiter">&quot;</span></span>;

<span class="comment">// npm require</span>
<span class="reserved">import</span> React from <span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span>;

<span class="comment">// require CLJS or Closure Library JS</span>
<span class="reserved">import</span> cljs from <span class="string"><span class="delimiter">&quot;</span><span class="content">goog:cljs.core</span><span class="delimiter">&quot;</span></span>;

<span class="reserved">export</span> <span class="keyword">function</span> <span class="function">inc</span>(num) {
  <span class="keyword">return</span> cljs.inc(<span class="integer">1</span>);
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Closure Compilerのチェックが厳しいため、CLJSやnpmのコードが必要な場合は <code>import * as X from &#34;npm&#34;;</code> 構文を使うことができません。他のJSファイルが必要な場合は問題ありません。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_dialects"><a class="anchor" href="#_javascript_dialects"></a><a class="link" href="#_javascript_dialects">12.2.3. JavaScript Dialects</a></h4>
<div class="paragraph">
<p>多くの一般的なJavaScriptの方言(JSX、CoffeeScriptなど)はClosureコンパイラで直接解析できないので、クラスパスに置く前に前処理をする必要があります。 <a href="https://babeljs.io/">babel</a> はJavaScriptの世界で一般的に使われているので <code>.jsx</code> ファイルを処理するために <code>babel</code> を例に挙げてみます。</p>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/gen</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example File Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── demo
            └── app.cljs
    └── js
        ├── .babelrc
        └── demo
            └── bar.jsx</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>src/js</code> が <code>:source-paths</code> に追加されていないことに注目してください。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/js/demo/bar.jsx</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="jsx">import React from &quot;react&quot;;

function myComponent() {
  return &lt;h1&gt;JSX!&lt;/h1&gt;;
}

export { myComponent };</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://babeljs.io/docs/usage/cli/">babel</a> を実行してファイルを変換し、設定された <code>src/gen</code> ディレクトリに書き出します。どのディレクトリを使うかはあなた次第です。私は生成されたファイルは <code>src/gen</code> の方が好きです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ babel src/js --out-dir src/gen
# or during development
$ babel src/js --out-dir src/gen --watch</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>babel`自体は `src/js/.babelrc</code> で設定します。公式の <a href="https://babeljs.io/docs/plugins/transform-react-jsx/">JSXの例</a> を参照してください。</p>
</div>
<div class="listingblock">
<div class="title">JSX minimal .babelrc</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">plugins</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">transform-react-jsx</span><span class="delimiter">&quot;</span></span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>一度 <code>babel</code> が <code>src/gen/demo/bar.js</code> を書けば、ClojureScript から利用可能になり、ClojureScript のソースと同じようにホットロードされるようになります。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
現在 <code>shadow-cljs</code> はこれらの変換ステップを実行するためのサポートを提供していません。サポートされるまでは、標準的なツール (例えば <code>babel</code>, <code>coffeescript</code> など) を直接使用してください。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_access_cljs_from_js"><a class="anchor" href="#_access_cljs_from_js"></a><a class="link" href="#_access_cljs_from_js">12.2.4. Access CLJS from JS</a></h4>
<div class="paragraph">
<p>JSソースは名前空間 <code>goog:</code> を接頭辞でインポートすることで、すべてのClojureScript (とClosure Library)に直接アクセスすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">import</span> cljs, { <span class="keyword">keyword</span> } from <span class="string"><span class="delimiter">&quot;</span><span class="content">goog:cljs.core</span><span class="delimiter">&quot;</span></span><span class="comment">;</span>

// construct {<span class="symbol">:foo</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>} in JS
cljs.array_map(<span class="keyword">keyword</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)<span class="comment">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
接頭辞 <code>goog:</code> は現在のところ ES6 ファイルでしか動作しません。require("goog:cljs.core")` は動作しません。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cljsjs"><a class="anchor" href="#cljsjs"></a><a class="link" href="#cljsjs">12.3. Migrating cljsjs.*</a></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>CLJSJSは、Javascriptのライブラリをパッケージ化して、ClojureScript内から利用できるようにする取り組みです。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> は <a href="#npm">npm packages</a> に直接アクセスできるので、再パッケージ化された <a href="https://github.com/cljsjs/packages">CLJSJS</a> パッケージに頼る必要はありません。</p>
</div>
<div class="paragraph">
<p>しかし、多くのCLJSライブラリはまだCLJSJSパッケージを使っており <code>shadow-cljs</code> はもうサポートしていないので <code>shadow-cljs</code> では壊れてしまいます。しかし <code>cljsjs</code> 名前空間はほとんどが <code>npm</code> パッケージからビルドされているので <code>cljs</code> 名前空間を真似るのは非常に簡単です。 <code>cljsjs.thing</code> を元の <code>npm</code> パッケージにマップして、期待されるグローバル変数を公開する shim ファイルが必要です。</p>
</div>
<div class="paragraph">
<p>Reactの場合は <code>src/cljsjs/react.cljs</code> のようなファイルが必要です:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">cljsjs.react</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
            [<span class="string"><span class="delimiter">&quot;</span><span class="content">create-react-class</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> crc]))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(js/goog.object.set react <span class="string"><span class="delimiter">&quot;</span><span class="content">createClass</span><span class="delimiter">&quot;</span></span> crc)
(js/goog.exportSymbol <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span> react)</code></pre>
</div>
</div>
<div class="paragraph">
<p>誰もが手動で行うのは面倒なので <a href="https://github.com/thheller/shadow-cljsjs"><code>shadow-cljsjs</code></a> ライブラリを作成しました。これはすべてのパッケージを含んでいるわけではありませんが、私はそれらを追加し続けます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>shadow-cljsjs</code> ライブラリは shim ファイルのみを提供します。実際のパッケージを自分で <code>npm</code> インストールする必要があります。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_why_not_use_cljsjs"><a class="anchor" href="#_why_not_use_cljsjs"></a><a class="link" href="#_why_not_use_cljsjs">12.3.1. Why not use CLJSJS?</a></h4>
<div class="paragraph">
<p>CLJSJSのパッケージは基本的に <code>npm</code> からパッケージを取り出して <code>.jar</code> に入れ、https://clojars.org[clojars] 経由で再公開するだけです。ボーナスとしてExternsがバンドルされていることが多いです。それ以外の場合、コンパイラはこれらのファイルには何もせず、生成された出力に前置きするだけです。</p>
</div>
<div class="paragraph">
<p>これは <code>npm</code> に直接アクセスできなかったときに非常に便利でしたが、すべてのパッケージが他のパッケージと簡単に結合できるわけではないので、ある種の問題があります。あるパッケージは <code>react</code> に依存しているかもしれませんが、これを <code>npm</code> で表現する代わりに <a href="https://github.com/cljsjs/packages/tree/master/material-ui">彼ら</a> は独自の <code>react</code> をバンドルしています。注意を怠ると、ビルド中に 2 つの異なる <code>react</code> バージョンを含むことになり、非常に混乱を招くエラーを引き起こしたり、 少なくともビルドサイズが大幅に大きくなったりする可能性があります。</p>
</div>
<div class="paragraph">
<p>また、すべての <code>npm</code> パッケージが CLJSJS で利用できるわけではなく、パッケージのバージョンを同期させるには手作業が必要で、パッケージが古くなっていることがよくあります。</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> は CLJSJS を全くサポートしていません。あるライブラリは "old"の <code>cljsjs.react</code> を使おうとするかもしれないし、別のライブラリは新しい <code>(:require ["react"])</code> を直接使おうとするかもしれない。これはまた、あなたのページに2つのバージョンの <code>react</code> が再び現れることになるでしょう。</p>
</div>
<div class="paragraph">
<p>つまり、足りないのはバンドルされているExternsだけです。多くの場合、これらは改良された <a href="#infer-externs">externs推論</a> のために必要とされていません。多くの場合、これらのExternsはサードパーティのツールを使って生成されます。</p>
</div>
<div class="paragraph">
<p>結論：<a href="#npm">npm</a>を直接使う。<a href="#infer-externs">:infer-externs auto</a>を使う。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="release"><a class="anchor" href="#release"></a><a class="link" href="#release">13. Generating Production Code&#8201;&#8212;&#8201;All Targets</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>開発モードでは、各名前空間ごとに個別のファイルを出力します。実際のサーバにコードをデプロイする準備ができたら、Closure Compilerを実行して、各 <a href="#_modules">module</a> に対して単一の最小化された結果を生成したいと思います。</p>
</div>
<div class="paragraph">
<p>デフォルトでは、リリースモードの出力ファイルは、開発モードのファイルの代わりにドロップインされるだけです。ブラウザターゲットのキャッシュ特性を改善するために <a href="#NameHashing">filename hashing</a> を使うことができます。</p>
</div>
<div class="listingblock">
<div class="title">Generating Minified Output</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs release build-id</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_release_configuration"><a class="anchor" href="#_release_configuration"></a><a class="link" href="#_release_configuration">13.1. Release Configuration</a></h3>
<div class="paragraph">
<p>通常、ビルド用のリリースバージョンを作成するために余分な設定を追加する必要はありません。デフォルトの設定には必要なものがすべて含まれているので、デフォルトを上書きしたい場合に追加の設定が必要になるだけです。</p>
</div>
<div class="paragraph">
<p>それぞれの <code>:target</code> には、それぞれのプラットフォームに最適化されたデフォルトが用意されているので、心配することは少なくなります。</p>
</div>
<div class="sect3">
<h4 id="Optimization"><a class="anchor" href="#Optimization"></a><a class="link" href="#Optimization">13.1.1. Optimizations</a></h4>
<div class="paragraph">
<p>最適化レベルは設定の <code>:compiler-options</code> セクションで選択できます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
通常は <code>:target</code> が適切なレベルに設定しているので <code>:optimizations</code> を設定する必要はありません。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>:optimizations</code> は <code>release</code> コマンドを使用した場合にのみ適用されます。開発ビルドはClosureコンパイラによって最適化されることはありません。開発ビルドは常に <code>:none</code> に設定されています。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:build</span>
   {<span class="symbol">:build-id</span>
     {<span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:compiler-options</span> {<span class="symbol">:optimizations</span> <span class="symbol">:simple</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>利用可能な最適化レベルの詳細については <a href="https://developers.google.com/closure/compiler/docs/compilation_levels">Closureコンパイラのドキュメント</a> を参照してください。</p>
</div>
</div>
<div class="sect3">
<h4 id="_release_specific_vs_development_configuration"><a class="anchor" href="#_release_specific_vs_development_configuration"></a><a class="link" href="#_release_specific_vs_development_configuration">13.1.2. Release-Specific vs. Development Configuration</a></h4>
<div class="paragraph">
<p>リリースビルドを実行する時にビルド中に別の設定値を設定したい場合は、ビルドセクションに <code>:dev</code> や <code>:release</code> セクションを含めることで設定を上書きすることができます。</p>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> build config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dependencies</span> []
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:base</span> {<span class="symbol">:entries</span> [my.app.core]}}

   <span class="comment">;; Here is some dev-specific config</span>
   <span class="symbol">:dev</span> {<span class="symbol">:compiler-options</span> {<span class="symbol">:devcards</span> <span class="predefined-constant">true</span>}}

   <span class="comment">;; Here is some production config</span>
   <span class="symbol">:release</span> {<span class="symbol">:compiler-options</span> {<span class="symbol">:optimizations</span> <span class="symbol">:simple</span>}}}}}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="externs"><a class="anchor" href="#externs"></a><a class="link" href="#externs">13.2. Externs</a></h3>
<div class="paragraph">
<p>Closure Compilerの <code>:advanced</code> コンパイルでビルドを完全に最適化したいため <a href="https://developers.google.com/closure/compiler/docs/api-tutorial3">Externs</a> を扱う必要があります。 Externsは <code>:advanced</code> コンパイル時に含めないコードを表します。 <code>:advanced</code> はプログラム全体の最適化を行うことで動作しますが、その中には含めたくないコードもあるため、Externsはそのコードをコンパイラーに通知します。Externsを使用しないとコンパイラはコードの名前を変更したり削除したりすることがあります。</p>
</div>
<div class="paragraph">
<p>典型的には、すべてのJS依存関係は外部のものであり <code>:advanced</code> には渡せないため、Externsが必要です。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
エクスターンが必要なのは <code>:advanced</code> の場合のみであり <code>:simple</code> モードでは必要ありません。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="infer-externs"><a class="anchor" href="#infer-externs"></a><a class="link" href="#infer-externs">13.2.1. Externs Inference</a></h4>
<div class="paragraph">
<p>Externs扱うために <code>shadow-cljs</code> コンパイラは拡張externs推論を提供しています、これを有効にするにはビルドに <code>:infer-externs :auto</code> を設定する必要があります。</p>
</div>
<div class="listingblock">
<div class="title">Example Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:infer-externs</span> <span class="symbol">:auto</span>}
   }}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:auto</code> を使うと、コンパイラはコンパイル時にファイルに対してのみ追加のチェックを行います。ライブラリコードのエクスターンの問題については警告しません。 <code>:all</code> を使うとすべての場合に有効になりますが、大量の警告を受ける可能性があることに注意してください。</p>
</div>
<div class="paragraph">
<p>この機能を有効にするとコンパイラは、JS と CLJS のどちらのコードを使用しているかを判別できず、警告を表示します。</p>
</div>
<div class="listingblock">
<div class="title">Example Code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>baz x))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Warning</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">------ WARNING #1 --------------------------------------------------------------
 File: ~/project/src/demo/thing.cljs:23:3
--------------------------------------------------------------------------------
  21 |
  22 | (defn wrap-baz [x]
  23 |   (.baz x))
---------^----------------------------------------------------------------------
 Cannot infer target type in expression (. x baz)
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>コンパイラは <code>:advanced</code> において <code>.baz</code> の名前をもっと短いものに変更します、 Externsはこれがリネームすべきではない外部プロパティであることをコンパイラに伝えます。</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> は、ネイティブInteropを実行するオブジェクトにタイプヒントを追加すれば、適切なエクスターンを生成することができます。</p>
</div>
<div class="listingblock">
<div class="title">Type-hint to help externs generation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>baz ^js x))</code></pre>
</div>
</div>
<div class="paragraph">
<p>この <code>^js</code> 型ヒントは、コンパイラが適切なエクスターンを生成するようになり、警告はなくなります。これでこのプロパティはリネームされても安全になりました。</p>
</div>
<div class="listingblock">
<div class="title">Multiple interop calls</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>foo ^js x)
  (<span class="keyword">.</span>baz ^js x))</code></pre>
</div>
</div>
<div class="paragraph">
<p>interop呼び出しのたびにアノテーションをつけるのは面倒になるので、変数のバインディング自体にアノテーションをつけることができます。この変数のスコープ全体で使用されます。両方の呼び出しのためのエクスターンはまだ生成されます。</p>
</div>
<div class="listingblock">
<div class="title">Annotate <code>x</code> directly</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [^js x]
  (<span class="keyword">.</span>foo x)
  (<span class="keyword">.</span>baz x))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
すべてのものに <code>^js</code> をアノテーションしてはいけません。CLJSやClosureJSオブジェクトのinteropを行うことがあるかもしれません。これらはエクスターンを必要としません。CLJSオブジェクトで作業していることが確実ならば <code>^clj</code> ヒントを使うことをお勧めします。 間違って <code>^js</code> を使用しても世界の終わりではありませんが、変数がリネームされず最適化に影響を与える可能性があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>直接的な <code>js/</code> 呼び出しを使用する場合、グローバルの呼び出しはタイプヒントを必要としません。</p>
</div>
<div class="listingblock">
<div class="title">ヒントは不要で、自動的にexternが推測されます</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(js/Some.Thing.coolFunction)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:require</code> バインディングの呼び出しも自動的に推測されます。</p>
</div>
<div class="listingblock">
<div class="title"><code>:as</code> および <code>:refer</code> バインディングにはヒントは必要ありません。</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react <span class="symbol">:refer</span> (createElement)]))

(react/createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)
(createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manual_externs"><a class="anchor" href="#_manual_externs"></a><a class="link" href="#_manual_externs">13.2.2. Manual Externs</a></h4>
<div class="paragraph">
<p>いくつかのライブラリでは、Externsを別の <code>.js</code> ファイルとして提供しています。コンパイラの <code>:externs</code> オプションを使ってビルドに含めることができます。</p>
</div>
<div class="listingblock">
<div class="title">Manual Externs Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:externs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/externs.js</span><span class="delimiter">&quot;</span></span> <span class="keyword">..</span><span class="keyword">.</span>]}
   }}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
コンパイラは最初にプロジェクト・ルートからの相対的なファイルを探します。また、ファイルが見つからない場合は、クラスパスからの読み込みを試みます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_simplified_externs"><a class="anchor" href="#_simplified_externs"></a><a class="link" href="#_simplified_externs">13.2.3. Simplified Externs</a></h4>
<div class="paragraph">
<p>Externsを手書きで書くのは難しいかもしれませんが <code>shadow-cljs</code> はより便利な書き方を提供してくれます。 <code>shadow-cljs check &lt;your-build&gt;</code> と組み合わせれば、不足しているエクスターンを素早く追加することができます。</p>
</div>
<div class="paragraph">
<p>まず <code>externs/&lt;your-build&gt;.txt</code> を作成することから始めます。このファイルの各行には名前を変更してはいけないJSプロパティを1つずつ記述します。グローバル変数の前には <code>global:</code> を付けてください。</p>
</div>
<div class="listingblock">
<div class="title">Example externs/app.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span> this is a <span class="keyword">comment</span>
foo
bar
global<span class="symbol">:SomeGlobalVariable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>この例ではコンパイラは <code>something.foo()</code>, <code>something.bar()</code> のリネームを停止します。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_stripping"><a class="anchor" href="#_code_stripping"></a><a class="link" href="#_code_stripping">13.3. Code Stripping</a></h3>
<div class="paragraph">
<p>Closureコンパイラは、不要なコードを名前で削除することをサポートしています。これにより、通常のデッドコード除去では除去できないコードを除去することができます。これは非常に危険なことですが、実際に気になるコードを削除することができますが、多くの開発者専用のコードを簡単に削除することができます。これは4つの別々のオプションにグループ化されていて、そのうちのほとんどは <code>:strip-type-prefixes</code> だけがClojureScriptに関連していますが、他のオプションも同様に有用かもしれません。</p>
</div>
<div class="listingblock">
<div class="title"><code>cljs.pprint</code> のすべての利用を削除する例</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:strip-type-prefixes</span> #{<span class="string"><span class="delimiter">&quot;</span><span class="content">cljs.pprint</span><span class="delimiter">&quot;</span></span>}
   }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これらのオプションはそれぞれ文字列のセットとして指定されます。ここで指定された名前はすべてJS名なので、CLJS名を指定する必要があることに注意してください。 <code>my-lib.core</code> は <code>my_lib.core</code> になります。</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:strip-types</code></dt>
<dd>
<p>deftype/defrecordの宣言や使用法を削除することができます <code>#{&#34;my.ns.FooBar&#34;}</code> は <code>(defrecord FooBar [])</code> を削除します。</p>
</dd>
<dt><code>:strip-type-prefixes</code></dt>
<dd>
<p>与えられた接頭辞のいずれかで始まるすべてのものを削除します。CLJSの名前空間全体を削除することができます。</p>
</dd>
<dt><code>:strip-name-prefixes</code></dt>
<dd>
<p>接頭辞によるプロパティの削除を許可します。このように <code>#{"log"}</code> は <code>this.logX</code> または <code>(defn log-me [&#8230;&#8203;])</code> を削除します。</p>
</dd>
<dt><code>:strip-name-suffixes</code></dt>
<dd>
<p>サフィックスによるプロパティの削除が可能です <code>#{&#34;log"}</code> は <code>this.myLog</code> または <code>(defn my-log [&#8230;&#8203;])</code> を削除します。</p>
</dd>
</dl>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>危険: これらのオプションには注意してください。これらのオプションはビルド全体に適用され、実際に必要なコードを削除する可能性があります。あなたが書いたものではないライブラリのコードを誤って削除してしまうかもしれません。これを使用する前には、常に他のオプションを検討してください。</strong></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_report"><a class="anchor" href="#_build_report"></a><a class="link" href="#_build_report">13.4. Build Report</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> は <code>release</code> ビルドの詳細なレポートを生成することができ、含まれるソースの詳細な内訳と、それらが全体のサイズにどれだけ貢献したかを含みます。</p>
</div>
<div class="paragraph">
<p>レポートのサンプルは <a href="https://code.thheller.com/demos/build-report/huge.html">こちら</a> をご覧ください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ npx shadow-cljs run shadow.cljs.build-report &lt;build-id&gt; &lt;path/to/output.html&gt;
# example
$ npx shadow-cljs run shadow.cljs.build-report app report.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記の例では <code>:app</code> ビルド用の <code>report.html</code> がプロジェクトディレクトリに生成されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
生成される <code>report.html</code> は完全に自己完結型で、必要なデータ/js/cssをすべて含んでいます。他の外部ソースは必要ありません。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_editor_integration"><a class="anchor" href="#_editor_integration"></a><a class="link" href="#_editor_integration">14. Editor Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cursive"><a class="anchor" href="#_cursive"></a><a class="link" href="#_cursive">14.1. Cursive</a></h3>
<div class="paragraph">
<p>Cursiveは現在のところ <code>shadow-cljs.edn</code> による依存関係の解決をサポートしていません。 <code>shadow-cljs pom</code> を実行して <code>pom.xml</code> を生成し、IntelliJを使ってそれをインポートすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs pom</code></pre>
</div>
</div>
<div class="paragraph">
<p>次にCursiveから <strong>File &#8594; New &#8594; Project from Existing Sources</strong> で、プロジェクトディレクトリ内の生成された <code>pom.xml</code> を選択します。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
このためには、&#34;Build Tools&#34; &#8594; "Maven" Pluginが有効になっている必要があります。デフォルトでは有効になっていないかもしれません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>あるいはダミーの <code>project.clj</code> を作成するか、完全な <a href="#Leiningen">Leiningen integration</a> を使うことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your/project <span class="string"><span class="delimiter">&quot;</span><span class="content">0.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:dependencies</span>
  [[thheller/shadow-cljs <span class="string"><span class="delimiter">&quot;</span><span class="content">X.Y.Z</span><span class="delimiter">&quot;</span></span>]]

  <span class="symbol">:source-paths</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>IntelliJが提供するターミナルの中で <code>npx shadow-cljs server</code> を実行し、 <code>Clojure REPL &#8594; Remote</code> Run Configuration を使って、提供された <a href="#nREPL">nREPL server</a> に接続することができます。Cursive Clojure REPL &#8594; Remoteで &#34;Use port from nREPL file &#34;オプションを選択するか、固定のnREPLポートを設定してください。</p>
</div>
<div class="paragraph">
<p>最初に接続されたときのCursive REPLは常にCLJ REPLとして始まることに注意してください。 <code>(shadow/repl :your-build-id)</code> を呼び出すことでCLJSに切り替えることができます。これによりCursiveオプションも自動的に切り替わります。CLJ REPLに戻るには <code>:cljs/quit</code> と入力してください。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
CLJ&#8594;CLJSからCursiveセレクトボックスを使って切り替えることはできません。必ず上記の呼び出しを使って切り替えてください。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cider"><a class="anchor" href="#cider"></a><a class="link" href="#cider">14.2. Emacs / CIDER</a></h3>
<div class="paragraph">
<p>このセクションは CIDER バージョン 0.20.0 以降向けに書かれています。お使いのEmacs環境にこのバージョンの <code>cider</code> パッケージ以降があることを確認してください。インストールの詳細については、 <a href="https://docs.cider.mx">CIDER documentation</a> を参照してください。</p>
</div>
<div class="sect3">
<h4 id="_launch_the_clojurescript_repl"><a class="anchor" href="#_launch_the_clojurescript_repl"></a><a class="link" href="#_launch_the_clojurescript_repl">14.2.1. ClojureScript REPLを起動します。</a></h4>
<div class="paragraph">
<p>nREPLとClojureScript REPLを起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">M-x cider-jack-in-cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>CIDERはClojureScript REPLの種類を尋ねてきます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">ClojureScriptのREPLタイプを選択します:</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow</code> と入力します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">shadow-cljs のビルドを選択します:</code></pre>
</div>
</div>
<div class="paragraph">
<p>ビルド対象の名前を入力してください(例: <code>app</code>):</p>
</div>
<div class="paragraph">
<p>Emacs はこれで、兄弟関係の <code>shadow-cljs</code> サーバへの新しい nREPL 接続を開き、ClojureScript の REPL 環境にブートストラップすることができるようになりました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">shadow.user&gt; To quit, type: :cljs/quit
[:selected :app]
cljs.repl&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、ClojureScriptのevalやvarsの定義へのジャンプ（<code>cider-find-var</code> で）などができるようになりました。</p>
</div>
<div class="paragraph">
<p>例えば、ブラウザにアラートを表示させたり。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">cljs.repl&gt; (js/alert &quot;Jurassic Park!&quot;)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simplify_startup_with_dir_local"><a class="anchor" href="#_simplify_startup_with_dir_local"></a><a class="link" href="#_simplify_startup_with_dir_local">14.2.2. dir-localで起動を簡素化</a></h4>
<div class="paragraph">
<p>プロジェクトのルートに <code>.dir-locals.el</code> ファイルを作成することで、起動の流れを簡単にすることができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">((<span class="predefined-constant">nil</span> <span class="keyword">.</span> ((cider-default-cljs-repl <span class="keyword">.</span> shadow)
         (cider-shadow-default-options <span class="keyword">.</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;your-build-name-here&gt;</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_proto_repl_atom"><a class="anchor" href="#_proto_repl_atom"></a><a class="link" href="#_proto_repl_atom">14.3. Proto REPL (Atom)</a></h3>
<div class="paragraph">
<p>Proto REPLはほとんどがClojure開発のためのものなので、ほとんどの機能はClojureScriptでは動作しません。しかし、単純な検証に使用することは可能です。</p>
</div>
<div class="paragraph">
<p>設定が必要なので</p>
</div>
<div class="paragraph">
<p>1) <code>:source-paths</code> の中に <code>user.clj</code> を作成する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"> (<span class="keyword">ns</span> <span class="namespace">user</span>)

 (<span class="keyword">defn</span> <span class="function">reset</span> [])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Proto REPLは接続時にこれを呼び出すので、このファイルは <code>user/reset</code> 関数を定義しなければなりません。もし <code>user/reset</code> が見つからなければ、<code>tools.namespace</code> を呼び出し、実行中の <code>shadow-cljs</code> サーバを破壊します。これは望ましくありません。ここで何かできるかもしれませんが、CLJSのために何もする必要はありません。</p>
</div>
<div class="paragraph">
<p>2) <a href="#user-config">~/.shadow-cljs/config.edn</a> または <code>shadow-cljs.edn</code> の <code>:dependencies</code> に <code>[proto-repl "0.3.1.1"]</code> を追加する。</p>
</div>
<div class="paragraph">
<p>3) 固定の <a href="#nREPL">nREPLポート</a> を設定します。</p>
</div>
<div class="paragraph">
<p>4) <code>shadow-cljs server</code> または <code>shadow-cljs watch your-build</code> を起動する。</p>
</div>
<div class="paragraph">
<p>5) Atomコマンド <code>Proto Repl: Remote Nrepl Connection</code> で <code>localhost</code> と設定したポートに接続します。</p>
</div>
<div class="paragraph">
<p>6) 4で <code>server</code> を使った場合 <code>(shadow.cljs.devtools.api/watch :your-build)</code> を評価します。</p>
</div>
<div class="paragraph">
<p>7) <code>(shadow.cljs.devtools.api/nrepl-select :your-build)</code> の評価を行います。REPL接続はCLJSモードになっているので、evalしたものはすべてJSでevalされることになります。Clojureモードに戻るには <code>:repl/quit</code> と入力してください。もし <code>[:no-worker :browser]</code> が出たら、まず <code>watch</code> を起動する必要があります。</p>
</div>
<div class="paragraph">
<p>8) CLJSを評価する前にクライアント（例えば <code>:browser</code> アプリを構築する際のブラウザ）を接続する必要があります。</p>
</div>
<div class="paragraph">
<p>9) JSを評価する、例えば <code>(js/alert "foo")</code>。 <code>There is no connected JS runtime</code> と表示されたらクライアントは正しく接続されていません。そうでなければブラウザにアラートが表示されるはずです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_chlorine_atom"><a class="anchor" href="#_chlorine_atom"></a><a class="link" href="#_chlorine_atom">14.4. Chlorine (Atom)</a></h3>
<div class="paragraph">
<p>ChlorineはAtomをSocket REPLに接続しますが名前空間をリフレッシュしようともします。そこでまずChlorineパッケージのconfigを開き、設定 <code>Should we use clojure.tools.namespace to refresh</code> が <code>simple</code> に設定されているかどうかを確認してください。</p>
</div>
<div class="paragraph">
<p>設定が正しいことを確認したら shadow app を起動します。(<code>app</code> をビルドしたものに置き換えてください)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs watch app</code></pre>
</div>
</div>
<div class="paragraph">
<p>あとは、アトムコマンド <code>Chlorine: Connect Clojure Socket Repl</code> を実行するだけです、これでClojureコードを評価するためのREPLが接続されます。次に <code>Chlorine: Connect Embeded</code> を実行すると、ClojureScriptのREPLも接続されます。</p>
</div>
<div class="paragraph">
<p>これで、<code>Chlorine: Evaluate…</code> コマンドを使って、任意のClojureやClojureScriptのREPLを評価できるようになりました。これは <code>.clj</code> ファイルを Clojure として、<code>cljc</code> ファイルを ClojureScript として評価します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_calva_vs_code"><a class="anchor" href="#_calva_vs_code"></a><a class="link" href="#_calva_vs_code">14.5. Calva (VS Code)</a></h3>
<div class="paragraph">
<p>(今のところ <code>browser</code> ターゲットでしかテストしていません。おそらく他のターゲットでも動作します)</p>
</div>
<div class="sect3">
<h4 id="_dependencies_2"><a class="anchor" href="#_dependencies_2"></a><a class="link" href="#_dependencies_2">14.5.1. 依存関係</a></h4>
<div class="paragraph">
<p>VS Codeと <a href="https://marketplace.visualstudio.com/items?itemName=betterthantomorrow.calva#overview">Calva</a> の拡張機能をインストールします。</p>
</div>
<div class="paragraph">
<p>Calva は nREPL と <code>cider-nrepl</code> ミドルウェアを使用しているので、この依存関係を <a href="#user-config">~/.shadow-cljs/config.edn</a> または <code>shadow-cljs.edn</code> に含める必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.21.0</span><span class="delimiter">&quot;</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> はこの依存関係を見つけると必要な <code>cider-nrepl</code> ミドルウェアを注入します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_calva_to_the_repls"><a class="anchor" href="#_connecting_calva_to_the_repls"></a><a class="link" href="#_connecting_calva_to_the_repls">14.5.2. Connecting Calva to the REPLs</a></h4>
<div class="paragraph">
<p>これが完了したら、シャドウアプリを起動します。(`app`の代わりに何でもいいからビルドしてください):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs watch app</code></pre>
</div>
</div>
<div class="paragraph">
<p>アプリがブラウザに読み込まれ、アプリを起動したターミナルに <code>JS runime connected</code> と表示されると、Calva はその repl に接続することができます。VS Codeでプロジェクトを開くとCalvaはデフォルトで自動接続を試み <code>shadow-cljs.edn</code> から読み込んだビルドのリストを表示します。正しいもの(この例では <code>:app</code>)を選択すると、CalvaのClojureとClojurescriptのサポートが有効になります。</p>
</div>
<div class="paragraph">
<p>(アプリを起動したときにすでに VS Code でプロジェクトを開いている場合は <code>Calva: Connect to a Running REPL Server in the Project</code> コマンドを実行してください)</p>
</div>
</div>
<div class="sect3">
<h4 id="_features"><a class="anchor" href="#_features"></a><a class="link" href="#_features">14.5.3. Features</a></h4>
<div class="paragraph">
<p>今できることのいくつか:</p>
</div>
<div class="sect4">
<h5 id="_intellisense_and_stuff"><a class="anchor" href="#_intellisense_and_stuff"></a><a class="link" href="#_intellisense_and_stuff">インテリセンスなど</a></h5>
<div class="ulist">
<ul>
<li>
<p>hoverで定義を覗く</p>
</li>
<li>
<p>自動補完の手助け</p>
</li>
<li>
<p>定義へ移動 (Macでは <code>cmd-click</code> 、WindowsやLinuxでは <code>ctrl-click</code>)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_evaluation_of_the_file_forms_and_selection"><a class="anchor" href="#_evaluation_of_the_file_forms_and_selection"></a><a class="link" href="#_evaluation_of_the_file_forms_and_selection">ファイルやフォーム、選択範囲の評価</a></h5>
<div class="ulist">
<ul>
<li>
<p>ファイルを評価する: <code>ctrl+alt+c enter</code> (これはファイルを開くときに自動で行います)</p>
</li>
<li>
<p>インラインで評価: <code>ctrl+alt+c e</code></p>
</li>
<li>
<p>エディタで評価して置き換える: <code>ctrl+alt+c r</code></p>
</li>
<li>
<p>評価結果をプリティプリント: <code>ctrl+alt+c p</code></p>
</li>
<li>
<p>評価のために統合されたreplにフォームを送る: <code>ctrl+alt+c alt+e</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_run_tests"><a class="anchor" href="#_run_tests"></a><a class="link" href="#_run_tests">Run tests</a></h5>
<div class="ulist">
<ul>
<li>
<p>名前空間テストの実行: <code>ctrl+alt+c t</code></p>
</li>
<li>
<p>全体テスト: <code>ctrl+alt+c shift+t</code> (大規模プロジェクトではとても不便です)</p>
</li>
<li>
<p>以前に失敗したテストの再実行: <code>ctrl+alt+c ctrl+t</code></p>
</li>
<li>
<p>テストの失敗は、エクスプローラとエディタでマークされ、問題タブに一覧表示されるので、簡単にアクセスできます</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_terminal_repls"><a class="anchor" href="#_terminal_repls"></a><a class="link" href="#_terminal_repls">Terminal repls</a></h5>
<div class="ulist">
<ul>
<li>
<p>ターミナルの名前空間を現在開いているファイルの名前空間に切り替える: <code>ctrl+alt+c n</code></p>
</li>
<li>
<p>現在のファイルをロードして名前空間を切り替える: <code>ctrl+alt+c alt+n</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_cljc_files"><a class="anchor" href="#_cljc_files"></a><a class="link" href="#_cljc_files">Cljc files</a></h5>
<div class="ulist">
<ul>
<li>
<p>Clojure と Clojurescript replの切り替え <code>ctrl+alt+c ctrl+alt+t</code> (またはステータスバーの緑の <code>cljc/clj</code> ボタンをクリック)。これは、どの repl がエディタを支持しているかと、どのターミナルの repl がアクセスされているかを決定します</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fireplace_vim_vim_neovim"><a class="anchor" href="#_fireplace_vim_vim_neovim"></a><a class="link" href="#_fireplace_vim_vim_neovim">14.6. Fireplace.vim (Vim/Neovim)</a></h3>
<div class="paragraph">
<p><a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> は <a href="https://nrepl.org/">nREPL</a> クライアントとして動作することでClojure REPLの統合を提供するVim/Neovimプラグインです。Shadow-CLJSと組み合わせるとClojureScriptのREPL統合も提供します。</p>
</div>
<div class="paragraph">
<p>このガイドでは公式 <a href="https://github.com/thheller/shadow-cljs#quick-start">Shadow-CLJS Quick Start</a> ガイドで作成されたアプリを例にしているため、アプリの <code>shadow-cljs.edn</code> の中のいくつかの設定項目を参照しています。つまり、これらの設定項目はかなり汎用的なものなので、ちょっとした修正で他のアプリにも適用できるはずです。</p>
</div>
<div class="sect3">
<h4 id="_dependencies_3"><a class="anchor" href="#_dependencies_3"></a><a class="link" href="#_dependencies_3">14.6.1. 依存関係</a></h4>
<div class="paragraph">
<p><a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> をVim/Neovimで好きな方法でプラグインをインストールします。</p>
</div>
<div class="paragraph">
<p><a href="https://nrepl.org/">nREPL</a> クライアントとして <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> は <a href="https://docs.cider.mx/cider-nrepl/">CIDER-nREPL</a> に依存しています（これは一般的なエディタに依存しないREPL操作を提供するnREPLミドルウェアです）ので、この依存関係を <a href="#user-config">~/. shadow-cljs/config.edn</a> または <code>shadow-cljs.edn</code> (次のサブセクションで示されているように) に含める必要があります。</p>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_the_app"><a class="anchor" href="#_preparing_the_app"></a><a class="link" href="#_preparing_the_app">14.6.2. Preparing the app</a></h4>
<div class="paragraph">
<p>公式 <a href="https://github.com/thheller/shadow-cljs#quick-start">Shadow-CLJS Quick Start</a> ガイドに従ってサンプルアプリを作成し、その <code>shadow-cljs.edn</code> を以下のように修正します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs configuration</span>
{<span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/dev</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/test</span><span class="delimiter">&quot;</span></span>]

 <span class="comment">;; 追加 - Fireplace.vimが必要とするCIDER-nREPLミドルウェア</span>
 <span class="symbol">:dependencies</span>
 [[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.22.4</span><span class="delimiter">&quot;</span></span>]]

 <span class="comment">;; ADD - Fireplace.vimが接続するREPLサーバのポート（例：3333）</span>
 <span class="symbol">:nrepl</span>
 {<span class="symbol">:port</span> <span class="integer">3333</span>}

 <span class="comment">;; 追加 - アプリを提供する開発時HTTPサーバーのポート（例：8080）</span>
 <span class="symbol">:dev-http</span>
 {<span class="integer">8080</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}

 <span class="symbol">:builds</span>
 {<span class="symbol">:frontend</span>  <span class="comment">; 注意 - これは以下の様々な場所で参照されているビルドIDです</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:init-fn</span> acme.frontend.app/init}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これが完了したらアプリを起動します（ <code>shadow-CLJS.edn</code> で指定されたShadow-CLJSのビルドIDである <code>frontend</code> に注意してください）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ npx shadow-cljs watch frontend</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> でブラウザでアプリを開きます。このステップがないと、Vim/Neovim 内から REPL サーバーに接続しようとすると <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> から以下のようなエラーメッセージが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">No application has connected to the REPL server.
Make sure your JS environment has loaded your compiled ClojureScript code.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_fireplace_vim_to_repl_server"><a class="anchor" href="#_connecting_fireplace_vim_to_repl_server"></a><a class="link" href="#_connecting_fireplace_vim_to_repl_server">14.6.3. Connecting Fireplace.vim to REPL Server</a></h4>
<div class="paragraph">
<p>Vim/NeovimでClojureScriptのソースファイルを開き、以下のコマンドを実行して <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> をREPLサーバに接続します（ <code>shadow-cljs.edn</code> で指定したREPLサーバのポート <code>3333</code> に注意してください）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:Connect</span> <span class="integer">3333</span>
=&gt;
Connected to nrepl<span class="symbol">://localhost</span><span class="error">:</span><span class="integer">3333</span><span class="keyword">/</span>
Scope connection to<span class="error">:</span> ~/code/clojurescript/acme-app (ENTER)</code></pre>
</div>
</div>
<div class="paragraph">
<p>これによりClojure (ClojureScript の代わりに) REPL セッションが作成されます。セッションにClojureScriptのサポートを追加するには、以下のコマンドを実行してください（ <code>shadow-CLJS.edn</code> で指定されたShadow-CLJSのビルドID <code>frontend</code> に注意してください）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:CljEval</span> (shadow/repl <span class="symbol">:frontend</span>)
=&gt;
To quit, <span class="keyword">type</span><span class="error">:</span> <span class="symbol">:cljs/quit</span>
[<span class="symbol">:selected</span> <span class="symbol">:frontend</span>]
Press ENTER <span class="keyword">or</span> <span class="keyword">type</span> command to continue</code></pre>
</div>
</div>
<div class="paragraph">
<p>これでREPLサーバに対して <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> コマンドを実行できるようになるはずです。実行可能なコマンドの完全なリストについては <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> のドキュメントを参照してください。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a><a class="link" href="#_troubleshooting">15. Troubleshooting</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="failed-to-load"><a class="anchor" href="#failed-to-load"></a><a class="link" href="#failed-to-load">15.1. Startup Errors</a></h3>
<div class="paragraph">
<p>Sometimes <code>shadow-cljs</code> can fail to start properly. The errors are often very confusing and hard to identify. Most commonly this is caused by a few dependency conflicts on some of the important dependencies. When using just <code>shadow-cljs.edn</code> to manage your <code>:dependencies</code> it will provide a few extra checks to protect against these kinds of errors but when using <code>deps.edn</code> or <code>project.clj</code> these protections cannot be done so these errors happen more often when using those tools.</p>
</div>
<div class="paragraph">
<p>Generally the important dependencies to watch out for are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.clojure/clojure</p>
</li>
<li>
<p>org.clojure/clojurescript</p>
</li>
<li>
<p>org.clojure/core.async</p>
</li>
<li>
<p>com.google.javascript/closure-compiler-unshaded</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each <code>shadow-cljs</code> version is only tested with one particular combination of versions and it is recommended to stick with that version set for best compatibility. It might work when using different versions but if you encounter any kind of weird issues consider fixing your dependency versions first.</p>
</div>
<div class="paragraph">
<p>You can find the required dependencies for each version on clojars:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://clojars.org/thheller/shadow-cljs" class="bare">https://clojars.org/thheller/shadow-cljs</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The way to diagnose these issues vary by tool, so please refer to the appropriate section for further info.</p>
</div>
<div class="paragraph">
<p>Generally if you want to be sure you can just declare the matching dependency versions directly together with your chosen <code>shadow-cljs</code> version but that means you must also update those versions whenever you upgrade <code>shadow-cljs</code>. Correctly identifying where unwanted dependencies may be more work but will make future upgrades easier.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will likely always be on the very latest version for all the listed dependencies above so if you need to stick with an older dependency you might need to stick with an older shadow-cljs version as well.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> is very often several versions ahead on the <code>com.google.javascript/closure-compiler-unshaded</code> version it uses, so if you are depending on the version <code>org.clojure/clojurescript</code> normally supplies that might cause issues. Make sure the <code>thheller/shadow-cljs</code> version is picked over the version preferred by <code>org.clojure/clojurescript</code>.</p>
</div>
<div class="paragraph">
<p>If you want to make your live easier just use <code>shadow-cljs.edn</code> to manage your dependencies if you can. It is much less likely to have these problems or will at least warn you directly.</p>
</div>
<div class="paragraph">
<p>If you have ensured that you are getting all the correct versions but things still go wrong please open a <a href="https://github.com/thheller/shadow-cljs/issues">Github Issue</a> with a full problem description including your full dependency list.</p>
</div>
<div class="sect3">
<h4 id="_deps_edn_tools_deps"><a class="anchor" href="#_deps_edn_tools_deps"></a><a class="link" href="#_deps_edn_tools_deps">15.1.1. deps.edn / tools.deps</a></h4>
<div class="paragraph">
<p>When using <code>deps.edn</code> to manage your dependencies via the <a href="#tools-deps">:deps</a> key in <code>shadow-cljs.edn</code> it is recommended to use the <code>clj</code> tool directly for further diagnosis. First you need to check which aliases you are applying via <code>shadow-cljs.edn</code>. So if you are setting <code>:deps {:aliases [:dev :cljs]}</code> you&#8217;ll need to specify these aliases when running further commands.</p>
</div>
<div class="paragraph">
<p>First of all you should ensure that all dependencies directly declared in <code>deps.edn</code> have the expected version. Sometimes transitive dependencies can cause the inclusion of problematic versions. You can list all dependencies via:</p>
</div>
<div class="listingblock">
<div class="title">Listing all active dependencies</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ clj -A:dev:cljs -Stree</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will list all the dependencies. Tracking this down is a bit manual but you&#8217;ll need to verify that you get the correct versions for the dependencies mentioned above.</p>
</div>
<div class="paragraph">
<p>Please refer to the official <a href="https://clojure.org/reference/deps_and_cli">tools.deps</a> documentation for further information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_project_clj_leiningen"><a class="anchor" href="#_project_clj_leiningen"></a><a class="link" href="#_project_clj_leiningen">15.1.2. project.clj / Leiningen</a></h4>
<div class="paragraph">
<p>When using <code>project.clj</code> to manage you dependencies you&#8217;ll need to specify your configured <code>:lein</code> profiles from <code>shadow-cljs.edn</code> when using <code>lein</code> directly to diagnose the problem. For example <code>:lein {:profiles "+cljs"}</code> would require <code>lein with-profiles +cljs</code> for every command.</p>
</div>
<div class="listingblock">
<div class="title">Example listing of deps</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span> no profile
$ lein deps <span class="symbol">:tree</span>

<span class="error">#</span> with profile
$ lein with-profiles +cljs deps <span class="symbol">:tree</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will usually list all the current conflicts at the top and provide suggestions with the dependency tree at the bottom. The suggestions aren&#8217;t always fully accurate so don&#8217;t get mislead and don&#8217;t add exclusions to the <code>thheller/shadow-cljs</code> artifact.</p>
</div>
<div class="paragraph">
<p>Please refer to the <a href="https://leiningen.org/">Leiningen</a> documentation for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repl-troubleshooting"><a class="anchor" href="#repl-troubleshooting"></a><a class="link" href="#repl-troubleshooting">15.2. REPL</a></h3>
<div class="paragraph">
<p>Getting a CLJS REPL working can sometimes be tricky and a lot can go wrong since all the moving parts can be quite complicated. This guide hopes to address the most common issues that people run into and how to fix them.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/shadow-cljs-repl.png" alt="shadow cljs repl">
</div>
</div>
<div class="sect3">
<h4 id="cljs-repl-anatomy"><a class="anchor" href="#cljs-repl-anatomy"></a><a class="link" href="#cljs-repl-anatomy">15.2.1. Anatomy of the CLJS REPL</a></h4>
<div class="paragraph">
<p>A REPL in Clojure does exactly what the name implies: Read one form, Eval it, Print the result, Loop to do it again.</p>
</div>
<div class="paragraph">
<p>In ClojureScript however things are a bit more complicated since compilation happens on the JVM but the results are eval&#8217;d in a JavaScript runtime. There are a couple more steps that need to be done due in order to "emulate" the plain REPL experience. Although things are implemented a bit differently in <code>shadow-cljs</code> over regular CLJS the basic principles remain the same.</p>
</div>
<div class="paragraph">
<p>First you&#8217;ll need a REPL client. This could just be the CLI (eg. <code>shadow-cljs cljs-repl app</code>) or your Editor connected via <code>nREPL</code>. The Client will always talk directly to the <code>shadow-cljs</code> server and it&#8217;ll handle the rest. From the Client side it still looks like a regular REPL but there are a few more steps happening in the background.</p>
</div>
<div class="paragraph">
<p>1) Read: It all starts with reading a singular CLJS form from a given InputStream. That is either a blocking read directly from <code>stdin</code> or read from a string in case of <code>nREPL</code>. A Stream of characters are turned into actual datastructures, <code>"(+ 1 2)"</code> (a string) becomes <code>(+ 1 2)</code> (a list).</p>
</div>
<div class="paragraph">
<p>2) Compile: That form is then compiled on the <code>shadow-cljs</code> JVM side and transformed to a set of instructions.</p>
</div>
<div class="paragraph">
<p>3) Transfer Out: Those instructions are transferred to a connected JavaScript runtime. This could be a Browser or a <code>node</code> process.</p>
</div>
<div class="paragraph">
<p>4) Eval: The connected runtime will take the received instructions and <code>eval</code> them.</p>
</div>
<div class="paragraph">
<p>5) Print: The <code>eval</code> result is printed as a String in the JS runtime.</p>
</div>
<div class="paragraph">
<p>6) Transfer Back: The printed result is transferred back to the <code>shadow-cljs</code> JVM side.</p>
</div>
<div class="paragraph">
<p>7) Reply: The JVM side will forward the received results back to initial caller and the result is printed to the proper OutputStream (or sent as a nREPL message).</p>
</div>
<div class="paragraph">
<p>8) Loop: Repeat from 1).</p>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_runtimes"><a class="anchor" href="#_javascript_runtimes"></a><a class="link" href="#_javascript_runtimes">15.2.2. JavaScript Runtimes</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> JVM side of things will require one running <code>watch</code> for a given build which will handle all the related REPL commands as well. It uses a dedicated thread and manages all the given events that can happen during development (eg. REPL input, changing files, etc).</p>
</div>
<div class="paragraph">
<p>The compiled JS code however must also be loaded by a JS runtime (eg. Browser or <code>node</code> process) and that JS runtime must connect back to the running <code>shadow-cljs</code> process. Most <code>:target</code> configurations will have the necessary code added by default and should just connect automatically. How that connect is happening is dependent on the runtime but usually it is using a WebSocket to connect to the running <code>shadow-cljs</code> <a href="#http">HTTP server</a>.</p>
</div>
<div class="paragraph">
<p>Once connected the REPL is ready to use. Note that reloading the JS runtime (eg. manual browser page reload) will wipe out all REPL state of the runtime but some of the compiler side state will remain until the <code>watch</code> is also restarted.</p>
</div>
<div class="paragraph">
<p>It is possible for more than one JS runtime to connect to the <code>watch</code> process. <code>shadow-cljs</code> by default picks the first JS runtime that connected as the <code>eval</code> target. If you open a given <code>:browser</code> build in multiple Browsers only the first one will be used to <code>eval</code> code. Or you could be opening a <code>:react-native</code> app in iOS and Android next to each other during development. Only one runtime can eval and if that disconnects the next one takes over based on the time it connected.</p>
</div>
</div>
<div class="sect3">
<h4 id="missing-js-runtime"><a class="anchor" href="#missing-js-runtime"></a><a class="link" href="#missing-js-runtime">15.2.3. Missing JS runtime</a></h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>No application has connected to the REPL server. Make sure your JS environment has loaded your compiled ClojureScript code.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This error message just means that no JS runtime (eg. Browser) has connected to the <code>shadow-cljs</code> server. Your REPL client has successfully connected to the <code>shadow-cljs</code> server but as explained above we still need a JS runtime to actually <code>eval</code> anything.</p>
</div>
<div class="paragraph">
<p>Regular <code>shadow-cljs</code> builds do not manage any JS runtime of their own so you are responsible for running them.</p>
</div>
<div class="sect4">
<h5 id="repl-trouble-browser"><a class="anchor" href="#repl-trouble-browser"></a><a class="link" href="#repl-trouble-browser">:target :browser</a></h5>
<div class="paragraph">
<p>For <a href="#target-browser"><code>:target :browser</code></a> builds the <code>watch</code> process will have compiled the given code to a configured <code>:output-dir</code> (defaults to <code>public/js</code>). The generated <code>.js</code> must be loaded in a browser. Once loaded the Browser Console should show a <code>WebSocket connected</code> message. If you are using any kind of custom HTTP servers or have over-eager firewalls blocking the connections you might need to set some additional configuration (eg. via <a href="#proxy-support">:devtools-url</a>). The goal is to be able to connect to the <a href="#http">primary HTTP server</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="repl-trouble-node"><a class="anchor" href="#repl-trouble-node"></a><a class="link" href="#repl-trouble-node">:target :node-script, :node-library</a></h5>
<div class="paragraph">
<p>These targets will have produced a <code>.js</code> file that are intended to run in a <code>node</code> process. Given the variety of options however you&#8217;ll need to run them yourself. For example a <code>:node-script</code> you&#8217;d run via <code>node the-script.js</code> and on startup it&#8217;ll try to connect to the <code>shadow-cljs</code> server. You should see a <code>WebSocket connected</code> message on startup. The output is designed to only run on the machine they were compiled on, don&#8217;t copy <code>watch</code> output to other machines.</p>
</div>
</div>
<div class="sect4">
<h5 id="repl-trouble-react-native"><a class="anchor" href="#repl-trouble-react-native"></a><a class="link" href="#repl-trouble-react-native">:target :react-native</a></h5>
<div class="paragraph">
<p>The generated <code>&lt;:output-dir&gt;/index.js</code> file needs to be added to your <code>react-native</code> app and then loaded on an actual device or emulator. On startup it will also attempt to connect to the <code>shadow-cljs</code> server. You can check the log output via <code>react-native log-android|log-ios</code> and should show a <code>WebSocket connected</code> message once the app is running. If you see a websocket related error on startup instead it may have failed to connect to the shadow-cljs process. This can happen when the IP detection picked an incorrect IP. You can check which IP was used via <code>shadow-cljs watch app --verbose</code> and override it via <code>shadow-cljs watch app --config-merge '{:local-ip "1.2.3.4"}'</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="publish"><a class="anchor" href="#publish"></a><a class="link" href="#publish">16. Publishing Libraries</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>ClojureScript libraries are published to <code>maven</code> repositories just like Clojure. Most commonly they are published to <a href="https://clojars.org/">Clojars</a> but all other standard maven repositories work too.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> itself does not have direct support for publishing but since ClojureScript libraries are just uncompiled source files published in a JAR (basically just a ZIP compressed file) any common tool that is able to publish to maven will work. (eg. <code>mvn</code>, <code>gradle</code>, <code>lein</code>, etc). No extra compilation or other steps are required to publish. The ClojureScript compiler and therefore shadow-cljs is not involved at all.</p>
</div>
<div class="sect2">
<h3 id="publish-lein"><a class="anchor" href="#publish-lein"></a><a class="link" href="#publish-lein">16.1. Leiningen</a></h3>
<div class="paragraph">
<p>There are a variety of options to publish libraries and I currently recommend <a href="https://leiningen.org/">Leiningen</a>. The setup is very straightforward and doesn&#8217;t require much configuration at all.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This does not mean that you have to use Leiningen during development of the library itself. It is recommended to just use Leiningen for publishing but use <code>shadow-cljs</code> normally otherwise. You&#8217;ll only need to copy the actual <code>:dependencies</code> definition once you publish. Remember to keep development related dependencies out though.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming you are already using the recommended project structure where all your primary sources are located in <code>src/main</code> you can publish with a very simple <code>project.clj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your.cool/library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:description</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Does cool stuff</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://the.inter.net/wherever</span><span class="delimiter">&quot;</span></span>

  <span class="comment">;; this is optional, add what you want or remove it</span>
  <span class="symbol">:license</span> {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Eclipse Public License</span><span class="delimiter">&quot;</span></span>
            <span class="symbol">:url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.eclipse.org/legal/epl-v10.html</span><span class="delimiter">&quot;</span></span>}

  <span class="symbol">:dependencies</span>
  <span class="comment">;; always use &quot;provided&quot; for Clojure(Script)</span>
  [[org.clojure/clojurescript <span class="string"><span class="delimiter">&quot;</span><span class="content">1.10.520</span><span class="delimiter">&quot;</span></span> <span class="symbol">:scope</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">provided</span><span class="delimiter">&quot;</span></span>]
   [some.other/library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>]

  <span class="symbol">:source-paths</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate the required <code>pom.xml</code> and put all sources from <code>src/main</code> into the published <code>.jar</code> file. All you need to run is <code>lein deploy clojars</code> to publish it. When doing this for the first time you&#8217;ll first need to setup proper authentication. Please refer to the official  <a href="https://github.com/technomancy/leiningen/blob/stable/doc/DEPLOY.md">Leiningen</a> and <a href="https://github.com/clojars/clojars-web/wiki/Tutorial">Clojars</a> documentation on how to set that up.</p>
</div>
<div class="sect3">
<h4 id="_disable_jar_signing"><a class="anchor" href="#_disable_jar_signing"></a><a class="link" href="#_disable_jar_signing">16.1.1. Disable JAR Signing</a></h4>
<div class="paragraph">
<p>Leiningen defaults to signing libraries via GPG before publishing which is a good default but given that this can be a hassle to setup and not many people are actually verifying the signatures you can disable that step via adding a simple <code>:repositories</code> config to the <code>project.clj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your.cool/library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:repositories</span>
  {<span class="string"><span class="delimiter">&quot;</span><span class="content">clojars</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://clojars.org/repo</span><span class="delimiter">&quot;</span></span>
              <span class="symbol">:sign-releases</span> <span class="predefined-constant">false</span>}}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_keep_your_jar_clean"><a class="anchor" href="#_keep_your_jar_clean"></a><a class="link" href="#_keep_your_jar_clean">16.1.2. Keep your JAR clean</a></h4>
<div class="paragraph">
<p>If you write tests or user other development related code for your library make sure to keep them in <code>src/dev</code> or <code>src/test</code> to avoid publishing them together with the library.</p>
</div>
<div class="paragraph">
<p>Also avoid generating output to <code>resources/*</code> since Leiningen and other tools may include those files into the <code>.jar</code> which may cause problems for downstream users. Your <code>.jar</code> should ONLY contains the actual source files, no compiled code at all.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You can and should verify that everything is clean by running <code>lein jar</code> and inspecting the files that end up in it via <code>jar -tvf target/library-1.0.0.jar</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="publish-deps-cljs"><a class="anchor" href="#publish-deps-cljs"></a><a class="link" href="#publish-deps-cljs">16.2. Declaring JS dependencies</a></h3>
<div class="paragraph">
<p>Please note that currently only <code>shadow-cljs</code> has a clean automatic interop story with <code>npm</code>. That may represent a problem for users of your libraries using other tools. You may want to consider providing a CLJSJS fallback and/or publishing extra documentation for <code>webpack</code> related workflows.</p>
</div>
<div class="paragraph">
<p>You can declare <code>npm</code> dependencies directly by including a <code>deps.cljs</code> with <code>:npm-deps</code> in your project (eg. <code>src/main/deps.cljs</code>).</p>
</div>
<div class="listingblock">
<div class="title">Example src/main/deps.cljs</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:npm-deps</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">the-thing</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also provide extra <code>:foreign-libs</code> definitions here. They won&#8217;t affect <code>shadow-cljs</code> but might help other tools.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_to_do_when_things_don_t_work"><a class="anchor" href="#_what_to_do_when_things_don_t_work"></a><a class="link" href="#_what_to_do_when_things_don_t_work">17. What to do when things don’t work?</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since the JS world is still evolving rapidly and not everyone is using the same way to write and distribute code there are some things <code>shadow-cljs</code> cannot work around automatically. These can usually be solved with custom <code>:resolve</code> configs, but there may also be bugs or oversights.</p>
</div>
<div class="paragraph">
<p>If you cannot resolve such an issue with the instructions in this chapter, then try asking on the <a href="https://clojurians.slack.com/messages/C6N245JGG"><code>#shadow-cljs</code> Slack channel</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hacking"><a class="anchor" href="#_hacking"></a><a class="link" href="#_hacking">18. Hacking</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_patching_libraries"><a class="anchor" href="#_patching_libraries"></a><a class="link" href="#_patching_libraries">18.1. Patching Libraries</a></h3>
<div class="paragraph">
<p>The <code>shadow-cljs</code> compiler ensures that things on your source paths are compiled first, overriding files from JARs. This means that you can copy a source file from a library, patch it, and include it in your own source directory.</p>
</div>
<div class="paragraph">
<p>これは、プロジェクトをクローンしてそのセットアップやビルドなどを理解しなくても、(たとえ <code>shadow-cljs</code> 自体であっても！)修正をテストアウトするのに便利な方法です。</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2020-10-12 17:12:56 JST
</div>
</div>
</body>
</html>